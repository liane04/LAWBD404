@model Marketplace.Models.Anuncio

@{
    ViewData["Title"] = "Criar Novo Anúncio";
}

<div class="container my-5 py-4">
    <!-- Progress Steps -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-10">
            <div class="create-anuncio-steps">
                <div class="step-item active" data-step="1">
                    <div class="step-circle">
                        <i class="bi bi-info-circle"></i>
                    </div>
                    <div class="step-label">Informações</div>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="2">
                    <div class="step-circle">
                        <i class="bi bi-car-front"></i>
                    </div>
                    <div class="step-label">Detalhes</div>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="3">
                    <div class="step-circle">
                        <i class="bi bi-images"></i>
                    </div>
                    <div class="step-label">Fotos</div>
                </div>
                <div class="step-line"></div>
                <div class="step-item" data-step="4">
                    <div class="step-circle">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="step-label">Revisão</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            <form id="createAnuncioForm" class="create-anuncio-form" asp-action="Create" asp-controller="Anuncios" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                        <!-- Step 1: Informação Principal -->
                        <div class="form-step active" data-step="1">
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header bg-primary text-white py-3">
                                    <h4 class="mb-0">
                                        <i class="bi bi-info-circle me-2"></i>Informação Principal
                                    </h4>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label asp-for="CategoriaId" class="form-label fw-semibold">
                                                <i class="bi bi-grid-3x3-gap text-primary me-2"></i>Categoria
                                                <span class="text-danger">*</span>
                                            </label>
                                            <select asp-for="CategoriaId" asp-items="@ViewBag.CategoriaId" class="form-select form-select-lg" required>
                                                <option value="">Selecione a categoria...</option>
                                            </select>
                                            <span asp-validation-for="CategoriaId" class="text-danger"></span>
                                            <div class="form-text">
                                                <i class="bi bi-info-circle me-1"></i>
                                                SUV, Sedan, Hatchback, Carrinha, etc.
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="titulo" class="form-label fw-semibold">
                                                <i class="bi bi-pencil text-primary me-2"></i>Título do Anúncio
                                                <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control form-control-lg" id="titulo" name="Titulo"
                                                   placeholder="Ex: BMW Série 3 320d Pack M" required>
                                            <div class="form-text">
                                                <i class="bi bi-lightbulb text-warning me-1"></i>
                                                Use um título claro e atrativo com marca, modelo e versão
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="preco" class="form-label fw-semibold">
                                                <i class="bi bi-currency-euro text-primary me-2"></i>Preço
                                                <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group input-group-lg">
                                                <span class="input-group-text">
                                                    <i class="bi bi-currency-euro"></i>
                                                </span>
                                                <input type="number" class="form-control" id="preco" name="Preco"
                                                       placeholder="28500" step="0.01" required>
                                            </div>
                                            <div class="form-text">Preço de venda do veículo</div>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="negociavel" class="form-label fw-semibold">
                                                <i class="bi bi-chat-dots text-primary me-2"></i>Negociável?
                                            </label>
                                            <select id="negociavel" class="form-select form-select-lg">
                                                <option value="sim">Sim, aceito propostas</option>
                                                <option value="nao">Não, preço fixo</option>
                                            </select>
                                        </div>

                                        <div class="col-12">
                                            <div class="alert alert-info border-0 d-flex align-items-start">
                                                <i class="bi bi-info-circle-fill me-3 fs-5 mt-1"></i>
                                                <div>
                                                    <h6 class="mb-2 fw-bold">Valor do Sinal para Reserva</h6>
                                                    <p class="mb-2 small">
                                                        Defina um valor de sinal (depósito) que os compradores interessados deverão pagar para reservar o veículo.
                                                        Este valor será descontado no preço final e garante o compromisso do comprador.
                                                    </p>
                                                    <div class="row g-2 align-items-end mt-3">
                                                        <div class="col-md-4">
                                                            <label for="valorSinal" class="form-label fw-semibold mb-1">
                                                                <i class="bi bi-bookmark-check text-primary me-1"></i>Valor do Sinal
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            <div class="input-group">
                                                                <span class="input-group-text">
                                                                    <i class="bi bi-currency-euro"></i>
                                                                </span>
                                                                <input type="number" class="form-control" id="valorSinal" name="ValorSinal"
                                                                       placeholder="500" min="100" max="5000" value="500" step="0.01" required>
                                                            </div>
                                                            <div class="form-text">Mínimo: 100€ | Máximo: 5.000€</div>
                                                        </div>
                                                        <div class="col-md-8">
                                                            <div class="d-flex gap-2 flex-wrap">
                                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setValorSinal(250)">250€</button>
                                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setValorSinal(500)">500€</button>
                                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setValorSinal(1000)">1.000€</button>
                                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setValorSinal(1500)">1.500€</button>
                                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="setValorSinal(2000)">2.000€</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <label for="descricao" class="form-label fw-semibold">
                                                <i class="bi bi-file-text text-primary me-2"></i>Descrição
                                                <span class="text-danger">*</span>
                                            </label>
                                            <textarea class="form-control" id="descricao" name="Descricao" rows="5" required
                                                placeholder="Descreva os pontos fortes do seu carro, estado geral, extras incluídos, histórico de manutenção, etc."></textarea>
                                            <div class="form-text">
                                                <span id="charCount">0</span>/500 caracteres
                                                <i class="bi bi-info-circle ms-2"></i>
                                                Uma boa descrição aumenta as suas hipóteses de venda
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Detalhes do Veículo -->
                        <div class="form-step" data-step="2">
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header bg-primary text-white py-3">
                                    <h4 class="mb-0">
                                        <i class="bi bi-car-front me-2"></i>Detalhes do Veículo
                                    </h4>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label asp-for="MarcaId" class="form-label fw-semibold">
                                                <i class="bi bi-award text-primary me-2"></i>Marca
                                                <span class="text-danger">*</span>
                                            </label>
                                            <select asp-for="MarcaId" asp-items="@ViewBag.MarcaId" id="marca" class="form-select form-select-lg" required>
                                                <option value="">Selecione a marca...</option>
                                            </select>
                                            <span asp-validation-for="MarcaId" class="text-danger"></span>
                                        </div>

                                        <div class="col-md-6">
                                            <label asp-for="ModeloId" class="form-label fw-semibold">
                                                <i class="bi bi-tag text-primary me-2"></i>Modelo
                                                <span class="text-danger">*</span>
                                            </label>
                                            <select asp-for="ModeloId" id="modelo" class="form-select form-select-lg" required disabled>
                                                <option value="">Selecione primeiro a marca...</option>
                                            </select>
                                            <span asp-validation-for="ModeloId" class="text-danger"></span>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="ano" class="form-label fw-semibold">
                                                <i class="bi bi-calendar-event text-primary me-2"></i>Ano de Registo
                                                <span class="text-danger">*</span>
                                            </label>
                                            <input type="number" class="form-control form-control-lg" id="ano" name="Ano"
                                                   placeholder="2019" min="1980" max="2025" required>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="kms" class="form-label fw-semibold">
                                                <i class="bi bi-speedometer2 text-primary me-2"></i>Quilómetros
                                                <span class="text-danger">*</span>
                                            </label>
                                            <input type="number" class="form-control form-control-lg" id="kms" name="Quilometragem"
                                                   placeholder="98000" required>
                                            <div class="form-text">Em quilómetros (km)</div>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="potencia" class="form-label fw-semibold">
                                                <i class="bi bi-lightning-charge text-primary me-2"></i>Potência (cv)
                                            </label>
                                            <input type="number" class="form-control form-control-lg" id="potencia" name="Potencia"
                                                   placeholder="190">
                                        </div>

                                        <div class="col-md-4">
                                            <label for="cilindrada" class="form-label fw-semibold">
                                                <i class="bi bi-speedometer text-primary me-2"></i>Cilindrada (cm³)
                                            </label>
                                            <input type="number" class="form-control form-control-lg" id="cilindrada" name="Cilindrada"
                                                   placeholder="1995">
                                            <div class="form-text">Em centímetros cúbicos</div>
                                        </div>

                                        <div class="col-md-6">
                                            <label asp-for="CombustivelId" class="form-label fw-semibold">
                                                <i class="bi bi-fuel-pump text-primary me-2"></i>Combustível
                                                <span class="text-danger">*</span>
                                            </label>
                                            <select asp-for="CombustivelId" asp-items="@ViewBag.CombustivelId" id="combustivel" class="form-select form-select-lg" required>
                                                <option value="">Selecione...</option>
                                            </select>
                                            <span asp-validation-for="CombustivelId" class="text-danger"></span>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="transmissao" class="form-label fw-semibold">
                                                <i class="bi bi-gear text-primary me-2"></i>Transmissão
                                                <span class="text-danger">*</span>
                                            </label>
                                            <select id="transmissao" name="Caixa" class="form-select form-select-lg" required>
                                                <option value="">Selecione...</option>
                                                <option value="Manual">Manual</option>
                                                <option value="Automática">Automática</option>
                                                <option value="Semi-automática">Semi-automática</option>
                                            </select>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="portas" class="form-label fw-semibold">
                                                <i class="bi bi-door-open text-primary me-2"></i>Número de Portas
                                            </label>
                                            <select id="portas" name="Portas" class="form-select form-select-lg">
                                                <option value="">Selecione...</option>
                                                <option value="2">2/3 portas</option>
                                                <option value="4">4/5 portas</option>
                                            </select>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="lugares" class="form-label fw-semibold">
                                                <i class="bi bi-people text-primary me-2"></i>Lugares
                                            </label>
                                            <input type="number" class="form-control form-control-lg" id="lugares" name="Lugares"
                                                   placeholder="5" min="2" max="9">
                                        </div>

                                        <div class="col-md-4">
                                            <label for="cor" class="form-label fw-semibold">
                                                <i class="bi bi-palette text-primary me-2"></i>Cor
                                            </label>
                                            <input type="text" class="form-control form-control-lg" id="cor" name="Cor"
                                                   placeholder="Ex: Preto">
                                        </div>

                                        <div class="col-md-6">
                                            <label for="localizacao" class="form-label fw-semibold">
                                                <i class="bi bi-geo-alt text-primary me-2"></i>Localização
                                                <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control form-control-lg" id="localizacao" name="Localizacao"
                                                   placeholder="Ex: Lisboa, Porto, Esposende..." required>
                                            <div class="form-text">Cidade ou região onde o veículo se encontra</div>
                                        </div>

                                        <div class="col-md-6">
                                            <label asp-for="TipoId" class="form-label fw-semibold">
                                                <i class="bi bi-bicycle text-primary me-2"></i>Tipo de Veículo
                                            </label>
                                            <select asp-for="TipoId" asp-items="@ViewBag.TipoId" id="tipoSelect" class="form-select form-select-lg" readonly>
                                                <option value="">Preenchido automaticamente...</option>
                                            </select>
                                            <span asp-validation-for="TipoId" class="text-danger"></span>
                                            <div class="form-text">
                                                <i class="bi bi-magic me-1 text-success"></i>
                                                Preenchido automaticamente (Carro, Mota, etc.)
                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label fw-semibold mb-3">
                                                <i class="bi bi-star text-primary me-2"></i>Extras e Equipamento
                                            </label>

                                            <!-- Segurança -->
                                            <div class="mb-4">
                                                <h6 class="text-primary mb-3">
                                                    <i class="bi bi-shield-check me-2"></i>Segurança
                                                </h6>
                                                <div class="extras-grid">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_abs" name="extras" value="ABS">
                                                        <label class="form-check-label" for="extra_abs">ABS</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_airbags" name="extras" value="Airbags">
                                                        <label class="form-check-label" for="extra_airbags">Airbags</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_estabilidade" name="extras" value="Controlo de Estabilidade">
                                                        <label class="form-check-label" for="extra_estabilidade">Controlo de Estabilidade</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_sensores" name="extras" value="Sensores Estacionamento">
                                                        <label class="form-check-label" for="extra_sensores">Sensores Estacionamento</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_camera" name="extras" value="Câmara Traseira">
                                                        <label class="form-check-label" for="extra_camera">Câmara Traseira</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Conforto -->
                                            <div class="mb-4">
                                                <h6 class="text-primary mb-3">
                                                    <i class="bi bi-lightning-charge me-2"></i>Conforto
                                                </h6>
                                                <div class="extras-grid">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_ac" name="extras" value="Ar Condicionado Automático">
                                                        <label class="form-check-label" for="extra_ac">Ar Condicionado Automático</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_bancos_pele" name="extras" value="Bancos em Pele/Alcântara">
                                                        <label class="form-check-label" for="extra_bancos_pele">Bancos em Pele/Alcântara</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_bancos_aquecidos" name="extras" value="Bancos Aquecidos">
                                                        <label class="form-check-label" for="extra_bancos_aquecidos">Bancos Aquecidos</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_volante" name="extras" value="Volante Multifunções">
                                                        <label class="form-check-label" for="extra_volante">Volante Multifunções</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_cruise" name="extras" value="Cruise Control">
                                                        <label class="form-check-label" for="extra_cruise">Cruise Control</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Multimédia -->
                                            <div class="mb-4">
                                                <h6 class="text-primary mb-3">
                                                    <i class="bi bi-phone me-2"></i>Multimédia
                                                </h6>
                                                <div class="extras-grid">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_gps" name="extras" value="Sistema Navegação GPS">
                                                        <label class="form-check-label" for="extra_gps">Sistema Navegação GPS</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_bluetooth" name="extras" value="Bluetooth">
                                                        <label class="form-check-label" for="extra_bluetooth">Bluetooth</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_ecra" name="extras" value="Ecrã Tátil">
                                                        <label class="form-check-label" for="extra_ecra">Ecrã Tátil</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_usb" name="extras" value="USB/AUX">
                                                        <label class="form-check-label" for="extra_usb">USB/AUX</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Outros -->
                                            <div class="mb-4">
                                                <h6 class="text-primary mb-3">
                                                    <i class="bi bi-tools me-2"></i>Outros
                                                </h6>
                                                <div class="extras-grid">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_jantes" name="extras" value="Jantes Liga Leve 18&quot;">
                                                        <label class="form-check-label" for="extra_jantes">Jantes Liga Leve</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_farois" name="extras" value="Faróis LED">
                                                        <label class="form-check-label" for="extra_farois">Faróis LED</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_pack" name="extras" value="Pack M Sport">
                                                        <label class="form-check-label" for="extra_pack">Pack Desportivo</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="extra_vidros" name="extras" value="Vidros Escurecidos">
                                                        <label class="form-check-label" for="extra_vidros">Vidros Escurecidos</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Outros Extras Personalizados -->
                                            <div class="mb-3">
                                                <label for="outrosExtras" class="form-label fw-semibold">
                                                    <i class="bi bi-pencil-square text-primary me-2"></i>Outros Extras (opcional)
                                                </label>
                                                <textarea class="form-control" id="outrosExtras" rows="3"
                                                    placeholder="Descreva outros extras que o seu veículo possui (ex: Teto panorâmico, bancos elétricos, sistema de som premium, etc.)"></textarea>
                                                <div class="form-text">
                                                    <i class="bi bi-info-circle me-1"></i>
                                                    Adicione extras adicionais que não estejam listados acima
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Fotografias -->
                        <div class="form-step" data-step="3">
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header bg-primary text-white py-3">
                                    <h4 class="mb-0">
                                        <i class="bi bi-images me-2"></i>Fotografias
                                    </h4>
                                </div>
                                <div class="card-body p-4">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Dica:</strong> Anúncios com mais fotos vendem 3x mais rápido!
                                        Tire fotos de todos os ângulos, interior, e detalhes importantes.
                                    </div>

                                    <div class="mb-4">
                                        <label for="imagens" class="form-label fw-semibold">
                                            <i class="bi bi-cloud-upload text-primary me-2"></i>Carregar Fotografias
                                            <span class="text-danger">*</span>
                                        </label>
                                        <div class="upload-zone" id="uploadZone">
                                            <input class="form-control d-none" type="file" id="imagens" name="imagens"
                                                   multiple accept="image/jpeg,image/png,image/webp">
                                            <div class="upload-placeholder">
                                                <i class="bi bi-cloud-arrow-up"></i>
                                                <h5>Arraste as fotos aqui</h5>
                                                <p>ou clique para selecionar</p>
                                                <button type="button" class="btn btn-primary mt-2"
                                                        onclick="document.getElementById('imagens').click()">
                                                    <i class="bi bi-folder2-open me-2"></i>Escolher Ficheiros
                                                </button>
                                            </div>
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-check-circle text-success me-1"></i>
                                            Formatos aceites: JPG, PNG, WebP. Tamanho máximo: 10MB por foto. Máximo: 20 fotos.
                                        </div>
                                    </div>

                                    <div id="imagePreview" class="image-preview-grid"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Revisão -->
                        <div class="form-step" data-step="4">
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header bg-success text-white py-3">
                                    <h4 class="mb-0">
                                        <i class="bi bi-check-circle me-2"></i>Revisão e Publicação
                                    </h4>
                                </div>
                                <div class="card-body p-4">
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle-fill me-2"></i>
                                        <strong>Quase lá!</strong> Reveja os dados do seu anúncio antes de publicar.
                                    </div>

                                    <div id="reviewContent" class="review-content">
                                        <!-- Conteúdo será preenchido dinamicamente -->
                                    </div>

                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="termsCheck" required>
                                        <label class="form-check-label" for="termsCheck">
                                            Aceito os <a href="#" target="_blank">Termos e Condições</a>
                                            e confirmo que as informações fornecidas são verdadeiras.
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Navegação -->
                        <div class="form-navigation mt-4">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary btn-lg px-5"
                                        id="prevBtn" onclick="changeStep(-1)">
                                    <i class="bi bi-arrow-left me-2"></i>Anterior
                                </button>
                                <button type="button" class="btn btn-primary btn-lg px-5"
                                        id="nextBtn" onclick="changeStep(1)">
                                    Seguinte<i class="bi bi-arrow-right ms-2"></i>
                                </button>
                                <button type="submit" class="btn btn-success btn-lg px-5 d-none"
                                        id="submitBtn">
                                    <i class="bi bi-check-circle me-2"></i>Publicar Anúncio
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentStep = 1;
        const totalSteps = 4;

        // Navegação entre steps
        function changeStep(direction) {
            const newStep = currentStep + direction;

            if (newStep < 1 || newStep > totalSteps) return;

            // Validar step atual antes de avançar
            if (direction > 0 && !validateCurrentStep()) {
                return;
            }

            // Esconder step atual
            document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.step-item[data-step="${currentStep}"]`).classList.remove('active');

            // Mostrar novo step
            currentStep = newStep;
            document.querySelector(`.form-step[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.step-item[data-step="${currentStep}"]`).classList.add('active');

            // Atualizar botões
            updateButtons();

            // Scroll para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Se for o último step, mostrar resumo
            if (currentStep === 4) {
                showReview();
            }
        }

        function validateCurrentStep() {
            const currentStepElement = document.querySelector(`.form-step[data-step="${currentStep}"]`);
            const inputs = currentStepElement.querySelectorAll('[required]');

            for (let input of inputs) {
                if (!input.value) {
                    input.focus();
                    input.classList.add('is-invalid');
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return false;
                }
                input.classList.remove('is-invalid');
            }
            return true;
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');

            prevBtn.style.display = currentStep === 1 ? 'none' : 'block';
            nextBtn.style.display = currentStep === totalSteps ? 'none' : 'block';
            submitBtn.classList.toggle('d-none', currentStep !== totalSteps);
        }

        function showReview() {
            const reviewContent = document.getElementById('reviewContent');
            const titulo = document.getElementById('titulo').value;
            const preco = document.getElementById('preco').value;
            const valorSinal = document.getElementById('valorSinal').value;
            const marca = document.getElementById('marca').value;
            const modelo = document.getElementById('modelo').value;
            const ano = document.getElementById('ano').value;
            const kms = document.getElementById('kms').value;

            reviewContent.innerHTML = `
                <div class="row g-3">
                    <div class="col-12">
                        <h5 class="fw-bold">${titulo}</h5>
                        <h3 class="text-primary">${preco}€</h3>
                        <p class="text-muted mb-0">
                            <i class="bi bi-bookmark-check text-primary me-1"></i>
                            Sinal para reserva: <strong class="text-primary">${valorSinal}€</strong>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <strong>Marca:</strong> ${marca}
                    </div>
                    <div class="col-md-6">
                        <strong>Modelo:</strong> ${modelo}
                    </div>
                    <div class="col-md-6">
                        <strong>Ano:</strong> ${ano}
                    </div>
                    <div class="col-md-6">
                        <strong>Quilómetros:</strong> ${kms} km
                    </div>
                </div>
            `;
        }

        // Função para definir rapidamente o valor do sinal
        function setValorSinal(valor) {
            document.getElementById('valorSinal').value = valor;
        }

        // Contador de caracteres
        const descricao = document.getElementById('descricao');
        const charCount = document.getElementById('charCount');

        descricao.addEventListener('input', function() {
            charCount.textContent = this.value.length;
        });

        // Upload de imagens
        const uploadZone = document.getElementById('uploadZone');
        const imageInput = document.getElementById('imagens');
        const imagePreview = document.getElementById('imagePreview');
        let selectedFiles = new DataTransfer();

        uploadZone.addEventListener('click', (e) => {
            if (e.target.closest('.btn-remove')) return; // Não abrir file picker se clicar em remover
            imageInput.click();
        });

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        imageInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(newFiles) {
            // Adicionar novos ficheiros ao DataTransfer
            for (let i = 0; i < newFiles.length && selectedFiles.files.length < 20; i++) {
                selectedFiles.items.add(newFiles[i]);
            }

            // Atualizar o input
            imageInput.files = selectedFiles.files;

            // Atualizar preview
            updatePreview();
        }

        function updatePreview() {
            imagePreview.innerHTML = '';

            const files = selectedFiles.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();

                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.dataset.index = i;
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="btn-remove" onclick="removeImage(${i})">
                            <i class="bi bi-x-circle-fill"></i>
                        </button>
                        ${i === 0 ? '<span class="badge bg-primary">Principal</span>' : ''}
                    `;
                    imagePreview.appendChild(div);
                };

                reader.readAsDataURL(file);
            }

            // Mostrar/ocultar zona de upload
            if (files.length > 0) {
                uploadZone.querySelector('.upload-placeholder').style.display = 'none';
            } else {
                uploadZone.querySelector('.upload-placeholder').style.display = 'block';
            }
        }

        window.removeImage = function(index) {
            // Criar novo DataTransfer sem o ficheiro removido
            const newDataTransfer = new DataTransfer();
            const files = Array.from(selectedFiles.files);

            files.forEach((file, i) => {
                if (i !== index) {
                    newDataTransfer.items.add(file);
                }
            });

            selectedFiles = newDataTransfer;
            imageInput.files = selectedFiles.files;
            updatePreview();
        };

        // Filtrar modelos por marca (cascading dropdown)
        const marcaSelect = document.querySelector('select[name="MarcaId"]');
        const modeloSelect = document.querySelector('select[name="ModeloId"]');
        const tipoSelect = document.querySelector('select[name="TipoId"]');

        if (marcaSelect && modeloSelect) {
            marcaSelect.addEventListener('change', async function() {
                const marcaId = this.value;

                // Limpar o select de modelos
                modeloSelect.innerHTML = '<option value="">Selecione o modelo...</option>';
                modeloSelect.disabled = !marcaId;

                // Limpar o tipo também
                if (tipoSelect) {
                    tipoSelect.value = '';
                }

                if (!marcaId) return;

                try {
                    const response = await fetch(`/Anuncios/GetModelosByMarca?marcaId=${marcaId}`);
                    if (response.ok) {
                        const modelos = await response.json();

                        modelos.forEach(modelo => {
                            const option = document.createElement('option');
                            option.value = modelo.id;
                            option.textContent = modelo.nome;
                            modeloSelect.appendChild(option);
                        });

                        // Animação visual
                        modeloSelect.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            modeloSelect.style.backgroundColor = '';
                        }, 500);
                    }
                } catch (error) {
                    console.error('Erro ao carregar modelos:', error);
                }
            });
        }

        // Auto-preencher Tipo de Veículo quando Modelo é selecionado
        if (modeloSelect && tipoSelect) {
            modeloSelect.addEventListener('change', async function() {
                const modeloId = this.value;

                if (!modeloId) {
                    tipoSelect.value = '';
                    return;
                }

                try {
                    const response = await fetch(`/Anuncios/GetModeloTipo?modeloId=${modeloId}`);
                    if (response.ok) {
                        const data = await response.json();
                        tipoSelect.value = data.tipoId;

                        // Animação visual de confirmação
                        tipoSelect.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            tipoSelect.style.backgroundColor = '';
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Erro ao obter tipo do modelo:', error);
                }
            });
        }

        // Inicializar
        updateButtons();
    </script>
}
