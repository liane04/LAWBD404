@model Marketplace.Models.Anuncio

@{
    ViewData["Title"] = Model.Titulo;
}

<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="bg-light border-bottom">
    <div class="container">
        <ol class="breadcrumb py-3 mb-0">
            <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door-fill me-1"></i>Início</a></li>
            <li class="breadcrumb-item"><a href="/Anuncios">Anúncios</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Titulo</li>
        </ol>
    </div>
</nav>

<!-- Mensagem de Sucesso -->
@if (TempData["Success"] != null)
{
    <div class="container mt-3">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>@TempData["Success"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
}
@if (TempData["CompraSucesso"] != null)
{
    <div class="container mt-3">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-bag-check-fill me-2"></i>
            <strong>@TempData["CompraSucesso"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
}
@if (TempData["CompraErro"] != null)
{
    <div class="container mt-3">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>@TempData["CompraErro"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
}

<div class="container my-5">
    <div class="row">
        <!-- Coluna Principal: Imagens e Detalhes -->
        <div class="col-lg-8">
            <!-- Título e Preço -->
            <div class="mb-4">
                <div class="d-flex align-items-start justify-content-between mb-3">
                    <div>
                        <h1 class="h2 mb-2">@Model.Titulo</h1>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="badge bg-success"><i class="bi bi-check-circle-fill me-1"></i>Verificado</span>
                            <span class="badge bg-primary"><i class="bi bi-star-fill me-1"></i>Destaque</span>
                            <span class="badge bg-info text-dark"><i class="bi bi-clock-fill me-1"></i>Publicado há 2 dias</span>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" title="Partilhar" data-bs-toggle="dropdown">
                            <i class="bi bi-share-fill"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-facebook me-2 text-primary"></i>Facebook</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-whatsapp me-2 text-success"></i>WhatsApp</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-envelope-fill me-2 text-danger"></i>Email</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-link-45deg me-2"></i>Copiar Link</a></li>
                        </ul>
                        <button class="btn btn-outline-danger" data-anuncio-id="@Model.Id" title="Adicionar aos Favoritos">
                            <i class="bi bi-heart"></i>
                        </button>
                    </div>
                </div>
                <div class="price-section p-3 bg-light rounded-3 border">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <p class="text-muted mb-1 small">Preço:</p>
                            <h2 class="text-primary fw-bold mb-0">@Model.Preco.ToString("N0") €</h2>
                        </div>
                        @if (Model.ValorSinal > 0)
                        {
                            <div class="text-end">
                                <p class="text-muted mb-1 small">Sinal para reserva:</p>
                                <p class="mb-0 fw-semibold text-success">@Model.ValorSinal.ToString("N0") €</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Galeria de Imagens (Carrossel) -->
            <div class="gallery-container mb-4">
                @if (Model.Imagens != null && Model.Imagens.Any())
                {
                    <div id="galleryCarousel" class="carousel slide shadow-lg rounded-3 overflow-hidden" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @for (int i = 0; i < Model.Imagens.Count; i++)
                            {
                                var imagem = Model.Imagens.ElementAt(i);
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@imagem.ImagemCaminho" class="d-block w-100 gallery-main-image" alt="@Model.Titulo - Imagem @(i + 1)" onclick="openFullscreen(@i)">
                                </div>
                            }
                        </div>
                        @if (Model.Imagens.Count > 1)
                        {
                            <button class="carousel-control-prev" type="button" data-bs-target="#galleryCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Anterior</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#galleryCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Seguinte</span>
                            </button>
                        }
                        <button class="btn btn-light btn-fullscreen" onclick="openFullscreen(0)">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                    </div>

                    <!-- Miniaturas -->
                    @if (Model.Imagens.Count > 1)
                    {
                        <div class="gallery-thumbnails mt-3">
                            @for (int i = 0; i < Math.Min(Model.Imagens.Count, 5); i++)
                            {
                                var imagem = Model.Imagens.ElementAt(i);
                                <div class="thumbnail-item @(i == 0 ? "active" : "")" onclick="goToSlide(@i)">
                                    <img src="@imagem.ImagemCaminho" alt="Miniatura @(i + 1)">
                                </div>
                            }
                            @if (Model.Imagens.Count > 5)
                            {
                                <div class="thumbnail-item view-all">
                                    <i class="bi bi-grid-3x3-gap-fill"></i>
                                    <span>Ver todas (@Model.Imagens.Count)</span>
                                </div>
                            }
                        </div>
                    }
                }
                else
                {
                    <div class="card shadow-lg rounded-3">
                        <img src="~/imagens/no-image.jpg" class="card-img-top" alt="Sem imagem disponível" style="height: 400px; object-fit: cover;">
                        <div class="card-body text-center">
                            <p class="text-muted mb-0"><i class="bi bi-image me-2"></i>Sem imagens disponíveis</p>
                        </div>
                    </div>
                }
            </div>

            <!-- Detalhes Rápidos -->
            <div class="card shadow-sm mb-4">
                <div class="card-body anuncio-details-grid-details-page">
                    <span><i class="bi bi-calendar3"></i> @Model.Ano</span>
                    <span><i class="bi bi-speedometer2"></i> @(Model.Quilometragem?.ToString("N0") ?? "N/A") km</span>
                    <span><i class="bi bi-fuel-pump-fill"></i> @Model.Combustivel?.Tipo</span>
                    <span><i class="bi bi-gear-fill"></i> @Model.Caixa</span>
                    @if (!string.IsNullOrEmpty(Model.Cor))
                    {
                        <span><i class="bi bi-palette-fill"></i> @Model.Cor</span>
                    }
                    <span><i class="bi bi-person-check-fill"></i> @Model.Vendedor?.Nome</span>
                </div>
            </div>


            <!-- Descrição -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-file-text-fill me-2"></i>Descrição</h4>
                </div>
                <div class="card-body">
                    <p class="mb-0">@(Model.Descricao ?? "Sem descrição disponível.")</p>
                </div>
            </div>

            <!-- Especificações Técnicas -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-gear-wide-connected me-2"></i>Especificações Técnicas</h4>
                </div>
                <div class="card-body p-0">
                    <div class="specifications-grid">
                        @if (Model.Marca != null)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-building"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Marca</span>
                                    <span class="spec-value">@Model.Marca.Nome</span>
                                </div>
                            </div>
                        }
                        @if (Model.Modelo != null)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-car-front"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Modelo</span>
                                    <span class="spec-value">@Model.Modelo.Nome</span>
                                </div>
                            </div>
                        }
                        @if (Model.Ano.HasValue)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-calendar3"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Ano</span>
                                    <span class="spec-value">@Model.Ano</span>
                                </div>
                            </div>
                        }
                        @if (Model.Quilometragem.HasValue)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-speedometer2"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Quilómetros</span>
                                    <span class="spec-value">@Model.Quilometragem.Value.ToString("N0") km</span>
                                </div>
                            </div>
                        }
                        @if (Model.Combustivel != null)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-fuel-pump-fill"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Combustível</span>
                                    <span class="spec-value">@Model.Combustivel.Tipo</span>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.Caixa))
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-gear-fill"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Caixa</span>
                                    <span class="spec-value">@Model.Caixa</span>
                                </div>
                            </div>
                        }
                        @if (Model.Tipo != null)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-car-front-fill"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Tipo de Veículo</span>
                                    <span class="spec-value">@Model.Tipo.Nome</span>
                                </div>
                            </div>
                        }
                        @if (Model.Categoria != null)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-tag-fill"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Categoria</span>
                                    <span class="spec-value">@Model.Categoria.Nome</span>
                                </div>
                            </div>
                        }
                        @if (Model.Potencia.HasValue)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-lightning-charge-fill"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Potência</span>
                                    <span class="spec-value">@Model.Potencia cv</span>
                                </div>
                            </div>
                        }
                        @if (Model.Cilindrada.HasValue)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-speedometer"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Cilindrada</span>
                                    <span class="spec-value">@Model.Cilindrada cm³</span>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.Cor))
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-palette-fill"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Cor</span>
                                    <span class="spec-value">@Model.Cor</span>
                                </div>
                            </div>
                        }
                        @if (Model.Portas.HasValue)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-door-closed-fill"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Portas</span>
                                    <span class="spec-value">@Model.Portas</span>
                                </div>
                            </div>
                        }
                        @if (Model.Lugares.HasValue)
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-people-fill"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Lugares</span>
                                    <span class="spec-value">@Model.Lugares</span>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.Localizacao))
                        {
                            <div class="spec-item">
                                <div class="spec-icon"><i class="bi bi-geo-alt"></i></div>
                                <div class="spec-content">
                                    <span class="spec-label">Localização</span>
                                    <span class="spec-value">@Model.Localizacao</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Extras e Equipamentos -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-star-fill me-2"></i>Extras e Equipamentos</h4>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="bi bi-shield-check me-2"></i>Segurança</h6>
                            <ul class="list-unstyled extras-list">
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>ABS</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Airbags (6)</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Controlo de Estabilidade</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Sensores Estacionamento</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Câmara Traseira</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="bi bi-lightning-charge me-2"></i>Conforto</h6>
                            <ul class="list-unstyled extras-list">
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Ar Condicionado Automático</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Bancos em Pele/Alcântara</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Bancos Aquecidos</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Volante Multifunções</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Cruise Control</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="bi bi-speaker me-2"></i>Multimédia</h6>
                            <ul class="list-unstyled extras-list">
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Sistema Navegação GPS</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Bluetooth</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Ecrã Tátil</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>USB/AUX</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3"><i class="bi bi-tools me-2"></i>Outros</h6>
                            <ul class="list-unstyled extras-list">
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Jantes Liga Leve 18"</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Faróis LED</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Pack M Sport</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i>Vidros Escurecidos</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Coluna Lateral: Vendedor e Contacto -->
        <div class="col-lg-4">
            <!-- Seller Card -->
            <div class="seller-card card shadow-sm sticky-top mb-4" style="top: 80px;">
                <div class="card-body text-center">
                    <div class="position-relative d-inline-block mb-3">
                        <img src="https://placehold.co/100x100/0d6efd/ffffff?text=@(Model.Vendedor?.Nome?.Substring(0, 1) ?? "V")" class="rounded-circle seller-avatar" alt="Foto do Vendedor">
                        <span class="badge-verified"><i class="bi bi-patch-check-fill"></i></span>
                    </div>
                    <h5 class="card-title mb-1">@(Model.Vendedor?.Nome ?? "Vendedor")</h5>
                    <p class="text-muted mb-2">
                        @if (!string.IsNullOrEmpty(Model.Vendedor?.Email))
                        {
                            <small><i class="bi bi-envelope me-1"></i>@Model.Vendedor.Email</small>
                        }
                        else
                        {
                            <span>Vendedor</span>
                        }
                    </p>

                    <!-- Rating -->
                    <div class="seller-rating mb-3">
                        <div class="stars mb-1">
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-half text-warning"></i>
                        </div>
                        <small class="text-muted">4.5 (avaliações em breve)</small>
                    </div>

                    <!-- Seller Stats -->
                    <div class="seller-stats mb-3">
                        <div class="row text-center g-2">
                            <div class="col-6">
                                <div class="stat-box p-2 bg-light rounded">
                                    <div class="stat-number text-primary fw-bold">
                                        <i class="bi bi-eye-fill"></i>
                                    </div>
                                    <div class="stat-label small text-muted">@Model.NVisualizacoes visualizações</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-box p-2 bg-light rounded">
                                    <div class="stat-number text-success fw-bold">
                                        <i class="bi bi-check-circle-fill"></i>
                                    </div>
                                    <div class="stat-label small text-muted">Verificado</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg">
                            <i class="bi bi-telephone-fill me-2"></i>Ver Telefone
                        </button>
                        <a href="@Url.Action("IniciarConversa", "Mensagens", new { anuncioId = Model.Id })" class="btn btn-outline-primary btn-lg">
                            <i class="bi bi-chat-dots-fill me-2"></i>Enviar Mensagem
                        </a>

                        <hr class="my-2">

                        @{
                            var userIdClaim = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                            int.TryParse(userIdClaim, out var loggedUserId);
                            var isProprioVendedor = Model.Vendedor?.IdentityUserId == loggedUserId;
                            var isComprador = User.IsInRole("Comprador");
                            // Availability is checked server-side in ReservasController
                        }

                        @* Botão de Reserva *@
                        @if (User.Identity.IsAuthenticated)
                        {
                            if (isProprioVendedor)
                            {
                                <button class="btn btn-success btn-lg" disabled title="Não pode reservar o seu próprio anúncio">
                                    <i class="bi bi-lock-fill me-2"></i>Reservar Veículo
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#reservarModal">
                                    <i class="bi bi-lock-fill me-2"></i>Reservar Veículo
                                </button>
                            }
                        }
                        else
                        {
                            <a href="@Url.Action("Login", "Utilizadores", new { returnUrl = Url.Action("Details", "Anuncios", new { id = Model.Id }) })" class="btn btn-success btn-lg">
                                <i class="bi bi-lock-fill me-2"></i>Reservar Veículo
                            </a>
                        }

        @if (User.Identity.IsAuthenticated)
        {
            if (isProprioVendedor)
            {
                <button class="btn btn-outline-secondary btn-lg" disabled title="Não pode agendar visita no seu próprio anúncio">
                    <i class="bi bi-calendar-check-fill me-2"></i>Agendar Visita
                </button>
            }
            else
            {
                <a href="@Url.Action("Create", "Visitas", new { anuncioId = Model.Id })" class="btn btn-info btn-lg text-white me-2">
                    <i class="bi bi-calendar-check-fill me-2"></i>Agendar Visita
                </a>
                <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#comprarModal">
                    <i class="bi bi-bag-check-fill me-2"></i>Comprar Agora
                </button>
            }
        }
                        }
                        else
                        {
                            <a href="@Url.Action("Login", "Utilizadores", new { returnUrl = Url.Action("Create", "Visitas", new { anuncioId = Model.Id }) })" class="btn btn-info btn-lg text-white">
                                <i class="bi bi-calendar-check-fill me-2"></i>Agendar Visita
                            </a>
                        }
                    </div>
                </div>
                <div class="card-footer text-center bg-light">
                    <a href="/Utilizadores/Perfil" class="text-primary text-decoration-none fw-semibold">
                        <i class="bi bi-grid-3x3-gap me-1"></i>Ver todos os anúncios
                    </a>
                </div>
            </div>

            <!-- Safety Tips Card -->
            <div class="card shadow-sm mb-4" style="position: relative; z-index: 10;">
                <div class="card-header bg-warning bg-opacity-10 border-warning">
                    <h6 class="mb-0 text-warning"><i class="bi bi-shield-exclamation me-2"></i>Dicas de Segurança</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled safety-tips mb-0 small">
                        <li class="mb-2"><i class="bi bi-check2 text-success me-2"></i>Inspeccione o veículo pessoalmente</li>
                        <li class="mb-2"><i class="bi bi-check2 text-success me-2"></i>Verifique a documentação</li>
                        <li class="mb-2"><i class="bi bi-check2 text-success me-2"></i>Não efetue pagamentos antecipados</li>
                        <li class="mb-0"><i class="bi bi-check2 text-success me-2"></i>Teste o carro antes de comprar</li>
                    </ul>
                </div>
            </div>

            <!-- Report Card -->
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <button class="btn btn-link text-danger text-decoration-none p-0">
                        <i class="bi bi-flag-fill me-1"></i>Denunciar este anúncio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Anúncios Relacionados -->
    <section class="related-listings-section mt-5 pt-4 border-top">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="bi bi-grid-3x3-gap-fill me-2"></i>Anúncios Semelhantes</h3>
                <a href="/Anuncios" class="btn btn-outline-primary">Ver mais</a>
            </div>
            <div class="row g-4">
                <!-- Related Card 1 -->
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm related-card">
                        <div class="card-img-wrapper-related">
                            <img src="~/imagens/audiA3.jpg" class="card-img-top" alt="Audi A3">
                            <button class="btn-favorito-small" onclick="toggleFavoritoDetails(this)">
                                <i class="bi bi-heart"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">Audi A3 Sportback 2.0 TDI</h6>
                            <p class="text-primary fw-bold fs-5 mb-2">22.900 €</p>
                            <div class="small text-muted mb-2">
                                <i class="bi bi-calendar3 me-1"></i>2018 • <i class="bi bi-speedometer2 me-1"></i>115.000 km
                            </div>
                            <div class="small text-muted">
                                <i class="bi bi-geo-alt-fill me-1"></i>Lisboa
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Related Card 2 -->
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm related-card">
                        <div class="card-img-wrapper-related">
                            <img src="~/imagens/mercedesBenz.jpg" class="card-img-top" alt="Mercedes">
                            <button class="btn-favorito-small" onclick="toggleFavoritoDetails(this)">
                                <i class="bi bi-heart"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">Mercedes-Benz Classe C 220d</h6>
                            <p class="text-primary fw-bold fs-5 mb-2">31.500 €</p>
                            <div class="small text-muted mb-2">
                                <i class="bi bi-calendar3 me-1"></i>2020 • <i class="bi bi-speedometer2 me-1"></i>75.000 km
                            </div>
                            <div class="small text-muted">
                                <i class="bi bi-geo-alt-fill me-1"></i>Porto
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Related Card 3 -->
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm related-card">
                        <div class="card-img-wrapper-related">
                            <img src="~/imagens/bmwSerie1.jpg" class="card-img-top" alt="BMW">
                            <button class="btn-favorito-small" onclick="toggleFavoritoDetails(this)">
                                <i class="bi bi-heart"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">BMW 320d Efficient Dynamics</h6>
                            <p class="text-primary fw-bold fs-5 mb-2">26.200 €</p>
                            <div class="small text-muted mb-2">
                                <i class="bi bi-calendar3 me-1"></i>2019 • <i class="bi bi-speedometer2 me-1"></i>92.000 km
                            </div>
                            <div class="small text-muted">
                                <i class="bi bi-geo-alt-fill me-1"></i>Coimbra
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Related Card 4 -->
                <div class="col-md-6 col-lg-3">
                    <div class="card h-100 shadow-sm related-card">
                        <div class="card-img-wrapper-related">
                            <img src="~/imagens/Jeep_mercedes.png" class="card-img-top" alt="Mercedes G-Class">
                            <button class="btn-favorito-small" onclick="toggleFavoritoDetails(this)">
                                <i class="bi bi-heart"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">Mercedes-Benz G 350d AMG</h6>
                            <p class="text-primary fw-bold fs-5 mb-2">89.900 €</p>
                            <div class="small text-muted mb-2">
                                <i class="bi bi-calendar3 me-1"></i>2020 • <i class="bi bi-speedometer2 me-1"></i>65.000 km
                            </div>
                            <div class="small text-muted">
                                <i class="bi bi-geo-alt-fill me-1"></i>Lisboa
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Modal: Reservar Veículo -->
<div class="modal fade" id="reservarModal" tabindex="-1" aria-labelledby="reservarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success bg-opacity-10 border-success">
                <h5 class="modal-title fw-bold text-success" id="reservarModalLabel">
                    <i class="bi bi-bookmark-check-fill me-2"></i>Reservar Veículo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Informações do Veículo -->
                <div class="alert alert-info border-info d-flex align-items-start mb-4">
                    <i class="bi bi-info-circle-fill me-3 fs-4 flex-shrink-0"></i>
                    <div>
                        <h6 class="alert-heading fw-bold mb-2">Como funciona a reserva?</h6>
                        <p class="mb-2 small">
                            Ao reservar este veículo, você garante a prioridade na compra por <strong>48 horas</strong>.
                            Durante este período, o anúncio ficará marcado como "Reservado" e outros compradores não poderão reservá-lo.
                        </p>
                        <p class="mb-0 small">
                            <strong>Sinal:</strong> Para garantir a reserva, é necessário efetuar um pagamento de <strong class="text-primary">@(Model.ValorSinal > 0 ? Model.ValorSinal.ToString("N0") + "€" : "a definir pelo vendedor")</strong>.
                            Este valor será descontado no preço final do veículo. Em caso de desistência da compra, o sinal não é reembolsável.
                        </p>
                    </div>
                </div>

                <!-- Resumo do Veículo -->
                <div class="card bg-light border-0 mb-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-car-front-fill text-primary me-2"></i>Veículo a Reservar
                        </h6>
                        <div class="row g-3">
                            <div class="col-auto">
                                @{
                                    var primeiraImagemModal = Model.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/no-image.jpg";
                                }
                                <img src="@primeiraImagemModal" alt="@Model.Titulo" class="rounded" style="width: 100px; height: 75px; object-fit: cover;">
                            </div>
                            <div class="col">
                                <h5 class="mb-1">@Model.Titulo</h5>
                                <p class="text-muted mb-1 small">
                                    @Model.Ano •
                                    @(Model.Quilometragem?.ToString("N0") ?? "N/A") km •
                                    @Model.Combustivel?.Tipo •
                                    @Model.Caixa
                                </p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div>
                                        <p class="text-muted mb-0 small">Preço Total:</p>
                                        <p class="text-success fw-bold fs-5 mb-0">@Model.Preco.ToString("N0") €</p>
                                    </div>
                                    @if (Model.ValorSinal > 0)
                                    {
                                        <div class="text-end">
                                            <p class="text-muted mb-0 small">Sinal a Pagar:</p>
                                            <p class="text-primary fw-bold fs-5 mb-0">@Model.ValorSinal.ToString("N0") €</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulário de Reserva -->
                <form id="formReserva" asp-controller="Reservas" asp-action="CreateCheckoutSession" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="anuncioId" value="@Model.Id" />

                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Nota:</strong> Ao clicar em "Confirmar Reserva", será redirecionado para a página de pagamento seguro do Stripe para processar o sinal de <strong>@(Model.ValorSinal > 0 ? Model.ValorSinal.ToString("N0") + "€" : "a definir")</strong>.
                    </div>

                    <!-- Termos e Condições -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="reservaTermos" required>
                        <label class="form-check-label small" for="reservaTermos">
                            Li e concordo com os <a href="/Home/TermosCondicoes" target="_blank" class="text-primary">termos e condições de reserva</a>
                        </label>
                    </div>

                    <!-- Timeline da Reserva -->
                    <div class="alert alert-light border mb-0">
                        <h6 class="fw-bold mb-3">O que acontece a seguir?</h6>
                        <div class="d-flex mb-2">
                            <div class="flex-shrink-0 me-3">
                                <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                    <i class="bi bi-1-circle-fill"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 small fw-semibold">Confirmação Imediata</h6>
                                <p class="mb-0 small text-muted">Receberá um email de confirmação com os detalhes da reserva</p>
                            </div>
                        </div>
                        <div class="d-flex mb-2">
                            <div class="flex-shrink-0 me-3">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                    <i class="bi bi-2-circle-fill"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 small fw-semibold">Contacto do Vendedor</h6>
                                <p class="mb-0 small text-muted">O vendedor irá contactá-lo para agendar uma visita</p>
                            </div>
                        </div>
                        <div class="d-flex">
                            <div class="flex-shrink-0 me-3">
                                <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                    <i class="bi bi-3-circle-fill"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 small fw-semibold">Prioridade Garantida</h6>
                                <p class="mb-0 small text-muted">Tem 48h para decidir sobre a compra com prioridade exclusiva</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="submit" form="formReserva" class="btn btn-success" id="btnConfirmarReserva">
                    <i class="bi bi-credit-card me-2"></i>Pagar Sinal com Stripe
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Agendar Visita -->
<div class="modal fade" id="agendarVisitaModal" tabindex="-1" aria-labelledby="agendarVisitaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info bg-opacity-10 border-info">
                <h5 class="modal-title fw-bold text-info" id="agendarVisitaModalLabel">
                    <i class="bi bi-calendar-check-fill me-2"></i>Agendar Visita
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Informações -->
                <div class="alert alert-info border-info d-flex align-items-start mb-4">
                    <i class="bi bi-info-circle-fill me-3 fs-4 flex-shrink-0"></i>
                    <div>
                        <h6 class="alert-heading fw-bold mb-2">Agende uma visita presencial</h6>
                        <p class="mb-2 small">
                            Marque uma data e hora para ver o veículo pessoalmente. O vendedor irá confirmar a disponibilidade e enviará os detalhes do local.
                        </p>
                        <p class="mb-0 small">
                            <strong>Dica:</strong> Aproveite a visita para fazer um test-drive e verificar toda a documentação do veículo.
                        </p>
                    </div>
                </div>

                <!-- Resumo do Veículo -->
                <div class="card bg-light border-0 mb-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-car-front-fill text-primary me-2"></i>Veículo
                        </h6>
                        <div class="row g-3">
                            <div class="col-auto">
                                <img src="@primeiraImagemModal" alt="@Model.Titulo" class="rounded" style="width: 100px; height: 75px; object-fit: cover;">
                            </div>
                            <div class="col">
                                <h5 class="mb-1">@Model.Titulo</h5>
                                <p class="text-muted mb-1 small">
                                    @Model.Ano •
                                    @(Model.Quilometragem?.ToString("N0") ?? "N/A") km •
                                    @Model.Combustivel?.Tipo •
                                    @Model.Caixa
                                </p>
                                <p class="text-success fw-bold fs-5 mb-0">@Model.Preco.ToString("N0") €</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações do Vendedor -->
                <div class="card bg-light border-0 mb-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-person-badge text-primary me-2"></i>Vendedor
                        </h6>
                        <div class="d-flex align-items-center">
                            <img src="https://placehold.co/60x60/0d6efd/ffffff?text=@(Model.Vendedor?.Nome?.Substring(0, 1) ?? "V")" class="rounded-circle me-3" alt="@(Model.Vendedor?.Nome ?? "Vendedor")">
                            <div>
                                <h6 class="mb-1">@(Model.Vendedor?.Nome ?? "Vendedor")</h6>
                                <p class="text-muted mb-0 small">
                                    <i class="bi bi-star-fill text-warning me-1"></i>4.5 (avaliações em breve)
                                    @if (!string.IsNullOrEmpty(Model.Localizacao))
                                    {
                                        <span> • <i class="bi bi-geo-alt-fill text-primary me-1"></i>@Model.Localizacao</span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulário de Agendamento -->
                <form id="formAgendarVisita">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-calendar2-week text-primary me-2"></i>Data e Hora Preferencial
                    </h6>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="visitaData" class="form-label">Data da Visita <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="visitaData" required>
                            <div class="form-text">Escolha uma data nos próximos 14 dias</div>
                        </div>
                        <div class="col-md-6">
                            <label for="visitaHora" class="form-label">Hora Preferencial <span class="text-danger">*</span></label>
                            <select class="form-select" id="visitaHora" required>
                                <option value="">Selecione...</option>
                                <option value="09:00">09:00</option>
                                <option value="10:00">10:00</option>
                                <option value="11:00">11:00</option>
                                <option value="12:00">12:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                            </select>
                            <div class="form-text">O vendedor irá confirmar a disponibilidade</div>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-person-fill text-primary me-2"></i>Seus Dados
                    </h6>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="visitaNome" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="visitaNome" value="João Duarte Silva" required>
                        </div>
                        <div class="col-md-6">
                            <label for="visitaEmail" class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="visitaEmail" value="joao.silva@exemplo.com" required>
                        </div>
                        <div class="col-md-6">
                            <label for="visitaTelefone" class="form-label">Telefone <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="visitaTelefone" value="+351 912 345 678" required>
                        </div>
                        <div class="col-md-6">
                            <label for="visitaNumPessoas" class="form-label">Número de Acompanhantes</label>
                            <select class="form-select" id="visitaNumPessoas">
                                <option value="0" selected>Apenas eu</option>
                                <option value="1">1 acompanhante</option>
                                <option value="2">2 acompanhantes</option>
                                <option value="3">3+ acompanhantes</option>
                            </select>
                        </div>
                    </div>

                    <!-- Interesses Específicos -->
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-list-check text-primary me-2"></i>Interesses Durante a Visita (Opcional)
                    </h6>
                    <div class="row g-2 mb-4">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="checkTestDrive" checked>
                                <label class="form-check-label" for="checkTestDrive">
                                    <i class="bi bi-speedometer2 me-1"></i>Test Drive
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="checkDocumentacao" checked>
                                <label class="form-check-label" for="checkDocumentacao">
                                    <i class="bi bi-file-earmark-text me-1"></i>Verificar Documentação
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="checkInspecao">
                                <label class="form-check-label" for="checkInspecao">
                                    <i class="bi bi-tools me-1"></i>Inspeção Mecânica
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="checkFinanciamento">
                                <label class="form-check-label" for="checkFinanciamento">
                                    <i class="bi bi-cash-coin me-1"></i>Discutir Financiamento
                                </label>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-chat-text text-primary me-2"></i>Observações (Opcional)
                    </h6>
                    <div class="mb-4">
                        <textarea class="form-control" id="visitaObservacoes" rows="3" placeholder="Questões específicas, aspetos que gostaria de ver, ou outras observações..."></textarea>
                    </div>

                    <!-- Confirmação -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="visitaConfirmacao" required>
                        <label class="form-check-label small" for="visitaConfirmacao">
                            Compreendo que esta visita está sujeita à confirmação do vendedor
                        </label>
                    </div>

                    <!-- Info Adicional -->
                    <div class="alert alert-light border mb-0">
                        <h6 class="fw-bold mb-2 small">
                            <i class="bi bi-shield-check me-1"></i>Dicas de Segurança para a Visita
                        </h6>
                        <ul class="mb-0 small text-muted">
                            <li>Marque a visita num local público e durante o dia</li>
                            <li>Leve um acompanhante, se possível</li>
                            <li>Verifique toda a documentação do veículo</li>
                            <li>Não efetue pagamentos durante a visita</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-info text-white" id="btnConfirmarVisita">
                    <i class="bi bi-calendar-check-fill me-2"></i>Confirmar Agendamento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Gallery Thumbnails Navigation
    function goToSlide(index) {
        const carousel = document.querySelector('#galleryCarousel');
        const bsCarousel = bootstrap.Carousel.getInstance(carousel) || new bootstrap.Carousel(carousel);
        bsCarousel.to(index);

        // Update active thumbnail
        document.querySelectorAll('.thumbnail-item').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
        });
    }

    // Update active thumbnail when carousel slides
    document.querySelector('#galleryCarousel').addEventListener('slid.bs.carousel', function (e) {
        const activeIndex = Array.from(e.target.querySelectorAll('.carousel-item')).indexOf(e.relatedTarget);
        document.querySelectorAll('.thumbnail-item').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === activeIndex);
        });
    });

    // Fullscreen Gallery (placeholder - would need modal implementation)
    function openFullscreen(index) {
        alert('Funcionalidade de galeria em ecrã completo - imagem ' + (index + 1));
        // In production, this would open a modal with larger images
    }

    // JavaScript para modais
    document.addEventListener('DOMContentLoaded', function () {
        const btnConfirmarVisita = document.getElementById('btnConfirmarVisita');
        const agendarVisitaModal = document.getElementById('agendarVisitaModal');

        // Confirmar Visita
        if (btnConfirmarVisita) {
            btnConfirmarVisita.addEventListener('click', function () {
                // Validação básica do formulário
                const visitaData = document.getElementById('visitaData').value;
                const visitaHora = document.getElementById('visitaHora').value;
                const visitaConfirmacao = document.getElementById('visitaConfirmacao');

                if (!visitaData || !visitaHora) {
                    alert('Por favor, preencha a data e hora para a visita.');
                    return;
                }

                if (!visitaConfirmacao.checked) {
                    alert('Por favor, confirme que compreende que a visita está sujeita à confirmação do vendedor.');
                    return;
                }

                // Simular sucesso
                const modalInstance = bootstrap.Modal.getInstance(agendarVisitaModal);
                modalInstance.hide();

                // Mostrar mensagem de sucesso
                setTimeout(() => {
                    const dataFormatada = new Date(visitaData).toLocaleDateString('pt-PT', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    mostrarMensagemSucesso(
                        'Visita Agendada!',
                        `O seu pedido de visita para ${dataFormatada} às ${visitaHora} foi enviado. O vendedor irá confirmar a disponibilidade em breve.`
                    );
                }, 300);
            });
        }

        // Função auxiliar para mostrar mensagens de sucesso
        function mostrarMensagemSucesso(titulo, mensagem) {
            // Criar elemento de alerta
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '400px';
            alertDiv.style.maxWidth = '600px';
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill me-3 fs-3"></i>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading fw-bold mb-1">${titulo}</h6>
                        <p class="mb-0 small">${mensagem}</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            document.body.appendChild(alertDiv);

            // Remover automaticamente após 8 segundos
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 8000);
        }
    });
</script>

<script src="~/js/favoritos.js" asp-append-version="true"></script>
