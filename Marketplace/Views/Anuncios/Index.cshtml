@model IEnumerable<Marketplace.Models.Anuncio>

@{
    ViewData["Title"] = "Comprar Carros";
    var marcas = ViewBag.Marcas as List<Marketplace.Models.Marca> ?? new List<Marketplace.Models.Marca>();
    var modelos = ViewBag.Modelos as List<Marketplace.Models.Modelo> ?? new List<Marketplace.Models.Modelo>();
    var tipos = ViewBag.Tipos as List<Marketplace.Models.Tipo> ?? new List<Marketplace.Models.Tipo>();
    var categorias = ViewBag.Categorias as List<Marketplace.Models.Categoria> ?? new List<Marketplace.Models.Categoria>();
    var combustiveis = ViewBag.Combustiveis as List<Marketplace.Models.Combustivel> ?? new List<Marketplace.Models.Combustivel>();
    var savedFilters = ViewBag.SavedFilters as List<Marketplace.Models.FiltrosFav>;
}

<!-- Hero Section com título -->
<section class="page-header-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-header-title mb-2">
                    <i class="bi bi-car-front-fill me-3"></i>Explorar Veículos
                </h1>
                <p class="page-header-subtitle text-muted mb-0">
                    Encontre o carro perfeito para si entre milhares de anúncios
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <button class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#mobileFilters">
                    <i class="bi bi-funnel me-2"></i>Filtros
                </button>
            </div>
        </div>
    </div>
</section>

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- Coluna de Filtros -->
        <div class="col-lg-3" id="filtersColumn">
            <div class="filters-sidebar" id="mobileFilters">
                @if (savedFilters != null && savedFilters.Any())
                {
                    <div class="saved-searches-section mb-4 pb-3 border-bottom">
                        <label class="form-label text-primary fw-bold mb-2">
                            <i class="bi bi-star-fill me-2"></i>Pesquisas Favoritas
                        </label>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary w-100 dropdown-toggle d-flex justify-content-between align-items-center" type="button" id="dropdownSavedFilters" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="text-truncate">Selecione uma pesquisa...</span>
                            </button>
                            <ul class="dropdown-menu w-100 shadow" aria-labelledby="dropdownSavedFilters">
                                @foreach (var filtro in savedFilters)
                                {
                                    <li class="d-flex justify-content-between align-items-center pe-2 border-bottom">
                                        <a class="dropdown-item text-truncate flex-grow-1 py-2"
                                           href="@Url.Action("Index", "Anuncios", new {
                                           marcaId = filtro.MarcaId,
                                           modeloId = filtro.ModeloId,
                                           tipoId = filtro.TipoId,
                                           categoriaId = filtro.CategoriaId,
                                           combustivelId = filtro.CombustivelId,
                                           precoMax = filtro.PrecoMax,
                                           anoMin = filtro.AnoMin,
                                           anoMax = filtro.AnoMax,
                                           kmMax = filtro.KmMax,
                                           caixa = filtro.Caixa,
                                           localizacao = filtro.Localizacao
                                       })">
                                            @filtro.Nome
                                        </a>
                                        <form asp-action="DeleteFiltro" asp-route-id="@filtro.Id" method="post" class="ms-1" onsubmit="return confirm('Apagar esta pesquisa guardada?');">
                                            <button type="submit" class="btn btn-sm btn-link text-danger p-0 px-2" title="Apagar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                }

                <div class="filters-header">
                    <h5 class="mb-0">
                        <i class="bi bi-sliders me-2"></i>Filtros de Pesquisa
                    </h5>
                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="resetFilters()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Limpar
                    </button>
                </div>

                <form id="filtrosForm" method="get" asp-action="Index">
                    <!-- Filtro de Marca -->
                    <div class="filter-group">
                        <label for="marcaId" class="filter-label">
                            <i class="bi bi-bookmark-fill me-2"></i>Marca
                        </label>
                        <select name="marcaId" id="marcaId" class="form-select">
                            <option value="">Todas as Marcas</option>
                            @foreach (var marca in marcas)
                            {
                                <option value="@marca.Id" selected="@(ViewBag.MarcaIdSelecionada == marca.Id)">
                                    @marca.Nome
                                </option>
                            }
                        </select>
                    </div>

                    <!-- Filtro de Modelo -->
                    <div class="filter-group">
                        <label for="modeloId" class="filter-label">
                            <i class="bi bi-tags-fill me-2"></i>Modelo
                        </label>
                        <select name="modeloId" id="modeloId" class="form-select">
                            <option value="">Todos os Modelos</option>
                            @foreach (var modelo in modelos)
                            {
                                <option value="@modelo.Id" selected="@(ViewBag.ModeloIdSelecionado == modelo.Id)">
                                    @modelo.Nome
                                </option>
                            }
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="preco" class="filter-label">
                            <i class="bi bi-currency-euro me-2"></i>Preço Máximo
                        </label>
                        <div class="price-range-container">
                            <input type="range" class="form-range" name="precoMax" min="0" max="100000" step="1000" id="preco" value="@(ViewBag.PrecoMax ?? 100000)" oninput="updatePriceLabel(this.value)">
                            <div class="d-flex justify-content-between mt-2">
                                <span class="text-muted small">0 €</span>
                                <span class="price-value fw-bold text-primary" id="precoValue">@(ViewBag.PrecoMax != null && (decimal)ViewBag.PrecoMax < 100000 ? ((decimal)ViewBag.PrecoMax).ToString("N0") + " €" : "Sem limite")</span>
                                <span class="text-muted small">100k+ €</span>
                            </div>
                        </div>
                    </div>

                    <!-- Filtro de Ano -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-calendar-range me-2"></i>Ano
                        </label>
                        <div class="row g-2">
                            <div class="col-6">
                                <input type="number" name="anoMin" id="ano-min" class="form-control" placeholder="Min" min="1960" max="2025" value="@ViewBag.AnoMin">
                            </div>
                            <div class="col-6">
                                <input type="number" name="anoMax" id="ano-max" class="form-control" placeholder="Max" min="1960" max="2025" value="@ViewBag.AnoMax">
                            </div>
                        </div>
                    </div>

                    <!-- Filtro de Quilometragem -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-speedometer2 me-2"></i>Quilometragem (km)
                        </label>
                        <div class="row g-2">
                            <div class="col-12">
                                <input type="number" name="kmMax" id="km-max" class="form-control" placeholder="Máximo" step="1000" value="@ViewBag.KmMax">
                            </div>
                        </div>
                    </div>

                    <!-- Filtro de Tipo de Veículo -->
                    <div class="filter-group">
                        <label for="tipoId" class="filter-label">
                            <i class="bi bi-bicycle me-2"></i>Tipo de Veículo
                        </label>
                        <select name="tipoId" id="tipoId" class="form-select">
                            <option value="">Todos</option>
                            @foreach (var tipo in tipos)
                            {
                                <option value="@tipo.Id" selected="@(ViewBag.TipoIdSelecionado == tipo.Id)">
                                    @tipo.Nome
                                </option>
                            }
                        </select>
                    </div>

                    <!-- Filtro de Categoria (SUV, Sedan, etc) -->
                    <div class="filter-group">
                        <label for="categoriaId" class="filter-label">
                            <i class="bi bi-grid-3x3-gap me-2"></i>Categoria
                        </label>
                        <select name="categoriaId" id="categoriaId" class="form-select">
                            <option value="">Todas</option>
                            @foreach (var cat in categorias)
                            {
                                <option value="@cat.Id" selected="@(ViewBag.CategoriaIdSelecionada == cat.Id)">
                                    @cat.Nome
                                </option>
                            }
                        </select>
                    </div>

                    <!-- Filtro de Combustível -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-fuel-pump me-2"></i>Combustível
                        </label>
                        <div class="btn-group-vertical w-100" role="group">
                            <input type="radio" class="btn-check" name="combustivelId" id="comb-todos" value="" @(ViewBag.CombustivelIdSelecionado == null ? "checked" : "")>
                            <label class="btn btn-outline-secondary" for="comb-todos">Todos</label>

                            @foreach (var combustivel in combustiveis)
                            {
                                <input type="radio" class="btn-check" name="combustivelId" id="comb-@combustivel.Id" value="@combustivel.Id" @(ViewBag.CombustivelIdSelecionado == combustivel.Id ? "checked" : "")>
                                <label class="btn btn-outline-secondary" for="comb-@combustivel.Id">@combustivel.Tipo</label>
                            }
                        </div>
                    </div>

                    <!-- Filtro de Caixa -->
                    <div class="filter-group">
                        <label for="caixa" class="filter-label">
                            <i class="bi bi-gear-fill me-2"></i>Transmissão
                        </label>
                        <select name="caixa" id="caixa" class="form-select">
                            <option value="">Todas</option>
                            <option value="manual" selected="@(ViewBag.Caixa == "manual")">Manual</option>
                            <option value="automatica" selected="@(ViewBag.Caixa == "automatica")">Automática</option>
                        </select>
                    </div>

                    <!-- Filtro de Localização -->
                    <div class="filter-group">
                        <label for="localizacao" class="filter-label">
                            <i class="bi bi-geo-alt-fill me-2"></i>Localização
                        </label>
                        <input type="text" name="localizacao" id="localizacao" class="form-control" placeholder="Cidade ou distrito" value="@ViewBag.Localizacao">
                    </div>

                    <!-- Botão Aplicar -->
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-search me-2"></i>Aplicar Filtros
                        </button>
                        @if (User.Identity?.IsAuthenticated == true && User.IsInRole("Comprador"))
                        {
                            <button type="button" class="btn btn-outline-secondary" onclick="saveFiltersPost()">
                                <i class="bi bi-bookmark-heart me-2"></i>Guardar Pesquisa
                            </button>
                        }
                    </div>
                </form>
            </div>
        </div>

        <!-- Coluna de Anúncios -->
        <div class="col-lg-9" id="listingsColumn">
            <!-- Barra de Ações e Ordenação -->
            <div class="results-toolbar">
                <div class="results-info">
                    <h6 class="mb-0">
                        <span class="results-count">@Model.Count() Veículos</span>
                        <span class="text-muted small">encontrados</span>
                    </h6>
                </div>
                <div class="results-actions">
                    <div class="view-toggle me-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-secondary active" title="Vista de grelha">
                                <i class="bi bi-grid-3x3-gap"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="Vista de lista">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                    </div>
                    <div class="sort-dropdown">
						<select name="ordenacao"
								id="ordenar"
								form="filtrosForm"
								class="form-select form-select-sm"
								onchange="this.form.submit()">

							<option value="relevancia" selected="@(ViewBag.Ordenacao == "relevancia" || ViewBag.Ordenacao == null)">Relevância</option>
							<option value="preco-asc" selected="@(ViewBag.Ordenacao == "preco-asc")">Preço: Menor para Maior</option>
							<option value="preco-desc" selected="@(ViewBag.Ordenacao == "preco-desc")">Preço: Maior para Menor</option>
							<option value="ano-desc" selected="@(ViewBag.Ordenacao == "ano-desc")">Ano: Mais Recente</option>
							<option value="km-asc" selected="@(ViewBag.Ordenacao == "km-asc")">Quilometragem: Menor</option>
						</select>
                    </div>
                </div>
            </div>

            <!-- Lista de Anúncios -->
            <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mt-2">
                @if (Model != null && Model.Any())
                {
                    @foreach (var anuncio in Model)
                    {
                        <div class="col">
                            <div class="card anuncio-card h-100">
                                <div class="card-img-wrapper">
                                    <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id">
                                        @if (anuncio.Imagens != null && anuncio.Imagens.Any())
                                        {
                                            <img src="@anuncio.Imagens.First().ImagemCaminho" class="card-img-top" alt="@anuncio.Titulo">
                                        }
                                        else
                                        {
                                            <img src="~/imagens/no-image.jpg" class="card-img-top" alt="@anuncio.Titulo">
                                        }
                                    </a>
                                    <button class="btn-favorito" data-anuncio-id="@anuncio.Id">
                                        <i class="bi bi-heart"></i>
                                    </button>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <div class="card-header-info mb-2">
                                        @if (anuncio.Destacado && anuncio.DestaqueAte.HasValue && anuncio.DestaqueAte.Value > DateTime.Now)
                                        {
                                            <span class="badge bg-warning text-dark"><i class="bi bi-star-fill me-1"></i>Destaque</span>
                                        }
                                        <span class="badge bg-secondary">@(anuncio.Tipo?.Nome ?? "Usado")</span>
                                        <span class="text-muted small">
                                            <i class="bi bi-geo-alt me-1"></i>@(anuncio.Localizacao ?? "N/A")
                                        </span>
                                    </div>
                                    <h5 class="card-title">@anuncio.Titulo</h5>
                                    <div class="card-price">@anuncio.Preco.ToString("C")</div>
                                    <p class="card-text text-muted small flex-grow-1">
                                        @anuncio.Marca?.Nome @anuncio.Modelo?.Nome
                                    </p>
                                    <div class="anuncio-details-grid mt-auto">
                                        @if (anuncio.Ano.HasValue)
                                        {
                                            <span><i class="bi bi-calendar3"></i> @anuncio.Ano</span>
                                        }
                                        @if (anuncio.Quilometragem.HasValue)
                                        {
                                            <span><i class="bi bi-speedometer2"></i> @anuncio.Quilometragem.Value.ToString("N0") km</span>
                                        }
                                        @if (anuncio.Combustivel != null)
                                        {
                                            <span><i class="bi bi-fuel-pump"></i> @anuncio.Combustivel.Tipo</span>
                                        }
                                        @if (!string.IsNullOrEmpty(anuncio.Caixa))
                                        {
                                            <span><i class="bi bi-gear-fill"></i> @anuncio.Caixa</span>
                                        }
                                    </div>
                                    <div class="card-footer-actions">
                                        <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-primary w-100">
                                            <i class="bi bi-eye me-2"></i>Ver Detalhes
                                        </a>
                                        <button class="btn btn-outline-primary btn-compare w-100"
                                                data-anuncio-id="@anuncio.Id"
                                                onclick="addToCompare(
                                                    @anuncio.Id,
                                                    '@Html.Raw(anuncio.Titulo.Replace("'", "\\'"))',
                                                    '@(anuncio.Imagens != null && anuncio.Imagens.Any() ? anuncio.Imagens.First().ImagemCaminho : "~/imagens/no-image.jpg")',
                                                    '@anuncio.Preco.ToString("C")',
                                                    @(anuncio.Ano ?? 0),
                                                    @(anuncio.Quilometragem ?? 0),
                                                    '@(anuncio.Combustivel?.Tipo ?? "N/A")',
                                                    '@(anuncio.Caixa ?? "N/A")',
                                                    @(anuncio.Potencia ?? 0),
                                                    @(anuncio.Cilindrada ?? 0),
                                                    this
                                                )">
                                            <i class="bi bi-arrow-left-right me-2"></i>Comparar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #6c757d;"></i>
                            <h5 class="text-muted mt-3">Nenhum veículo encontrado</h5>
                            <p class="text-muted">Tente ajustar os filtros de pesquisa.</p>
                        </div>
                    </div>
                }
            </div>
            <!-- Paginação -->
            <nav aria-label="Navegação de página" class="mt-5">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item"><a class="page-link" href="#">4</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Floating Comparison Bar -->
<div id="comparisonBar" class="comparison-bar">
    <div class="container-fluid">
        <div class="d-flex align-items-center justify-content-between">
            <div class="comparison-header">
                <h6 class="mb-0">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    <span>Comparar Veículos</span>
                    <span class="badge bg-primary ms-2" id="compareCount">0</span>
                </h6>
            </div>
            <div class="comparison-items d-flex gap-3 flex-grow-1 mx-4" id="comparisonItems">
                <!-- Items will be added dynamically -->
            </div>
            <div class="comparison-actions d-flex gap-2">
                <button class="btn btn-light btn-sm" onclick="clearComparison()">
                    <i class="bi bi-trash"></i> Limpar
                </button>
                <a href="/Anuncios/Compare" class="btn btn-primary btn-sm" id="btnCompare" disabled>
                    <i class="bi bi-eye me-1"></i>Comparar (<span id="compareCountBtn">0</span>)
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function updatePriceLabel(value) {
            if (value >= 100000) {
                document.getElementById('precoValue').textContent = 'Sem limite';
            } else {
                const formatted = new Intl.NumberFormat('pt-PT').format(value);
                document.getElementById('precoValue').textContent = formatted + ' €';
            }
        }

        function resetFilters() {
            window.location.href = '@Url.Action("Index", "Anuncios")';
        }

        function saveFilters() {
            alert('Pesquisa guardada com sucesso! Receberá notificações quando surgirem novos anúncios que correspondam aos seus critérios.');
        }

        // Função de POST para guardar pesquisa atual
        function saveFiltersPost() {
            const form = document.getElementById('filtrosForm');
            const data = new FormData();
            data.append('marcaId', form.elements['marcaId'] ? form.elements['marcaId'].value : '');
            data.append('modeloId', form.elements['modeloId'] ? form.elements['modeloId'].value : '');
            data.append('tipoId', form.elements['tipoId'] ? form.elements['tipoId'].value : '');
            data.append('categoriaId', form.elements['categoriaId'] ? form.elements['categoriaId'].value : '');
            const combSel = form.querySelector('input[name="combustivelId"]:checked');
            data.append('combustivelId', combSel ? combSel.value : '');
            
            const precoVal = form.elements['precoMax'] ? form.elements['precoMax'].value : '';
            // Se for >= 100000, consideramos "sem limite", logo não guardamos o preço máximo
            if (precoVal && parseInt(precoVal) < 100000) {
                data.append('precoMax', precoVal);
            }
            
            data.append('anoMin', form.elements['anoMin'] ? form.elements['anoMin'].value : '');
            data.append('anoMax', form.elements['anoMax'] ? form.elements['anoMax'].value : '');
            data.append('kmMax', form.elements['kmMax'] ? form.elements['kmMax'].value : '');
            data.append('caixa', form.elements['caixa'] ? form.elements['caixa'].value : '');
            data.append('localizacao', form.elements['localizacao'] ? form.elements['localizacao'].value : '');
            data.append('ordenacao', form.elements['ordenacao'] ? form.elements['ordenacao'].value : '');
            
            const marcaSel = form.elements['marcaId'];
            const modeloSel = form.elements['modeloId'];
            const marcaNome = marcaSel && marcaSel.selectedIndex > 0 ? marcaSel.options[marcaSel.selectedIndex].text : '';
            const modeloNome = modeloSel && modeloSel.selectedIndex > 0 ? modeloSel.options[modeloSel.selectedIndex].text : '';
            
            let sugerido = `${marcaNome} ${modeloNome}`.trim();
            if (precoVal && parseInt(precoVal) < 100000) {
                sugerido += ` ≤ ${new Intl.NumberFormat('pt-PT').format(precoVal)}€`;
            }
            sugerido = sugerido.trim();
            
            const nome = prompt('Nome da pesquisa para guardar:', sugerido || 'Pesquisa');
            if (nome === null) return;
            data.append('nome', nome);
            
            fetch('@Url.Action("GuardarFiltro","Anuncios")', { method: 'POST', body: data, credentials: 'same-origin' })
                .then(res => { if (res.redirected) { window.location.href = res.url; } else { alert('Pesquisa guardada.'); window.location.reload(); } })
                .catch(() => alert('Não foi possível guardar a pesquisa.'));
        }

        // ========== COMPARISON FUNCTIONALITY ==========

        const MAX_COMPARE = 3;

        // Load comparison from localStorage
        function loadComparison() {
            const stored = localStorage.getItem('compareVehicles');
            return stored ? JSON.parse(stored) : [];
        }

        // Save comparison to localStorage
        function saveComparison(items) {
            localStorage.setItem('compareVehicles', JSON.stringify(items));
            // Also save as URL parameter for navigation
            const ids = items.map(item => item.id).join(',');
            localStorage.setItem('compareIds', ids);
        }

        // Add vehicle to comparison
        function addToCompare(id, titulo, imagem, preco, ano, km, combustivel, caixa, potencia, cilindrada, button) {
            let compareList = loadComparison();

            // Check if already in comparison
            const alreadyExists = compareList.some(item => item.id === id);

            if (alreadyExists) {
                // Remove from comparison
                compareList = compareList.filter(item => item.id !== id);
                button.classList.remove('active');
                button.innerHTML = '<i class="bi bi-arrow-left-right me-2"></i>Comparar';
            } else {
                // Check if max reached
                if (compareList.length >= MAX_COMPARE) {
                    alert(`Pode comparar no máximo ${MAX_COMPARE} veículos de cada vez. Remova um veículo para adicionar outro.`);
                    return;
                }

                // Add to comparison
                compareList.push({
                    id: id,
                    titulo: titulo,
                    imagem: imagem,
                    preco: preco,
                    ano: ano,
                    km: km,
                    combustivel: combustivel,
                    caixa: caixa,
                    potencia: potencia,
                    cilindrada: cilindrada
                });
                button.classList.add('active');
                button.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Adicionado';
            }

            saveComparison(compareList);
            updateComparisonBar();
        }

        // Remove from comparison
        function removeFromComparison(id) {
            let compareList = loadComparison();
            compareList = compareList.filter(item => item.id !== id);
            saveComparison(compareList);
            updateComparisonBar();

            // Update button state
            const button = document.querySelector(`[data-anuncio-id="${id}"]`);
            if (button) {
                button.classList.remove('active');
                button.innerHTML = '<i class="bi bi-arrow-left-right me-2"></i>Comparar';
            }
        }

        // Clear all comparisons
        function clearComparison() {
            if (confirm('Tem a certeza que deseja limpar todos os veículos da comparação?')) {
                localStorage.removeItem('compareVehicles');
                localStorage.removeItem('compareIds');
                updateComparisonBar();

                // Reset all buttons
                document.querySelectorAll('.btn-compare.active').forEach(btn => {
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="bi bi-arrow-left-right me-2"></i>Comparar';
                });
            }
        }

        // Update comparison bar UI
        function updateComparisonBar() {
            const compareList = loadComparison();
            const count = compareList.length;
            const bar = document.getElementById('comparisonBar');
            const itemsContainer = document.getElementById('comparisonItems');
            const compareBtn = document.getElementById('btnCompare');

            // Update counts
            document.getElementById('compareCount').textContent = count;
            document.getElementById('compareCountBtn').textContent = count;

            // Show/hide bar and adjust body padding
            if (count > 0) {
                bar.classList.add('show');
                // Small delay to get the correct height after animation
                setTimeout(() => {
                    const barHeight = bar.offsetHeight;
                    document.body.style.paddingBottom = barHeight + 'px';
                }, 50);
            } else {
                bar.classList.remove('show');
                // Remove padding when bar is hidden
                document.body.style.paddingBottom = '0';
            }

            // Enable/disable compare button
            if (count >= 2) {
                compareBtn.removeAttribute('disabled');
                compareBtn.classList.remove('disabled');
            } else {
                compareBtn.setAttribute('disabled', 'disabled');
                compareBtn.classList.add('disabled');
            }

            // Render items
            itemsContainer.innerHTML = '';
            compareList.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'comparison-item';

                // Fix image path - remove ~/ and use absolute path
                let imagePath = item.imagem;
                if (imagePath.startsWith('~/')) {
                    imagePath = imagePath.substring(1); // Remove ~
                }

                itemEl.innerHTML = `
                    <button class="btn-remove-compare" onclick="removeFromComparison(${item.id})" title="Remover">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                    <img src="${imagePath}" alt="${item.titulo}" onerror="this.src='https://placehold.co/150x100/e9ecef/64748b?text=Sem+Imagem'">
                    <div class="comparison-item-info">
                        <div class="comparison-item-title">${item.titulo}</div>
                        <div class="comparison-item-price">${item.preco}</div>
                    </div>
                `;
                itemsContainer.appendChild(itemEl);
            });

            // Add placeholder slots
            for (let i = count; i < MAX_COMPARE; i++) {
                const placeholder = document.createElement('div');
                placeholder.className = 'comparison-item-placeholder';
                placeholder.innerHTML = `
                    <i class="bi bi-plus-circle"></i>
                    <span>Adicione ${i === 0 ? 'um veículo' : 'mais'}</span>
                `;
                itemsContainer.appendChild(placeholder);
            }
        }

        // Initialize comparison on page load
        document.addEventListener('DOMContentLoaded', function() {
            const compareList = loadComparison();

            // Update button states for items already in comparison
            compareList.forEach(item => {
                const button = document.querySelector(`[data-anuncio-id="${item.id}"]`);
                if (button) {
                    button.classList.add('active');
                    button.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Adicionado';
                }
            });

            updateComparisonBar();

            // ========== FILTER TOGGLE FUNCTIONALITY ==========
            const filtersCollapse = document.getElementById('mobileFilters');
            const filtersColumn = document.getElementById('filtersColumn');
            const listingsColumn = document.getElementById('listingsColumn');

            if (filtersCollapse && filtersColumn && listingsColumn) {
                // Only apply on larger screens (lg breakpoint and up)
                function handleFilterToggle() {
                    if (window.innerWidth >= 992) { // Bootstrap lg breakpoint
                        const filtersButton = document.querySelector('[data-bs-target="#mobileFilters"]');
                        const isCollapsed = filtersCollapse.classList.contains('show');

                        if (!isCollapsed) {
                            // Filters are hidden
                            filtersColumn.style.display = 'none';
                            listingsColumn.classList.remove('col-lg-9');
                            listingsColumn.classList.add('col-lg-12');
                            listingsColumn.style.maxWidth = '1400px';
                            listingsColumn.style.margin = '0 auto';
                        } else {
                            // Filters are shown
                            filtersColumn.style.display = 'block';
                            listingsColumn.classList.remove('col-lg-12');
                            listingsColumn.classList.add('col-lg-9');
                            listingsColumn.style.maxWidth = '';
                            listingsColumn.style.margin = '';
                        }
                    }
                }

                filtersCollapse.addEventListener('hidden.bs.collapse', function () {
                    if (window.innerWidth >= 992) {
                        filtersColumn.style.display = 'none';
                        listingsColumn.classList.remove('col-lg-9');
                        listingsColumn.classList.add('col-lg-12');
                        listingsColumn.style.maxWidth = '1400px';
                        listingsColumn.style.margin = '0 auto';
                    }
                });

                filtersCollapse.addEventListener('shown.bs.collapse', function () {
                    if (window.innerWidth >= 992) {
                        filtersColumn.style.display = 'block';
                        listingsColumn.classList.remove('col-lg-12');
                        listingsColumn.classList.add('col-lg-9');
                        listingsColumn.style.maxWidth = '';
                        listingsColumn.style.margin = '';
                    }
                });

                // Reset layout on window resize
                window.addEventListener('resize', function() {
                    if (window.innerWidth < 992) {
                        // Mobile view - reset all custom styles
                        filtersColumn.style.display = '';
                        listingsColumn.style.maxWidth = '';
                        listingsColumn.style.margin = '';
                    }
                });
            }
        });
    </script>

    <script src="~/js/favoritos.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const marcaSelect = document.getElementById('marcaId');
            const modeloSelect = document.getElementById('modeloId');

            function updateModelos(keepSelection) {
                const marcaId = marcaSelect.value;
                const previousValue = modeloSelect.value;

                modeloSelect.innerHTML = '<option value="">A carregar...</option>';

                // Determine correct URL
                let url = '/Anuncios/GetModelosByMarca';
                if (marcaId) url += '?marcaId=' + marcaId;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        modeloSelect.innerHTML = '<option value="">Todos os Modelos</option>';
                        data.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m.id;
                            option.text = m.nome;
                            modeloSelect.appendChild(option);
                        });

                        // Restore selection if requested and valid
                        if (keepSelection && previousValue) {
                            modeloSelect.value = previousValue;
                        }
                    })
                    .catch(err => {
                        console.error('Erro ao buscar modelos:', err);
                        modeloSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                    });
            }

            if (marcaSelect && modeloSelect) {
                marcaSelect.addEventListener('change', function () {
                    // Update models, clearing selection (false)
                    updateModelos(false);
                });

                // On load: if brand is selected, filter models but try to keep selection
                if (marcaSelect.value) {
                    updateModelos(true);
                }
            }
        });
    </script>
}
