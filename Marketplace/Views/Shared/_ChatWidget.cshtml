@* Frontend-only floating chat widget (mockup) *@
<style>
  .chat-widget-button {
    position: fixed;
    right: 24px;
    bottom: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background-color: #2563eb;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(37, 99, 235, 0.35);
    z-index: 1080;
  }

  .chat-widget-panel {
    position: fixed;
    right: 24px;
    bottom: 90px;
    width: 360px;
    height: 480px;
    max-width: calc(100vw - 32px);
    max-height: calc(100vh - 120px);
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    display: none;
    flex-direction: column;
    z-index: 1080;
    border: 1px solid #e5e7eb;
  }

  .chat-widget-panel.open { display: flex; }

  .chat-header {
    background: #1e293b;
    color: #fff;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .chat-header .title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
  }

  .chat-body {
    padding: 12px;
    background: #f8fafc;
    flex: 1;
    overflow-y: auto;
  }

  .chat-footer {
    padding: 10px;
    border-top: 1px solid #e5e7eb;
    background: #fff;
  }

  .msg {
    display: inline-block;
    max-width: 78%;
    padding: 10px 12px;
    border-radius: 12px;
    margin: 6px 0;
    line-height: 1.35;
    font-size: 0.95rem;
  }
  .msg.bot { background: #eef2ff; color: #111827; border: 1px solid #e5e7eb; }
  .msg.user { background: #2563eb; color: #fff; margin-left: auto; }

  .bubble { display: flex; }
  .bubble.bot { justify-content: flex-start; }
  .bubble.user { justify-content: flex-end; }

  .chip-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
  .chip { background: #e2e8f0; color: #0f172a; border: none; border-radius: 999px; padding: 6px 10px; font-size: 0.85rem; cursor: pointer; }
  .chip:hover { background: #cbd5e1; }

  .typing { display: inline-flex; gap: 4px; align-items: center; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: #9ca3af; animation: blink 1.2s infinite; }
  .dot:nth-child(2) { animation-delay: .2s; }
  .dot:nth-child(3) { animation-delay: .4s; }
  @@keyframes blink { 0%, 80%, 100% { opacity: .2 } 40% { opacity: 1 } }

  @@media (max-width: 576px) {
    .chat-widget-panel { width: calc(100vw - 16px); right: 8px; bottom: 84px; height: 60vh; }
  }
</style>

<button id="chatWidgetToggle" type="button" class="chat-widget-button" aria-label="Abrir chat de ajuda">
  <i class="bi bi-info-circle" </i>
  <span class="visually-hidden">Chat</span>
  <span id="chatWidgetBadge" class="position-absolute translate-middle p-1 bg-danger border border-light rounded-circle" style="top: 6px; right: 6px; display:none;"></span>
  
</button>

<div id="chatWidgetPanel" class="chat-widget-panel shadow-lg">
  <div class="chat-header">
    <div class="title">
      <i class="bi bi-robot"></i>
      <span>Assistente 404</span>
    </div>
    <div>
      <button id="chatMinimize" class="btn btn-sm btn-outline-light" title="Minimizar"><i class="bi bi-dash"></i></button>
      <button id="chatClose" class="btn btn-sm btn-outline-light ms-1" title="Fechar"><i class="bi bi-x-lg"></i></button>
    </div>
  </div>
  <div id="chatBody" class="chat-body">
    <div class="bubble bot">
      <div class="msg bot">
        Olá! Sou o assistente 404 Ride. Posso ajudar com dúvidas sobre conta, anúncios, reservas, visitas, mensagens, pagamentos, segurança e privacidade. Em que posso ajudar?
        <div class="chip-row mt-2">
          <button class="chip" data-quick="Como me registo?">Registo</button>
          <button class="chip" data-quick="Como criar um anúncio?">Criar anúncio</button>
          <button class="chip" data-quick="Como destacar anúncio?">Destacar</button>
          <button class="chip" data-quick="Como faço uma reserva?">Reservas</button>
          <button class="chip" data-quick="Como ativar 2FA?">2FA</button>
          <button class="chip" data-quick="Como denunciar?">Denúncias</button>
        </div>
      </div>
    </div>
  </div>
  <div class="chat-footer">
    <div class="input-group">
      <input id="chatInput" type="text" class="form-control" placeholder="Escreva a sua mensagem..." aria-label="Mensagem para o assistente">
      <button id="chatSend" class="btn btn-primary" type="button"><i class="bi bi-send-fill"></i></button>
    </div>
    <div class="mt-2 small text-muted">Para mais ajuda, consulte nossa <a href="/Faq" class="link-primary">FAQ</a> ou contacte <a href="mailto:404ride@gmail.com">suporte</a>.</div>
  </div>
</div>

<script>
  (function () {
    const toggle = document.getElementById('chatWidgetToggle');
    const panel = document.getElementById('chatWidgetPanel');
    const body = document.getElementById('chatBody');
    const input = document.getElementById('chatInput');
    const send = document.getElementById('chatSend');
    const closeBtn = document.getElementById('chatClose');
    const minBtn = document.getElementById('chatMinimize');
    const badge = document.getElementById('chatWidgetBadge');

    function openPanel() {
      panel.classList.add('open');
      badge && (badge.style.display = 'none');
      setTimeout(() => input && input.focus(), 50);
    }
    function closePanel() { panel.classList.remove('open'); }
    function minimizePanel() { panel.classList.toggle('open'); }

    toggle && toggle.addEventListener('click', openPanel);
    closeBtn && closeBtn.addEventListener('click', closePanel);
    minBtn && minBtn.addEventListener('click', minimizePanel);

    function appendMessage(role, html) {
      const wrap = document.createElement('div');
      wrap.className = 'bubble ' + (role === 'user' ? 'user' : 'bot');
      const msg = document.createElement('div');
      msg.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      msg.innerHTML = html;
      wrap.appendChild(msg);
      body.appendChild(wrap);
      body.scrollTop = body.scrollHeight;
    }

    function showTyping() {
      const wrap = document.createElement('div');
      wrap.className = 'bubble bot typing-row';
      const msg = document.createElement('div');
      msg.className = 'msg bot';
      msg.innerHTML = '<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
      wrap.appendChild(msg);
      body.appendChild(wrap);
      body.scrollTop = body.scrollHeight;
      return wrap;
    }

    function sanitize(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function replyFor(text) {
      const t = text.toLowerCase();

      // Conta e Acesso
      if (t.includes('regist') || t.includes('criar conta') || t.includes('cadastro')) {
        return 'Para criar conta, vá a <a href="/Utilizadores/Registar" class="link-primary">Registar</a>, escolha Comprador ou Vendedor e preencha nome, email, username e password. Receberá confirmação por email.';
      }
      if (t.includes('2fa') || t.includes('dois fatores') || t.includes('autenticação')) {
        return 'Ative 2FA em Perfil → Definições → Segurança. Use uma app Authenticator para gerar códigos de 6 dígitos. Códigos de recuperação são gerados para emergências.';
      }
      if (t.includes('password') || t.includes('palavra-passe') || t.includes('recuperar senha') || t.includes('alterar senha')) {
        return 'Para <strong>alterar</strong>: Perfil → Definições → Segurança → Alterar Password. Para <strong>recuperar</strong>: em <a href="/Utilizadores/Login" class="link-primary">Login</a>, clique "Esqueci-me da password".';
      }
      if (t.includes('vendedor') && t.includes('comprador')) {
        return 'Sim! Crie conta como comprador e, quando quiser vender, peça validação como vendedor (dados fiscais e contacto). O admin ativa mantendo o mesmo login.';
      }

      // Anúncios
      if (t.includes('publicar') || (t.includes('criar') && t.includes('anúncio'))) {
        return 'Aceda a <a href="/Anuncios/Create" class="link-primary">Criar Anúncio</a>, preencha dados do veículo e carregue imagens (JPEG/PNG/WebP até 10 MB). O anúncio entra em validação (objetivo: 24h úteis).';
      }
      if (t.includes('validação') || t.includes('aprovação') || t.includes('quanto tempo')) {
        return 'A validação demora até 24h úteis. Receberá notificação quando for aprovado ou se precisarmos de ajustes (ex.: fotos desfocadas, dados incompletos).';
      }
      if (t.includes('editar') || t.includes('pausar') || t.includes('remover')) {
        return 'Em Perfil → Meus Anúncios pode editar dados, atualizar fotos, pausar ou remover. Se remover, as reservas associadas são canceladas.';
      }
      if (t.includes('destacar') || t.includes('topo') || t.includes('premium')) {
        return 'Para destacar seu anúncio no topo das listagens, use o botão "Destacar" em Meus Anúncios. Custa 1,99€ por 7 dias e inclui badge "Destaque" visível. Pagamento via Stripe.';
      }
      if (t.includes('foto') || t.includes('imagem') || t.includes('requisitos')) {
        return 'Formatos aceites: JPEG, PNG, WebP. Tamanho: até 10 MB cada. Use fotos nítidas do exterior, interior, painel e documentação (sem expor dados sensíveis).';
      }

      // Reservas e Visitas
      if (t.includes('reserva') || t.includes('visita') || t.includes('agendar')) {
        return 'Na página do anúncio, use "Reservar" ou "Agendar Visita". Escolha data/hora disponível. Pode ver o histórico em Perfil → Reservas/Visitas.';
      }
      if (t.includes('cancelar') || t.includes('reagendar')) {
        return 'Sim, pode cancelar ou reagendar. Fale com o vendedor na conversa ou cancele pelo painel. Se houver sinal, verifique as condições acordadas.';
      }
      if (t.includes('disponibilidade') || t.includes('horário')) {
        return 'O vendedor configura horários em Perfil → Disponibilidade. Apenas slots livres são exibidos para marcação de visitas.';
      }

      // Mensagens e Alertas
      if (t.includes('mensagem') || t.includes('conversa') || t.includes('chat')) {
        return 'Após contactar um anúncio, a conversa fica no painel de Mensagens e no Perfil. Notificamos novas mensagens por badge e, se ativo, por email.';
      }
      if (t.includes('alerta') || t.includes('favorito') || t.includes('pesquisa guardada')) {
        return 'Guarde uma pesquisa na listagem. O sistema verifica novos anúncios que correspondam aos filtros e cria notificações automáticas (Perfil → Pesquisas Guardadas).';
      }

      // Pagamentos
      if (t.includes('pagamento') || t.includes('sinal')) {
        return 'O valor de sinal é combinado entre comprador e vendedor. Registe-o no fluxo de Reserva para ficar associado ao anúncio e visível no histórico.';
      }
      if (t.includes('fatura') || t.includes('recibo') || t.includes('nif')) {
        return 'Vendedores podem preencher dados de faturação e NIF no Perfil. A emissão de recibo/fatura é tratada diretamente entre comprador e vendedor.';
      }

      // Segurança
      if (t.includes('segurança') || t.includes('protecção') || t.includes('proteção')) {
        return 'Usamos ASP.NET Identity, passwords hash, lockout após tentativas falhadas e 2FA opcional. Sessões podem ser terminadas em Perfil → Segurança → Sessões Ativas.';
      }
      if (t.includes('denúnc') || t.includes('denunc') || t.includes('fraude') || t.includes('abuso')) {
        return 'Use o botão "Denunciar" no anúncio ou perfil do utilizador, indicando motivo e evidências. A equipa revê, pode suspender e notifica as partes envolvidas.';
      }

      // Privacidade
      if (t.includes('privacidade') || t.includes('dados') || t.includes('gdpr')) {
        return 'Guardamos dados de conta, anúncios, mensagens e reservas para operar o marketplace. Não partilhamos com terceiros sem consentimento. Pode pedir exportação ou remoção via <a href="mailto:404ride@gmail.com">suporte</a>.';
      }
      if (t.includes('notificaç') || t.includes('email') || t.includes('newsletter')) {
        return 'Em Perfil → Definições ajuste notificações por email e alertas de favoritos/pesquisas. Pode sair da newsletter a qualquer momento.';
      }

      // Ajuda geral
      if (t.includes('faq') || t.includes('ajuda') || t.includes('suporte')) {
        return 'Consulte nossa <a href="/Faq" class="link-primary">página de FAQ</a> para respostas detalhadas. Para questões específicas, contacte <a href="mailto:404ride@gmail.com">404ride@gmail.com</a> (resposta &lt; 24h úteis).';
      }

      // Resposta padrão melhorada
      return 'Não encontrei uma resposta específica. Tente perguntar sobre: <strong>registo, anúncios, destacar, reservas, 2FA, mensagens, pagamentos, denúncias ou privacidade</strong>. Ou consulte nossa <a href="/Faq" class="link-primary">FAQ completa</a>.';
    }

    function handleSend(text) {
      const trimmed = (text || '').trim();
      if (!trimmed) return;
      appendMessage('user', sanitize(trimmed));
      input.value = '';
      const typingRow = showTyping();
      setTimeout(() => {
        typingRow.remove();
        appendMessage('bot', replyFor(trimmed));
      }, 700);
    }

    send && send.addEventListener('click', () => handleSend(input.value));
    input && input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend(input.value);
      }
    });

    // Quick chips
    document.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if (chip && chip.dataset.quick) {
        handleSend(chip.dataset.quick);
      }
    });

    // Small attention badge after load (if panel closed)
    setTimeout(() => { if (!panel.classList.contains('open') && badge) badge.style.display = 'inline-block'; }, 1500);
  })();
</script>
