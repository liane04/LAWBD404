@{
    ViewData["Title"] = "Meu Perfil";
}

<div class="container mt-5 pt-5 mb-5 pb-5">
    <div class="row g-4">
        <!-- Barra Lateral de Navegação do Perfil -->
        <div class="col-lg-3">
            <div class="perfil-sidebar card shadow-sm border-0">
                <div class="card-body p-0">
                    <!-- Cabeçalho do Perfil -->
                    <div class="perfil-header text-center p-4">
                        <div class="perfil-avatar-wrapper position-relative d-inline-block mb-3">
                            <img src="@((ViewBag.ImagemPerfil as string) ?? Url.Content("~/imagens/logo.png"))"
                                 class="perfil-avatar rounded-circle"
                                 alt="Foto de Perfil">
                            <button class="perfil-avatar-edit btn btn-sm btn-primary rounded-circle position-absolute">
                                <i class="bi bi-camera-fill"></i>
                            </button>
                        </div>
                        <h5 class="mb-2 fw-bold">@(ViewBag.Nome ?? "Utilizador")</h5>
                        <div class="perfil-user-badges mb-2">
                            @if (User.IsInRole("Comprador"))
                            {
                                <span class="perfil-badge perfil-badge-comprador">
                                    <i class="bi bi-person-check-fill"></i> Comprador
                                </span>
                            }
                            @if (User.IsInRole("Vendedor"))
                            {
                                <span class="perfil-badge perfil-badge-vendedor">
                                    <i class="bi bi-shop"></i> Vendedor
                                </span>
                            }
                            @if (User.IsInRole("Administrador"))
                            {
                                <span class="perfil-badge perfil-badge-admin">
                                    <i class="bi bi-shield-check"></i> Administrador
                                </span>
                            }
                        </div>
                        <small class="perfil-member-since">
                            <i class="bi bi-calendar-check me-1"></i>Membro desde @(((DateTime?)ViewBag.DataCriacao)?.ToString("MMM yyyy") ?? "2025")
                        </small>
                    </div>

                    <hr class="m-0">

                    <!-- Menu de Navegação -->
                    <div class="perfil-nav-menu">
                        <!-- Dados Pessoais -->
                        <a href="#dados-pessoais" class="perfil-nav-item active" data-bs-toggle="tab">
                            <i class="bi bi-person-fill"></i>
                            <span>Dados Pessoais</span>
                            <i class="bi bi-chevron-right ms-auto"></i>
                        </a>

                        <!-- Seção: Como Vendedor -->
                        @if (User.IsInRole("Vendedor"))
                        {
                            <a href="#meus-anuncios" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-card-list"></i>
                                <span>Meus Anúncios</span>
                                <span class="badge bg-primary rounded-pill ms-auto">@((ViewBag.AnunciosCount ?? 0))</span>
                            </a>
                            <a href="#reservas-recebidas" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-bookmark-check-fill"></i>
                                <span>Reservas Recebidas</span>
                                <span class="badge bg-success rounded-pill ms-auto">@((ViewBag.ReservasRecebidasCount ?? 0))</span>
                            </a>
                            <a href="#visitas-agendadas-vendedor" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-calendar-event"></i>
                                <span>Visitas Agendadas</span>
                                <span class="badge bg-info rounded-pill ms-auto">@((ViewBag.VisitasAgendadasCount ?? 0))</span>
                            </a>
                            <a href="#disponibilidade" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-clock-history"></i>
                                <span>Disponibilidade</span>
                                <span class="badge bg-primary rounded-pill ms-auto">@((ViewBag.DisponibilidadesCount ?? 0))</span>
                            </a>
                        }

                        <!-- Seção: Como Comprador -->
                        @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                        {
                            <a href="#minhas-reservas" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-bookmark-star-fill"></i>
                                <span>Minhas Reservas</span>
                                <span class="badge bg-warning rounded-pill ms-auto">1</span>
                            </a>
                            <a href="#minhas-visitas" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-calendar-check-fill"></i>
                                <span>Minhas Visitas</span>
                                <span class="badge bg-info rounded-pill ms-auto">1</span>
                            </a>
                            <a href="#minhas-compras" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-bag-check-fill"></i>
                                <span>Minhas Compras</span>
                                <span class="badge bg-success rounded-pill ms-auto">@(ViewBag.ComprasCount ?? 0)</span>
                            </a>
                        }

                        <!-- Seção: Favoritos e Pesquisas -->
                        @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                        {
                            <a href="#favoritos" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-heart-fill"></i>
                                <span>Anúncios Favoritos</span>
                                <span class="badge bg-danger rounded-pill ms-auto" id="favoritos-badge-nav">@(ViewBag.FavoritosCount ?? 0)</span>
                            </a>
                            <a href="#favoritos-marcas" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-tags-fill"></i>
                                <span>Marcas Favoritas</span>
                                <span class="badge bg-secondary rounded-pill ms-auto" id="marcas-fav-badge-nav">@(ViewBag.MarcasFavoritasCount ?? 0)</span>
                            </a>
                        }
                        @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                        {
                            <a href="#pesquisas-guardadas" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-bookmark-heart"></i>
                                <span>Pesquisas Guardadas</span>
                                <i class="bi bi-chevron-right ms-auto"></i>
                            </a>
                        }
                        @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                        {
                            <a href="#historico-pesquisa" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-clock-history"></i>
                                <span>Histórico de Pesquisa</span>
                                <i class="bi bi-chevron-right ms-auto"></i>
                            </a>
                        }

                        <!-- Definições -->
                        <a href="#definicoes" class="perfil-nav-item" data-bs-toggle="tab">
                            <i class="bi bi-gear-fill"></i>
                            <span>Definições</span>
                            <i class="bi bi-chevron-right ms-auto"></i>
                        </a>
                    </div>

                    <hr class="m-0">

                    <!-- Botão de Sair -->
                    <div class="p-3">
                        <a asp-controller="Home" asp-action="Index" class="perfil-logout-btn btn btn-outline-danger w-100">
                            <i class="bi bi-box-arrow-right me-2"></i>Terminar Sessão
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo do Perfil -->
        <div class="col-lg-9">
            <!-- Mensagens de Feedback -->
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>@TempData["Error"]</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            @if (TempData["PerfilSucesso"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>@TempData["PerfilSucesso"]</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @* Aviso permanente para vendedores pendentes *@
            @if (User.IsInRole("Vendedor") && ViewBag.VendedorEstado != null && ViewBag.VendedorEstado != "Ativo")
            {
                <div class="alert alert-warning border-0 shadow-sm" role="alert">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-2">
                                <i class="bi bi-info-circle-fill me-2"></i>Conta Pendente de Aprovação
                            </h5>
                            <p class="mb-0">
                                A sua conta de vendedor está pendente de aprovação pelo administrador.
                                Assim que for aprovada, receberá um email de confirmação e poderá começar a criar anúncios.
                            </p>
                        </div>
                    </div>
                </div>
            }

            <div class="tab-content">
                <!-- Aba: Dados Pessoais -->
                <div class="tab-pane fade show active" id="dados-pessoais">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-person-circle text-primary me-2"></i>Dados Pessoais
                            </h3>
                            <p class="text-muted mb-0">Gerir as suas informações pessoais e de contacto</p>
                        </div>
                        <a asp-action="Edit" class="btn btn-primary">
                            <i class="bi bi-pencil-square me-2"></i>Editar Perfil
                        </a>
                    </div>

                    <!-- Informações Pessoais -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-info-circle text-primary me-2"></i>Informação Pessoal
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-person-badge"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Nome Completo</label>
                                            <p class="perfil-info-value">@(ViewBag.Nome ?? "Não definido")</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-at"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Username</label>
                                            <p class="perfil-info-value">@(ViewBag.UserName ?? "Não definido")</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-envelope"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Email</label>
                                            <p class="perfil-info-value">@(ViewBag.Email ?? "Não definido")</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-shield-check"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Estado da Conta</label>
                                            <p class="perfil-info-value">
                                                @{
                                                    var estado = ViewBag.EstadoConta as string ?? "Ativo";
                                                    var estadoBadgeClass = estado == "Ativo" ? "bg-success-subtle text-success" :
                                                                    estado == "Pendente" ? "bg-warning-subtle text-warning" :
                                                                    "bg-danger-subtle text-danger";
                                                }
                                                <span class="badge @estadoBadgeClass">
                                                    <i class="bi bi-check-circle-fill me-1"></i>@estado
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informações de Contacto -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-telephone text-primary me-2"></i>Contactos
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-phone"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Telemóvel</label>
                                            <p class="perfil-info-value">@(ViewBag.Telefone ?? "Não definido")</p>
                                        </div>
                                    </div>
                                </div>
                                @if (User.IsInRole("Vendedor") && ViewBag.Nif != null)
                                {
                                    <div class="col-md-6">
                                        <div class="perfil-info-item">
                                            <div class="perfil-info-icon">
                                                <i class="bi bi-credit-card-2-front"></i>
                                            </div>
                                            <div class="perfil-info-content">
                                                <label class="perfil-info-label">NIF</label>
                                                <p class="perfil-info-value">@ViewBag.Nif</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                                @if (User.IsInRole("Vendedor"))
                                {
                                    <div class="col-md-6">
                                        <div class="perfil-info-item">
                                            <div class="perfil-info-icon">
                                                <i class="bi bi-bank"></i>
                                            </div>
                                            <div class="perfil-info-content">
                                                <label class="perfil-info-label">NIB (Pagamentos)</label>
                                                <p class="perfil-info-value">@(ViewBag.Nib ?? "Não definido")</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Morada -->
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-geo-alt text-primary me-2"></i>Morada
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <div class="col-md-8">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-house-door"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Rua</label>
                                            <p class="perfil-info-value">@(ViewBag.Rua ?? "Não definido")</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-mailbox"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Código Postal</label>
                                            <p class="perfil-info-value">@(ViewBag.CodigoPostal ?? "Não definido")</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-pin-map"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Localidade</label>
                                            <p class="perfil-info-value">@(ViewBag.Localidade ?? "Não definido")</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-flag"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">País</label>
                                            <p class="perfil-info-value">@(ViewBag.Pais ?? "Portugal")</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    @* Botão para se tornar vendedor (apenas para compradores) *@
                    @if (User.IsInRole("Comprador") && !User.IsInRole("Vendedor"))
                    {
                        <div class="card shadow-sm border-0 border-start border-4 border-primary mt-4">
                            <div class="card-body p-4">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h5 class="mb-2">
                                            <i class="bi bi-shop text-primary me-2"></i>Quer vender os seus veículos?
                                        </h5>
                                        <p class="text-muted mb-0">
                                            Torne-se um vendedor na plataforma 404 Ride e comece a anunciar os seus veículos.
                                            Após aprovação do administrador, terá acesso a todas as funcionalidades de vendedor.
                                        </p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalTornarVendedor">
                                            <i class="bi bi-arrow-right-circle me-2"></i>Tornar-me Vendedor
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                @if (User.IsInRole("Vendedor"))
                {
                    <!-- Aba: Meus Anúncios (para Vendedores) -->
                    <div class="tab-pane fade" id="meus-anuncios">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-card-list text-primary me-2"></i>Meus Anúncios
                            </h3>
                            <p class="text-muted mb-0">Gerir os seus veículos anunciados na plataforma</p>
                        </div>
                        <a asp-controller="Anuncios" asp-action="Create" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>Criar Novo Anúncio
                        </a>
                    </div>

                    <!-- Filtros/Tabs de Estado -->
                    <div class="anuncios-filter-tabs mb-4">
                        <button class="anuncios-filter-btn active" data-filter="todos">
                            <i class="bi bi-grid-fill me-1"></i>Todos <span class="badge bg-primary ms-1">@ViewBag.AnunciosCount</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter="ativo">
                            <i class="bi bi-check-circle-fill me-1"></i>Ativos <span class="badge bg-success ms-1">@ViewBag.AnunciosAtivos</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter="reservado">
                            <i class="bi bi-bookmark-check-fill me-1"></i>Reservados <span class="badge bg-warning ms-1">@ViewBag.AnunciosReservados</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter="vendido">
                            <i class="bi bi-check2-circle me-1"></i>Vendidos <span class="badge bg-info ms-1">@ViewBag.AnunciosVendidos</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter="pausado">
                            <i class="bi bi-pause-circle-fill me-1"></i>Pausados <span class="badge bg-secondary ms-1">@ViewBag.AnunciosPausados</span>
                        </button>
                    </div>

                    <!-- Lista de Anúncios -->
                    <div class="anuncios-list">
                        @await Html.PartialAsync("_MeusAnunciosList", ViewBag.MeusAnuncios as IEnumerable<Marketplace.Models.Anuncio>)
                        <div class="mt-3">
                            <a asp-controller="Utilizadores" asp-action="Edit" class="btn btn-outline-primary">
                                <i class="bi bi-person-gear me-1"></i> Editar Perfil
                            </a>
                        </div>
                    </div>

                    <!-- Estado Vazio (quando filtrado e sem resultados) -->
                    <div class="anuncios-empty text-center py-5 d-none">
                        <div class="mb-4">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #e2e8f0;"></i>
                        </div>
                        <h4 class="text-muted mb-2">Nenhum anúncio encontrado</h4>
                        <p class="text-muted mb-4">Não tem anúncios com este estado</p>
                    </div>
                    </div>

                    <!-- Aba: Reservas Recebidas (para Vendedores) -->
                    <div class="tab-pane fade" id="reservas-recebidas">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-bookmark-check-fill text-success me-2"></i>Reservas Recebidas
                            </h3>
                            <p class="text-muted mb-0">Gerir reservas recebidas nos seus anúncios</p>
                        </div>
                        <div class="reservas-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-success fw-bold">@ViewBag.ReservasAtivasVendedor</div>
                                <div class="stat-label text-muted small">Ativa</div>
                            </div>
                            <div class="stat-item text-center">
                                <div class="stat-value text-primary fw-bold">@(ViewBag.TotalSinais?.ToString("N2") ?? "0,00")€</div>
                                <div class="stat-label text-muted small">Em Sinais</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros de Status -->
                    @{
                        var reservasRecebidas = ViewBag.ReservasRecebidas as IEnumerable<Marketplace.Models.Reserva> ?? Enumerable.Empty<Marketplace.Models.Reserva>();
                        var totalReservasVendedor = reservasRecebidas.Count();
                        var reservasPendentes = reservasRecebidas.Count(r => r.Estado == "Pendente");
                        var reservasAtivas = reservasRecebidas.Count(r => r.Estado == "Ativa");
                        var reservasExpiradas = reservasRecebidas.Count(r => r.Estado == "Expirada");
                    }
                    <div class="anuncios-filter-tabs mb-4">
                        <button class="anuncios-filter-btn active" data-filter-reservas-vendedor="todas">
                            <i class="bi bi-grid-fill me-1"></i>Todas <span class="badge bg-primary ms-1">@totalReservasVendedor</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter-reservas-vendedor="pendente">
                            <i class="bi bi-clock-fill me-1"></i>Aguardam Confirmação <span class="badge bg-warning ms-1">@reservasPendentes</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter-reservas-vendedor="ativa">
                            <i class="bi bi-check-circle-fill me-1"></i>Ativas <span class="badge bg-success ms-1">@reservasAtivas</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter-reservas-vendedor="expirada">
                            <i class="bi bi-x-circle-fill me-1"></i>Expiradas <span class="badge bg-secondary ms-1">@reservasExpiradas</span>
                        </button>
                    </div>

                    <!-- Lista de Reservas -->
                    <div class="reservas-vendedor-list">
                        @if (reservasRecebidas.Any())
                        {
                            foreach (var reserva in reservasRecebidas)
                            {
                                var primeiraImagem = reserva.Anuncio?.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/no-image.jpg";
                                var borderClass = reserva.Estado == "Ativa" ? "border-success" : reserva.Estado == "Expirada" ? "border-secondary" : "border-warning";
                                var badgeClass = reserva.Estado == "Ativa" ? "bg-success" : reserva.Estado == "Expirada" ? "bg-secondary" : "bg-warning";
                                var tempoExpiracao = reserva.DataExpiracao.HasValue ? (reserva.DataExpiracao.Value - DateTime.Now).TotalHours : 0;

                                <div class="card shadow-sm @borderClass mb-3" data-status-reserva-vendedor="@reserva.Estado.ToLower()">
                                    <div class="card-body p-4">
                                        <div class="row g-3">
                                            <div class="col-auto">
                                                <img src="@primeiraImagem" alt="@reserva.Anuncio?.Titulo" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                            </div>
                                            <div class="col">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h5 class="mb-1 fw-bold">Reserva: @reserva.Anuncio?.Titulo</h5>
                                                        <p class="text-muted mb-2 small">Seu anúncio • Preço: @reserva.Anuncio?.Preco.ToString("N2")€</p>
                                                    </div>
                                                    <span class="badge @badgeClass fs-6">
                                                        <i class="bi bi-check-circle-fill me-1"></i>@reserva.Estado
                                                    </span>
                                                </div>

                                                <div class="row g-3 mb-3">
                                                    <div class="col-md-3">
                                                        <p class="text-muted mb-0 small">Data da Reserva:</p>
                                                        <p class="mb-0 fw-semibold">@reserva.Data.ToString("dd/MM/yyyy HH:mm")</p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="text-muted mb-0 small">Expira em:</p>
                                                        <p class="mb-0 fw-semibold @(tempoExpiracao < 24 ? "text-danger" : "text-warning")">
                                                            <i class="bi bi-hourglass-split me-1"></i>@((int)tempoExpiracao) horas
                                                        </p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="text-muted mb-0 small">Sinal Recebido:</p>
                                                        <p class="mb-0 fw-bold text-success fs-5">@reserva.Anuncio.ValorSinal.ToString("N2")€</p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="text-muted mb-0 small">Preço Total:</p>
                                                        <p class="mb-0 fw-semibold">@reserva.Anuncio.Preco.ToString("N2")€</p>
                                                    </div>
                                                </div>

                                                @if (reserva.Estado == "Ativa")
                                                {
                                                    <div class="alert alert-warning mb-3 small">
                                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                                        <strong>Ação necessária:</strong> Entre em contacto com o comprador nas próximas 24h para acordar os detalhes da venda.
                                                    </div>
                                                }

                                                <div class="reserva-comprador mb-3 p-3 bg-light rounded">
                                                    <h6 class="mb-2 small fw-bold">
                                                        <i class="bi bi-person-badge me-1"></i>Comprador
                                                    </h6>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="d-flex align-items-center">
                                                            @if (!string.IsNullOrEmpty(reserva.Comprador?.ImagemPerfil))
                                                            {
                                                                <img src="@reserva.Comprador.ImagemPerfil" class="rounded-circle me-3" alt="@reserva.Comprador.Nome" style="width: 50px; height: 50px; object-fit: cover;">
                                                            }
                                                            else
                                                            {
                                                                <div class="rounded-circle me-3 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                    @(reserva.Comprador?.Nome?.Substring(0, 1).ToUpper() ?? "?")
                                                                </div>
                                                            }
                                                            <div>
                                                                <p class="mb-0 fw-semibold">@reserva.Comprador?.Nome</p>
                                                                <p class="mb-0 small text-muted">
                                                                    <i class="bi bi-envelope me-1"></i>@reserva.Comprador?.Email
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="d-flex gap-2">
                                                    <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@reserva.AnuncioId" class="btn btn-primary">
                                                        <i class="bi bi-eye me-1"></i>Ver Anúncio
                                                    </a>
                                                    <a href="mailto:@reserva.Comprador?.Email" class="btn btn-success">
                                                        <i class="bi bi-envelope-fill me-1"></i>Contactar Comprador
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <!-- Estado Vazio -->
                            <div class="reservas-vendedor-empty text-center py-5">
                                <div class="mb-4">
                                    <i class="bi bi-bookmark-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                                </div>
                                <h4 class="text-muted mb-2">Sem reservas recebidas</h4>
                                <p class="text-muted mb-4">Quando alguém reservar um dos seus veículos, aparecerá aqui</p>
                                <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                    <i class="bi bi-grid-3x3-gap me-2"></i>Ver Meus Anúncios
                                </a>
                            </div>
                        }
                    </div>
                </div>

                    var visitasRecebidas = ViewBag.VisitasRecebidas as List<Marketplace.Models.Visita> ?? new List<Marketplace.Models.Visita>();
                    var visitasAgendadas = ViewBag.VisitasAgendadas as List<Marketplace.Models.Visita> ?? new List<Marketplace.Models.Visita>();

                    <!-- Aba: Visitas Agendadas Vendedor (para Vendedores) -->
                <div class="tab-pane fade" id="visitas-agendadas-vendedor">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-calendar-event text-info me-2"></i>Minhas Visitas
                            </h3>
                            <p class="text-muted mb-0">Gerir visitas recebidas e agendadas</p>
                        </div>
                        <div class="visitas-vendedor-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-primary fw-bold">@visitasRecebidas.Count</div>
                                <div class="stat-label text-muted small">Recebidas</div>
                            </div>
                            <div class="stat-item text-center">
                                <div class="stat-value text-info fw-bold">@visitasAgendadas.Count</div>
                                <div class="stat-label text-muted small">Agendadas</div>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-abas para separar Visitas Recebidas e Agendadas -->
                    <ul class="nav nav-pills mb-4" id="visitasVendedorTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active visitas-tab-btn" id="visitas-recebidas-tab" data-bs-toggle="pill" data-bs-target="#visitas-recebidas" type="button" role="tab">
                                <i class="bi bi-inbox me-2"></i>Visitas aos Meus Anúncios
                                <span class="badge ms-2 count-badge">@visitasRecebidas.Count</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link visitas-tab-btn" id="visitas-agendadas-tab" data-bs-toggle="pill" data-bs-target="#visitas-agendadas-por-mim" type="button" role="tab">
                                <i class="bi bi-calendar-check me-2"></i>Visitas que Agendei
                                <span class="badge ms-2 count-badge">@visitasAgendadas.Count</span>
                            </button>
                        </li>
                    </ul>

                    <style>
                        .visitas-tab-btn {
                            font-weight: 600;
                            border: 2px solid #dee2e6;
                            transition: all 0.3s ease;
                        }

                        .visitas-tab-btn.active {
                            background-color: #0d6efd !important;
                            color: white !important;
                            border-color: #0d6efd !important;
                        }

                        .visitas-tab-btn:not(.active) {
                            background-color: white;
                            color: #212529 !important;
                            border-color: #dee2e6;
                        }

                        .visitas-tab-btn:not(.active):hover {
                            background-color: #e9ecef;
                            color: #0d6efd !important;
                            border-color: #0d6efd;
                        }

                        .visitas-tab-btn.active .count-badge {
                            background-color: white !important;
                            color: #0d6efd !important;
                        }

                        .visitas-tab-btn:not(.active) .count-badge {
                            background-color: #0d6efd !important;
                            color: white !important;
                        }
                    </style>

                    <div class="tab-content" id="visitasVendedorTabContent">

                        <!-- Aba 1: Visitas Recebidas (aos meus anúncios) -->
                        <div class="tab-pane fade show active" id="visitas-recebidas" role="tabpanel">
                    @if (visitasRecebidas.Any())
                    {
                        var totalRecebidas = visitasRecebidas.Count;
                        var pendentesRecebidas = visitasRecebidas.Count(v => v.Estado == "Pendente");
                        var confirmadasRecebidas = visitasRecebidas.Count(v => v.Estado == "Confirmada");
                        var concluidasRecebidas = visitasRecebidas.Count(v => v.Estado == "Concluída");

                        <!-- Filtros de Status - Horizontal -->
                        <div class="d-flex gap-2 mb-4 flex-wrap">
                            <button class="btn btn-outline-primary active" data-filter-visitas-recebidas="todas">
                                <i class="bi bi-grid-fill me-1"></i>Todas <span class="badge bg-primary ms-1">@totalRecebidas</span>
                            </button>
                            <button class="btn btn-outline-warning" data-filter-visitas-recebidas="Pendente">
                                <i class="bi bi-clock-fill me-1"></i>Aguardam Confirmação <span class="badge bg-warning ms-1">@pendentesRecebidas</span>
                            </button>
                            <button class="btn btn-outline-success" data-filter-visitas-recebidas="Confirmada">
                                <i class="bi bi-check-circle-fill me-1"></i>Confirmadas <span class="badge bg-success ms-1">@confirmadasRecebidas</span>
                            </button>
                            <button class="btn btn-outline-secondary" data-filter-visitas-recebidas="Concluída">
                                <i class="bi bi-archive-fill me-1"></i>Concluídas <span class="badge bg-secondary ms-1">@concluidasRecebidas</span>
                            </button>
                        </div>

                        <!-- Lista de Visitas Recebidas -->
                        <div class="visitas-recebidas-list">
                            @foreach (var visita in visitasRecebidas)
                            {
                                var anuncio = visita.Anuncio;
                                var imagemPrincipal = anuncio.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/default-car.jpg";
                                var marcaModelo = $"{anuncio.Marca?.Nome} {anuncio.Modelo?.Nome}";
                                var visitaRecebidaBadge = visita.Estado switch
                                {
                                    "Confirmada" => "bg-success",
                                    "Pendente" => "bg-warning text-dark",
                                    "Concluída" => "bg-secondary",
                                    "Cancelada" => "bg-danger",
                                    _ => "bg-info"
                                };
                                var borderClass = visita.Estado switch
                                {
                                    "Confirmada" => "border-success",
                                    "Pendente" => "border-warning",
                                    "Concluída" => "border-secondary",
                                    "Cancelada" => "border-danger",
                                    _ => "border-info"
                                };

                                <div class="card shadow-sm @borderClass mb-3" data-status-visita-recebida="@visita.Estado">
                                    <div class="card-body p-4">
                                        <div class="row g-3">
                                            <div class="col-auto">
                                                <img src="@imagemPrincipal" alt="@anuncio.Titulo" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                            </div>
                                            <div class="col">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h5 class="mb-1 fw-bold">Visita: @anuncio.Titulo</h5>
                                                        <p class="text-muted mb-2 small">
                                                            Seu anúncio • @marcaModelo • Preço: @anuncio.Preco.ToString("N0")€
                                                        </p>
                                                    </div>
                                                    <span class="badge @visitaRecebidaBadge fs-6">
                                                        @if (visita.Estado == "Confirmada")
                                                        {
                                                            <i class="bi bi-check-circle-fill me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Pendente")
                                                        {
                                                            <i class="bi bi-clock-fill me-1"></i><text>Aguarda Confirmação</text>
                                                        }
                                                        else if (visita.Estado == "Concluída")
                                                        {
                                                            <i class="bi bi-check-all me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Cancelada")
                                                        {
                                                            <i class="bi bi-x-circle-fill me-1"></i>
                                                        }
                                                        @if (visita.Estado != "Pendente")
                                                        {
                                                            @visita.Estado
                                                        }
                                                    </span>
                                                </div>

                                                <div class="row g-3 mb-3">
                                                    <div class="col-md-4">
                                                        <p class="text-muted mb-0 small">@(visita.Estado == "Pendente" ? "Data Solicitada:" : "Data e Hora:")</p>
                                                        <p class="mb-0 fw-bold @(visita.Estado == "Confirmada" ? "text-success" : "text-primary")">
                                                            <i class="bi bi-calendar-event me-1"></i>@visita.Data.ToString("dd/MM/yyyy 'às' HH:mm")
                                                        </p>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                    {
                                                        <div class="col-md-8">
                                                            <p class="text-muted mb-0 small">Local @(visita.Estado == "Pendente" ? "Sugerido" : ""):</p>
                                                            <p class="mb-0 fw-semibold">@anuncio.Localizacao</p>
                                                        </div>
                                                    }
                                                </div>

                                                @if (visita.Estado == "Pendente")
                                                {
                                                    <div class="alert alert-warning mb-3 small">
                                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                                        <strong>Ação necessária:</strong> Confirme ou proponha uma data alternativa para a visita.
                                                    </div>
                                                }
                                                else if (visita.Estado == "Confirmada")
                                                {
                                                    <div class="alert alert-success mb-3 small">
                                                        <i class="bi bi-check-circle-fill me-2"></i>
                                                        <strong>Visita confirmada.</strong> Prepare toda a documentação do veículo e esteja disponível no local combinado.
                                                    </div>
                                                }

                                                <div class="visita-comprador-info mb-3 p-3 bg-light rounded">
                                                    <h6 class="mb-2 small fw-bold">
                                                        <i class="bi bi-person-badge me-1"></i>Interessado
                                                    </h6>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="d-flex align-items-center">
                                                            @if (!string.IsNullOrEmpty(visita.Comprador?.ImagemPerfil))
                                                            {
                                                                <img src="@visita.Comprador.ImagemPerfil" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="@visita.Comprador.Nome">
                                                            }
                                                            else
                                                            {
                                                                <div class="rounded-circle me-3 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                    <i class="bi bi-person-fill fs-4"></i>
                                                                </div>
                                                            }
                                                            <div>
                                                                <p class="mb-0 fw-semibold">@visita.Comprador?.Nome</p>
                                                                <p class="mb-0 small text-muted">
                                                                    @if (!string.IsNullOrEmpty(visita.Comprador?.Email))
                                                                    {
                                                                        <i class="bi bi-envelope me-1"></i>@visita.Comprador.Email
                                                                    }
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(visita.Observacoes))
                                                    {
                                                        <div class="mt-2 p-2 bg-white rounded border">
                                                            <p class="mb-0 small"><strong>Observações:</strong></p>
                                                            <p class="mb-0 small text-muted">"@visita.Observacoes"</p>
                                                        </div>
                                                    }
                                                </div>

                                                <div class="d-flex gap-2 flex-wrap">
                                                    <a asp-controller="Visitas" asp-action="Details" asp-route-id="@visita.Id" class="btn btn-sm btn-info text-white">
                                                        <i class="bi bi-eye me-1"></i>Ver Detalhes
                                                    </a>
                                                    <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-car-front me-1"></i>Ver Anúncio
                                                    </a>
                                                    @if (visita.Estado == "Pendente")
                                                    {
                                                        <form asp-controller="Visitas" asp-action="Confirmar" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <button type="submit" class="btn btn-sm btn-success">
                                                                <i class="bi bi-check-circle-fill me-1"></i>Confirmar Visita
                                                            </button>
                                                        </form>
                                                        <a asp-controller="Visitas" asp-action="Edit" asp-route-id="@visita.Id" class="btn btn-sm btn-outline-info">
                                                            <i class="bi bi-calendar-x me-1"></i>Propor Outra Data
                                                        </a>
                                                        <form asp-controller="Visitas" asp-action="Cancelar" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja recusar esta visita?')">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <input type="hidden" name="motivo" value="Recusado pelo vendedor" />
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                <i class="bi bi-x-circle me-1"></i>Recusar
                                                            </button>
                                                        </form>
                                                    }
                                                    else if (visita.Estado == "Confirmada")
                                                    {
                                                        <a asp-controller="Visitas" asp-action="Edit" asp-route-id="@visita.Id" class="btn btn-sm btn-outline-warning">
                                                            <i class="bi bi-calendar-x me-1"></i>Remarcar
                                                        </a>
                                                        <form asp-controller="Visitas" asp-action="Concluir" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <button type="submit" class="btn btn-sm btn-outline-success">
                                                                <i class="bi bi-check-all me-1"></i>Marcar como Concluída
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Estado Vazio -->
                        <div class="visitas-recebidas-empty text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                            </div>
                            <h4 class="text-muted mb-2">Sem visitas recebidas</h4>
                            <p class="text-muted mb-4">Quando alguém agendar uma visita aos seus anúncios, aparecerá aqui</p>
                            <a href="#meus-anuncios" class="btn btn-primary perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-grid-3x3-gap me-2"></i>Ver Meus Anúncios
                            </a>
                        </div>
                    }
                        </div>

                        <!-- Aba 2: Visitas que Agendei (como comprador) -->
                        <div class="tab-pane fade" id="visitas-agendadas-por-mim" role="tabpanel">
                    @if (visitasAgendadas.Any())
                    {
                        var totalAgendadas = visitasAgendadas.Count;
                        var pendentesAgendadas = visitasAgendadas.Count(v => v.Estado == "Pendente");
                        var confirmadasAgendadas = visitasAgendadas.Count(v => v.Estado == "Confirmada");
                        var concluidasAgendadas = visitasAgendadas.Count(v => v.Estado == "Concluída");

                        <!-- Filtros de Status - Horizontal -->
                        <div class="d-flex gap-2 mb-4 flex-wrap">
                            <button class="btn btn-outline-primary active" data-filter-visitas-agendadas="todas">
                                <i class="bi bi-grid-fill me-1"></i>Todas <span class="badge bg-primary ms-1">@totalAgendadas</span>
                            </button>
                            <button class="btn btn-outline-warning" data-filter-visitas-agendadas="Pendente">
                                <i class="bi bi-clock-fill me-1"></i>Pendentes <span class="badge bg-warning ms-1">@pendentesAgendadas</span>
                            </button>
                            <button class="btn btn-outline-success" data-filter-visitas-agendadas="Confirmada">
                                <i class="bi bi-check-circle-fill me-1"></i>Confirmadas <span class="badge bg-success ms-1">@confirmadasAgendadas</span>
                            </button>
                            <button class="btn btn-outline-secondary" data-filter-visitas-agendadas="Concluída">
                                <i class="bi bi-archive-fill me-1"></i>Concluídas <span class="badge bg-secondary ms-1">@concluidasAgendadas</span>
                            </button>
                        </div>

                        <!-- Lista de Visitas Agendadas por Mim -->
                        <div class="visitas-agendadas-list">
                            @foreach (var visita in visitasAgendadas)
                            {
                                var anuncio = visita.Anuncio;
                                var imagemPrincipal = anuncio.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/default-car.jpg";
                                var marcaModelo = $"{anuncio.Marca?.Nome} {anuncio.Modelo?.Nome}";
                                var visitaAgendadaBadge = visita.Estado switch
                                {
                                    "Confirmada" => "bg-success",
                                    "Pendente" => "bg-warning text-dark",
                                    "Concluída" => "bg-secondary",
                                    "Cancelada" => "bg-danger",
                                    _ => "bg-info"
                                };
                                var borderClass = visita.Estado switch
                                {
                                    "Confirmada" => "border-success",
                                    "Pendente" => "border-warning",
                                    "Concluída" => "border-secondary",
                                    "Cancelada" => "border-danger",
                                    _ => "border-info"
                                };

                                <div class="card shadow-sm @borderClass mb-3" data-status-visita-agendada="@visita.Estado">
                                    <div class="card-body p-4">
                                        <div class="row g-3">
                                            <div class="col-auto">
                                                <img src="@imagemPrincipal" alt="@anuncio.Titulo" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                            </div>
                                            <div class="col">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h5 class="mb-1 fw-bold">@anuncio.Titulo</h5>
                                                        <p class="text-muted mb-2 small">
                                                            @marcaModelo • Preço: @anuncio.Preco.ToString("N0")€
                                                        </p>
                                                    </div>
                                                    <span class="badge @visitaAgendadaBadge fs-6">
                                                        @if (visita.Estado == "Confirmada")
                                                        {
                                                            <i class="bi bi-check-circle-fill me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Pendente")
                                                        {
                                                            <i class="bi bi-clock-fill me-1"></i><text>Aguarda Confirmação</text>
                                                        }
                                                        else if (visita.Estado == "Concluída")
                                                        {
                                                            <i class="bi bi-check-all me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Cancelada")
                                                        {
                                                            <i class="bi bi-x-circle-fill me-1"></i>
                                                        }
                                                        @if (visita.Estado != "Pendente")
                                                        {
                                                            @visita.Estado
                                                        }
                                                    </span>
                                                </div>

                                                <div class="row g-3 mb-3">
                                                    <div class="col-md-4">
                                                        <p class="text-muted mb-0 small">Data e Hora:</p>
                                                        <p class="mb-0 fw-bold @(visita.Estado == "Confirmada" ? "text-success" : "text-primary")">
                                                            <i class="bi bi-calendar-event me-1"></i>@visita.Data.ToString("dd/MM/yyyy 'às' HH:mm")
                                                        </p>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                    {
                                                        <div class="col-md-8">
                                                            <p class="text-muted mb-0 small">Local:</p>
                                                            <p class="mb-0 fw-semibold">@anuncio.Localizacao</p>
                                                        </div>
                                                    }
                                                </div>

                                                @if (visita.Estado == "Pendente")
                                                {
                                                    <div class="alert alert-warning mb-3 small">
                                                        <i class="bi bi-clock me-2"></i>
                                                        <strong>Aguardando confirmação</strong> do vendedor.
                                                    </div>
                                                }
                                                else if (visita.Estado == "Confirmada")
                                                {
                                                    <div class="alert alert-success mb-3 small">
                                                        <i class="bi bi-check-circle-fill me-2"></i>
                                                        <strong>Visita confirmada!</strong> Compareça no local e horário combinados.
                                                    </div>
                                                }

                                                <div class="visita-vendedor-info mb-3 p-3 bg-light rounded">
                                                    <h6 class="mb-2 small fw-bold">
                                                        <i class="bi bi-person-badge me-1"></i>Vendedor
                                                    </h6>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="d-flex align-items-center">
                                                            @if (!string.IsNullOrEmpty(visita.Vendedor?.ImagemPerfil))
                                                            {
                                                                <img src="@visita.Vendedor.ImagemPerfil" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="@visita.Vendedor.Nome">
                                                            }
                                                            else
                                                            {
                                                                <div class="rounded-circle me-3 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                    <i class="bi bi-person-fill fs-4"></i>
                                                                </div>
                                                            }
                                                            <div>
                                                                <p class="mb-0 fw-semibold">@visita.Vendedor?.Nome</p>
                                                                <p class="mb-0 small text-muted">
                                                                    @if (!string.IsNullOrEmpty(visita.Vendedor?.Email))
                                                                    {
                                                                        <i class="bi bi-envelope me-1"></i>@visita.Vendedor.Email
                                                                    }
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(visita.Observacoes))
                                                    {
                                                        <div class="mt-2 p-2 bg-white rounded border">
                                                            <p class="mb-0 small"><strong>Minhas Observações:</strong></p>
                                                            <p class="mb-0 small text-muted">"@visita.Observacoes"</p>
                                                        </div>
                                                    }
                                                </div>

                                                <div class="d-flex gap-2 flex-wrap">
                                                    <a asp-controller="Visitas" asp-action="Details" asp-route-id="@visita.Id" class="btn btn-sm btn-info text-white">
                                                        <i class="bi bi-eye me-1"></i>Ver Detalhes
                                                    </a>
                                                    <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-car-front me-1"></i>Ver Anúncio
                                                    </a>
                                                    @if (visita.Estado == "Pendente" || visita.Estado == "Confirmada")
                                                    {
                                                        <a asp-controller="Visitas" asp-action="Edit" asp-route-id="@visita.Id" class="btn btn-sm btn-warning">
                                                            <i class="bi bi-pencil me-1"></i>Editar
                                                        </a>
                                                        <form asp-controller="Visitas" asp-action="Cancelar" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja cancelar esta visita?')">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <input type="hidden" name="motivo" value="Cancelado pelo interessado" />
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                <i class="bi bi-x-circle me-1"></i>Cancelar
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Estado Vazio -->
                        <div class="visitas-agendadas-empty text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                            </div>
                            <h4 class="text-muted mb-2">Sem visitas agendadas</h4>
                            <p class="text-muted mb-4">Explore anúncios de outros vendedores e agende visitas</p>
                            <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Explorar Anúncios
                            </a>
                        </div>
                    }
                        </div>
                    </div>
                </div>

                <!-- Aba: Disponibilidade (para Vendedores) -->
                <div class="tab-pane fade" id="disponibilidade">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-clock-history text-primary me-2"></i>Horários de Disponibilidade
                            </h3>
                            <p class="text-muted mb-0">Configure os dias e horários em que está disponível para receber visitas</p>
                        </div>
                        <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAdicionarDisponibilidade">
                            <i class="bi bi-plus-circle me-2"></i>Adicionar Horário
                        </a>
                    </div>

                    <!-- Alert Informativo -->
                    <div class="alert alert-info border-info mb-4">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Como funciona?</strong> Os compradores só poderão agendar visitas nos dias e horários que você definir aqui.
                        Certifique-se de manter sua disponibilidade atualizada.
                    </div>

                    @{
                        var disponibilidades = ViewBag.Disponibilidades as List<Marketplace.Models.DisponibilidadeVendedor> ?? new List<Marketplace.Models.DisponibilidadeVendedor>();
                    }

                    @if (disponibilidades.Any())
                    {
                        <!-- Tabela de Disponibilidades -->
                        <div class="card shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th class="border-0 ps-4">Dia da Semana</th>
                                                <th class="border-0">Horário</th>
                                                <th class="border-0">Intervalo</th>
                                                <th class="border-0">Estado</th>
                                                <th class="border-0 text-end pe-4">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in disponibilidades.OrderBy(d => d.DiaSemana).ThenBy(d => d.HoraInicio))
                                            {
                                                <tr>
                                                    <td class="ps-4 align-middle">
                                                        <span class="fw-semibold">@item.NomeDia</span>
                                                    </td>
                                                    <td class="align-middle">
                                                        <i class="bi bi-clock text-primary me-1"></i>
                                                        @item.HoraInicio.ToString(@"hh\:mm") - @item.HoraFim.ToString(@"hh\:mm")
                                                    </td>
                                                    <td class="align-middle">
                                                        @item.IntervaloMinutos min
                                                    </td>
                                                    <td class="align-middle">
                                                        @if (item.Ativo)
                                                        {
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-check-circle me-1"></i>Ativo
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">
                                                                <i class="bi bi-x-circle me-1"></i>Inativo
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="text-end pe-4 align-middle">
                                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                                onclick="editarDisponibilidade(@item.Id, '@item.NomeDia', '@item.DiaSemana', '@item.HoraInicio.ToString(@"hh\:mm")', '@item.HoraFim.ToString(@"hh\:mm")', @item.IntervaloMinutos, @(item.Ativo ? "true" : "false"), @item.VendedorId, '@item.DataCriacao.ToString("o")')">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <form asp-controller="Disponibilidade" asp-action="Delete" asp-route-id="@item.Id" method="post" class="d-inline"
                                                              onsubmit="return confirm('Tem certeza que deseja remover esta disponibilidade?');">
                                                            @Html.AntiForgeryToken()
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Dicas -->
                        <div class="card shadow-sm border-0 bg-light mt-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-lightbulb text-warning me-2"></i>Dicas
                                </h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
                                            <small>Configure horários regulares para facilitar o agendamento</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
                                            <small>Deixe intervalos suficientes entre visitas (recomendado: 60 min)</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
                                            <small>Desative temporariamente horários se não estiver disponível</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex">
                                            <i class="bi bi-check-circle-fill text-success me-2 flex-shrink-0"></i>
                                            <small>Mantenha sua disponibilidade atualizada para evitar conflitos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Estado Vazio -->
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-calendar-x text-muted" style="font-size: 5rem;"></i>
                            </div>
                            <h3 class="h4 fw-bold mb-3">Nenhuma Disponibilidade Configurada</h3>
                            <p class="text-muted mb-4">
                                Configure seus horários de disponibilidade para que os compradores possam agendar visitas
                                apenas nos dias e horários que lhe são convenientes.
                            </p>
                            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalAdicionarDisponibilidade">
                                <i class="bi bi-plus-circle me-2"></i>Adicionar Primeiro Horário
                            </button>
                        </div>
                    }
                </div>

                <!-- Aba: Dados Bancários (para Vendedores) -->
                <div class="tab-pane fade" id="dados-bancarios">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-bank text-primary me-2"></i>Dados Bancários
                            </h3>
                            <p class="text-muted mb-0">Configure os seus dados de pagamento para receber transferências</p>
                        </div>
                    </div>

                    <!-- Alert Informativo -->
                    <div class="alert alert-info border-0 mb-4">
                        <div class="d-flex">
                            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                            <div>
                                <h6 class="mb-2 fw-bold">Porquê adicionar dados bancários?</h6>
                                <p class="mb-2">
                                    Quando um comprador reservar um dos seus veículos, ele precisará fazer uma transferência bancária do sinal.
                                    Configure aqui os seus dados para facilitar o processo de pagamento.
                                </p>
                                <ul class="mb-0 ps-3">
                                    <li>Receba sinais de reserva diretamente na sua conta</li>
                                    <li>Os seus dados ficam seguros e privados</li>
                                    <li>Partilhados apenas com compradores que reservarem</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Formulário de Dados Bancários -->
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <form id="formDadosBancarios">
                                <div class="row g-4">
                                    <!-- NIB -->
                                    <div class="col-12">
                                        <label for="nib" class="form-label fw-semibold">
                                            <i class="bi bi-credit-card-2-front text-primary me-2"></i>NIB (Número de Identificação Bancária)
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="nib"
                                               placeholder="0000 0000 0000 0000 0000 000"
                                               maxlength="25"
                                               pattern="[0-9 ]+"
                                               value="1234 5678 9012 3456 7890 123"
                                               required>
                                        <div class="form-text">
                                            <i class="bi bi-shield-check text-success me-1"></i>
                                            O NIB é composto por 21 dígitos
                                        </div>
                                    </div>

                                    <!-- IBAN -->
                                    <div class="col-12">
                                        <label for="iban" class="form-label fw-semibold">
                                            <i class="bi bi-bank text-primary me-2"></i>IBAN
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="iban"
                                               placeholder="PT50 0000 0000 0000 0000 0000 0"
                                               maxlength="29"
                                               value="PT50 1234 5678 9012 3456 7890 1"
                                               required>
                                        <div class="form-text">
                                            <i class="bi bi-globe me-1"></i>
                                            Formato internacional (PT + 23 dígitos)
                                        </div>
                                    </div>

                                    <!-- Nome do Titular -->
                                    <div class="col-md-6">
                                        <label for="titularConta" class="form-label fw-semibold">
                                            <i class="bi bi-person-badge text-primary me-2"></i>Nome do Titular
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="titularConta"
                                               placeholder="Nome completo"
                                               value="João Duarte Silva"
                                               required>
                                        <div class="form-text">Deve corresponder ao nome registado no banco</div>
                                    </div>

                                    <!-- Banco -->
                                    <div class="col-md-6">
                                        <label for="banco" class="form-label fw-semibold">
                                            <i class="bi bi-building text-primary me-2"></i>Banco
                                            <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select form-select-lg" id="banco" required>
                                            <option value="">Selecione o banco...</option>
                                            <option value="caixa" selected>Caixa Geral de Depósitos</option>
                                            <option value="millennium">Millennium BCP</option>
                                            <option value="santander">Santander Totta</option>
                                            <option value="novo">Novo Banco</option>
                                            <option value="montepio">Montepio</option>
                                            <option value="bpi">Banco BPI</option>
                                            <option value="activobank">ActivoBank</option>
                                            <option value="bankinter">Bankinter</option>
                                            <option value="abanca">Abanca</option>
                                            <option value="outro">Outro</option>
                                        </select>
                                    </div>

                                    <!-- Método de Pagamento Preferencial -->
                                    <div class="col-12">
                                        <label class="form-label fw-semibold">
                                            <i class="bi bi-wallet2 text-primary me-2"></i>Métodos de Pagamento Aceites
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="card h-100 border-2 payment-method-card">
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="metodo-transferencia" checked>
                                                            <label class="form-check-label w-100" for="metodo-transferencia">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="bi bi-bank2 fs-3 text-primary me-3"></i>
                                                                    <div>
                                                                        <strong class="d-block">Transferência Bancária</strong>
                                                                        <small class="text-muted">Pagamento direto para a sua conta</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card h-100 border-2 payment-method-card">
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="metodo-mbway" checked>
                                                            <label class="form-check-label w-100" for="metodo-mbway">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="bi bi-phone fs-3 text-success me-3"></i>
                                                                    <div>
                                                                        <strong class="d-block">MB WAY</strong>
                                                                        <small class="text-muted">Pagamento instantâneo via telemóvel</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card h-100 border-2 payment-method-card">
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="metodo-multibanco">
                                                            <label class="form-check-label w-100" for="metodo-multibanco">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="bi bi-receipt fs-3 text-info me-3"></i>
                                                                    <div>
                                                                        <strong class="d-block">Referência Multibanco</strong>
                                                                        <small class="text-muted">Pagamento em ATM ou homebanking</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card h-100 border-2 payment-method-card">
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="metodo-dinheiro">
                                                            <label class="form-check-label w-100" for="metodo-dinheiro">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="bi bi-cash-stack fs-3 text-warning me-3"></i>
                                                                    <div>
                                                                        <strong class="d-block">Dinheiro</strong>
                                                                        <small class="text-muted">Pagamento em mãos na entrega</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- MB WAY (Condicional) -->
                                    <div class="col-md-6" id="campo-mbway" style="display: none;">
                                        <label for="numeroMbway" class="form-label fw-semibold">
                                            <i class="bi bi-phone-fill text-primary me-2"></i>Número MB WAY
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text">
                                                <i class="bi bi-phone"></i>
                                            </span>
                                            <input type="tel" class="form-control" id="numeroMbway"
                                                   placeholder="+351 912 345 678"
                                                   value="+351 912 345 678">
                                        </div>
                                    </div>

                                    <!-- Notas Adicionais -->
                                    <div class="col-12">
                                        <label for="notasBancarias" class="form-label fw-semibold">
                                            <i class="bi bi-journal-text text-primary me-2"></i>Notas Adicionais
                                        </label>
                                        <textarea class="form-control" id="notasBancarias" rows="3"
                                            placeholder="Informações adicionais sobre pagamentos, horários de disponibilidade, etc.">Disponível para receber pagamentos de segunda a sexta, das 9h às 18h. Preferência por MB WAY para pagamentos mais rápidos.</textarea>
                                        <div class="form-text">Máximo 200 caracteres</div>
                                    </div>

                                    <!-- Botões de Ação -->
                                    <div class="col-12">
                                        <hr class="my-4">
                                        <div class="d-flex gap-3 justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary btn-lg px-4">
                                                <i class="bi bi-x-circle me-2"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                                <i class="bi bi-check-circle me-2"></i>Guardar Dados Bancários
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Card de Segurança -->
                    <div class="card border-0 bg-light mt-4">
                        <div class="card-body p-4">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-shield-lock-fill text-success me-2"></i>Segurança e Privacidade
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-lock-fill text-success fs-4 me-2"></i>
                                        <div>
                                            <strong class="d-block small">Dados Encriptados</strong>
                                            <small class="text-muted">Informações protegidas com criptografia SSL</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-eye-slash-fill text-success fs-4 me-2"></i>
                                        <div>
                                            <strong class="d-block small">Acesso Restrito</strong>
                                            <small class="text-muted">Apenas compradores confirmados veem seus dados</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-shield-check-fill text-success fs-4 me-2"></i>
                                        <div>
                                            <strong class="d-block small">Conformidade RGPD</strong>
                                            <small class="text-muted">Cumprimos todas as normas de proteção de dados</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                }

                <!-- Aba: Anúncios Favoritos (para Compradores e Vendedores) -->
                @{
                    var favoritos = ViewBag.MeusFavoritos as List<Marketplace.Models.AnuncioFav> ?? new List<Marketplace.Models.AnuncioFav>();
                    var favoritosCount = ViewBag.FavoritosCount ?? 0;
                    var mediaPreco = favoritos.Any() ? favoritos.Average(f => f.Anuncio.Preco) : 0;
                }
                @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                {
                    <div class="tab-pane fade" id="favoritos">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-heart-fill text-danger me-2"></i>Anúncios Favoritos
                            </h3>
                            <p class="text-muted mb-0">Os seus veículos guardados para consulta rápida</p>
                        </div>
                        <div class="favoritos-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-primary fw-bold" id="favoritos-count-perfil">@favoritosCount</div>
                                <div class="stat-label text-muted small">Favoritos</div>
                            </div>
                            @if (favoritos.Any())
                            {
                                <div class="stat-item text-center">
                                    <div class="stat-value text-success fw-bold">@mediaPreco.ToString("N0")€</div>
                                    <div class="stat-label text-muted small">Média de Preço</div>
                                </div>
                            }
                        </div>
                    </div>

                    @if (favoritos.Any())
                    {
                        <!-- Grid de Favoritos -->
                        <div class="favoritos-grid" id="favoritos-container-perfil">
                            @foreach (var favorito in favoritos)
                            {
                                var anuncio = favorito.Anuncio;
                                var imagemPrincipal = anuncio.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "/imagens/default-car.jpg";
                                var marcaModelo = $"{anuncio.Marca?.Nome} {anuncio.Modelo?.Nome}";

                                <div class="favorito-card card shadow-sm border-0 mb-3" data-favorito-id="@favorito.Id">
                                    <div class="card-body p-0">
                                        <div class="row g-0">
                                            <div class="col-md-5">
                                                <div class="favorito-image-wrapper">
                                                    <img src="@imagemPrincipal" alt="@anuncio.Titulo" class="favorito-image">
                                                    <button class="favorito-heart-btn active btn-favorito"
                                                            data-anuncio-id="@anuncio.Id"
                                                            title="Remover dos favoritos">
                                                        <i class="bi bi-heart-fill"></i>
                                                    </button>
                                                    @if (anuncio.Tipo != null)
                                                    {
                                                        <span class="favorito-badge badge-disponivel">
                                                            <i class="bi bi-check-circle-fill me-1"></i>@anuncio.Tipo.Nome
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="col-md-7">
                                                <div class="favorito-content p-4">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div>
                                                            <h5 class="favorito-title mb-1">@anuncio.Titulo</h5>
                                                            <p class="favorito-subtitle text-muted mb-0">@marcaModelo @(anuncio.Ano.HasValue ? "| " + anuncio.Ano : "")</p>
                                                        </div>
                                                        <div class="favorito-price-tag">
                                                            <span class="price-value">@anuncio.Preco.ToString("N0")€</span>
                                                        </div>
                                                    </div>

                                                    <div class="favorito-specs mt-3 mb-3">
                                                        @if (anuncio.Quilometragem.HasValue)
                                                        {
                                                            <div class="spec-item">
                                                                <i class="bi bi-speedometer2 text-primary"></i>
                                                                <span>@anuncio.Quilometragem.Value.ToString("N0") km</span>
                                                            </div>
                                                        }
                                                        @if (anuncio.Combustivel != null)
                                                        {
                                                            <div class="spec-item">
                                                                <i class="bi bi-fuel-pump text-primary"></i>
                                                                <span>@anuncio.Combustivel.Tipo</span>
                                                            </div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(anuncio.Caixa))
                                                        {
                                                            <div class="spec-item">
                                                                <i class="bi bi-gear text-primary"></i>
                                                                <span>@anuncio.Caixa</span>
                                                            </div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                        {
                                                            <div class="spec-item">
                                                                <i class="bi bi-geo-alt text-primary"></i>
                                                                <span>@anuncio.Localizacao</span>
                                                            </div>
                                                        }
                                                    </div>

                                                    <div class="favorito-actions d-flex gap-2">
                                                        <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-primary flex-grow-1">
                                                            <i class="bi bi-eye me-2"></i>Ver Detalhes
                                                        </a>
                                                        <button class="btn btn-outline-primary" title="Contactar Vendedor">
                                                            <i class="bi bi-chat-dots"></i>
                                                        </button>
                                                        <form asp-controller="Favoritos" asp-action="Remove" asp-route-id="@favorito.Id" method="post" class="d-inline remove-favorito-form-perfil">
                                                            <button type="submit" class="btn btn-outline-danger" title="Remover dos favoritos">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Estado Vazio (mostrar quando não houver favoritos) -->
                        <div class="favoritos-empty text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-heart" style="font-size: 4rem; color: #e2e8f0;"></i>
                            </div>
                            <h4 class="text-muted mb-2">Ainda não tem favoritos</h4>
                            <p class="text-muted mb-4">Guarde os anúncios que mais gosta para acesso rápido</p>
                            <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Explorar Anúncios
                            </a>
                        </div>
                    }
                    </div>
                }

                <!-- Aba: Marcas Favoritas (para Compradores e Vendedores) -->
                @{
                    var marcasFavoritas = ViewBag.MarcasFavoritas as List<Marketplace.Models.MarcasFav> ?? new List<Marketplace.Models.MarcasFav>();
                    var marcasFavoritasCount = ViewBag.MarcasFavoritasCount ?? 0;
                }
                @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                {
                    <div class="tab-pane fade" id="favoritos-marcas">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h3 class="mb-1 fw-bold">
                                    <i class="bi bi-tags-fill text-secondary me-2"></i>Marcas Favoritas
                                </h3>
                                <p class="text-muted mb-0">As suas marcas preferidas para acesso rápido</p>
                            </div>
                            <div class="favoritos-stats d-flex gap-3">
                                <div class="stat-item text-center">
                                    <div class="stat-value text-secondary fw-bold">@marcasFavoritasCount</div>
                                    <div class="stat-label text-muted small">Marcas</div>
                                </div>
                                @if (marcasFavoritas.Any())
                                {
                                    <button type="button" class="btn btn-outline-primary btn-sm align-self-center" data-bs-toggle="modal" data-bs-target="#modalSelecionarMarcas">
                                        <i class="bi bi-plus-lg me-1"></i>Adicionar Nova
                                    </button>
                                }
                            </div>
                        </div>

                        @if (marcasFavoritas.Any())
                        {
                            <div class="row g-3">
                                @foreach (var fav in marcasFavoritas)
                                {
                                    <div class="col-md-4 col-sm-6">
                                        <div class="card shadow-sm h-100 border-0 hover-lift">
                                            <div class="card-body d-flex flex-column align-items-center justify-content-center p-4 text-center">
                                                <div class="mb-3">
                                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                                        <i class="bi bi-car-front-fill fs-1 text-secondary"></i>
                                                    </div>
                                                </div>
                                                <h5 class="fw-bold mb-3">@fav.Marca?.Nome</h5>
                                                <div class="d-flex gap-2 w-100">
                                                    <a href="@Url.Action("Index", "Anuncios", new { marcaId = fav.MarcaId })" class="btn btn-primary btn-sm flex-grow-1">
                                                        Ver Anúncios
                                                    </a>
                                                    <form asp-controller="Favoritos" asp-action="RemoveMarca" asp-route-id="@fav.Id" method="post" onsubmit="return confirm('Remover esta marca dos favoritos?');">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" title="Remover">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                <div class="col-md-4 col-sm-6">
                                    <a href="#" class="card shadow-sm h-100 border-2 border-dashed border-secondary bg-light text-decoration-none d-flex align-items-center justify-content-center hover-lift" style="min-height: 200px;" data-bs-toggle="modal" data-bs-target="#modalSelecionarMarcas">
                                        <div class="text-center text-secondary">
                                            <i class="bi bi-plus-circle fs-1 mb-2"></i>
                                            <h6 class="fw-bold m-0">Adicionar Marca</h6>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <div class="mb-4">
                                    <i class="bi bi-tags text-muted" style="font-size: 4rem;"></i>
                                </div>
                                <h4 class="text-muted mb-2">Ainda não tem marcas favoritas</h4>
                                <p class="text-muted mb-4">Adicione marcas para ver rapidamente os novos anúncios</p>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSelecionarMarcas">
                                    <i class="bi bi-search me-2"></i>Explorar Marcas
                                </button>
                            </div>
                        }
                    </div>
                }

                <!-- Aba: Minhas Reservas (para Compradores) -->
                @if (User.IsInRole("Comprador"))
                {
                    <div class="tab-pane fade" id="minhas-reservas">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-bookmark-star-fill text-warning me-2"></i>Minhas Reservas
                            </h3>
                            <p class="text-muted mb-0">Gerir as suas reservas de veículos</p>
                        </div>
                        <div class="reservas-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-warning fw-bold">@ViewBag.ReservasAtivasComprador</div>
                                <div class="stat-label text-muted small">Ativa</div>
                            </div>
                            <div class="stat-item text-center">
                                <div class="stat-value text-muted fw-bold">@ViewBag.ReservasExpiradas</div>
                                <div class="stat-label text-muted small">Expiradas</div>
                            </div>
                        </div>
                    </div>

                    @{
                        var minhasReservas = ViewBag.MinhasReservas as IEnumerable<Marketplace.Models.Reserva> ?? Enumerable.Empty<Marketplace.Models.Reserva>();
                    }

                    <!-- Lista de Reservas -->
                    <div class="reservas-list">
                        @if (minhasReservas.Any())
                        {
                            foreach (var reserva in minhasReservas)
                            {
                                var primeiraImagem = reserva.Anuncio?.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/no-image.jpg";
                                var borderClass = reserva.Estado == "Ativa" ? "border-warning" : reserva.Estado == "Expirada" ? "border-secondary" : "border-success";
                                var badgeClass = reserva.Estado == "Ativa" ? "bg-warning text-dark" : reserva.Estado == "Expirada" ? "bg-secondary" : "bg-success";
                                var tempoExpiracao = reserva.DataExpiracao.HasValue ? (reserva.DataExpiracao.Value - DateTime.Now).TotalHours : 0;
                                var anuncioInfo = $"{reserva.Anuncio?.Ano} • {reserva.Anuncio?.Quilometragem:N0} km • {reserva.Anuncio?.Combustivel?.Tipo ?? "N/A"} • {reserva.Anuncio?.Caixa}";

                                <div class="card shadow-sm @borderClass mb-3">
                                    <div class="card-body p-4">
                                        <div class="row g-3">
                                            <div class="col-auto">
                                                <img src="@primeiraImagem" alt="@reserva.Anuncio?.Titulo" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                            </div>
                                            <div class="col">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h5 class="mb-1 fw-bold">@reserva.Anuncio?.Titulo</h5>
                                                        <p class="text-muted mb-2 small">@anuncioInfo</p>
                                                    </div>
                                                    <span class="badge @badgeClass fs-6">
                                                        <i class="bi bi-@(reserva.Estado == "Ativa" ? "clock-fill" : reserva.Estado == "Expirada" ? "x-circle-fill" : "check-circle-fill") me-1"></i>@reserva.Estado
                                                    </span>
                                                </div>

                                                <div class="row g-3 mb-3">
                                                    <div class="col-md-3">
                                                        <p class="text-muted mb-0 small">Data da Reserva:</p>
                                                        <p class="mb-0 fw-semibold">@reserva.Data.ToString("dd/MM/yyyy HH:mm")</p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="text-muted mb-0 small">Expira em:</p>
                                                        <p class="mb-0 fw-semibold @(tempoExpiracao < 24 ? "text-danger" : tempoExpiracao < 48 ? "text-warning" : "text-success")">
                                                            <i class="bi bi-hourglass-split me-1"></i>@((int)tempoExpiracao) horas
                                                        </p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="text-muted mb-0 small">Sinal Pago:</p>
                                                        <p class="mb-0 fw-semibold text-success">@reserva.Anuncio.ValorSinal.ToString("N2")€</p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="text-muted mb-0 small">Preço Total:</p>
                                                        <p class="mb-0 fw-bold text-primary fs-5">@reserva.Anuncio?.Preco.ToString("N2")€</p>
                                                    </div>
                                                </div>

                                                @if (reserva.Estado == "Ativa" && reserva.DataExpiracao.HasValue)
                                                {
                                                    <div class="alert alert-info mb-3 small">
                                                        <i class="bi bi-info-circle-fill me-2"></i>
                                                        <strong>Prioridade garantida até @reserva.DataExpiracao.Value.ToString("dd/MM/yyyy HH:mm").</strong> Entre em contacto com o vendedor para finalizar a compra.
                                                    </div>
                                                }

                                                <div class="reserva-vendedor mb-3 p-3 bg-light rounded">
                                                    <h6 class="mb-2 small fw-bold">
                                                        <i class="bi bi-person-badge me-1"></i>Vendedor
                                                    </h6>
                                                    <div class="d-flex align-items-center">
                                                        @if (!string.IsNullOrEmpty(reserva.Anuncio?.Vendedor?.ImagemPerfil))
                                                        {
                                                            <img src="@reserva.Anuncio.Vendedor.ImagemPerfil" class="rounded-circle me-3" alt="@reserva.Anuncio.Vendedor.Nome" style="width: 50px; height: 50px; object-fit: cover;">
                                                        }
                                                        else
                                                        {
                                                            <div class="rounded-circle me-3 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                @(reserva.Anuncio?.Vendedor?.Nome?.Substring(0, 1).ToUpper() ?? "?")
                                                            </div>
                                                        }
                                                        <div>
                                                            <p class="mb-0 fw-semibold">@reserva.Anuncio?.Vendedor?.Nome</p>
                                                            <p class="mb-0 small text-muted">
                                                                <i class="bi bi-envelope me-1"></i>@reserva.Anuncio?.Vendedor?.Email
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="d-flex gap-2">
                                                    <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@reserva.AnuncioId" class="btn btn-primary">
                                                        <i class="bi bi-eye me-1"></i>Ver Anúncio
                                                    </a>
                                                    <a href="mailto:@reserva.Anuncio?.Vendedor?.Email" class="btn btn-success">
                                                        <i class="bi bi-chat-dots-fill me-1"></i>Contactar Vendedor
                                                    </a>
                                                    @if (reserva.Estado == "Ativa")
                                                    {
                                                        <button class="btn btn-outline-danger ms-auto" onclick="alert('Funcionalidade de cancelamento em desenvolvimento')">
                                                            <i class="bi bi-x-circle me-1"></i>Cancelar Reserva
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <!-- Estado Vazio -->
                            <div class="reservas-empty text-center py-5">
                                <div class="mb-4">
                                    <i class="bi bi-bookmark-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                                </div>
                                <h4 class="text-muted mb-2">Sem reservas ativas</h4>
                                <p class="text-muted mb-4">Quando reservar um veículo, ele aparecerá aqui</p>
                                <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>Explorar Anúncios
                                </a>
                            </div>
                        }
                    </div>
                </div>

                    var visitasComprador = ViewBag.MinhasVisitasComprador as List<Marketplace.Models.Visita> ?? new List<Marketplace.Models.Visita>();
                    var totalVisitas = visitasComprador.Count;
                    var visitasPendentes = visitasComprador.Count(v => v.Estado == "Pendente");
                    var visitasConfirmadas = visitasComprador.Count(v => v.Estado == "Confirmada");
                    var visitasConcluidas = visitasComprador.Count(v => v.Estado == "Concluída");
                    <!-- Aba: Minhas Visitas (para Compradores) -->
                <div class="tab-pane fade" id="minhas-visitas">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-calendar-check-fill text-info me-2"></i>Minhas Visitas
                            </h3>
                            <p class="text-muted mb-0">Visitas agendadas aos veículos</p>
                        </div>
                        <div class="visitas-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-info fw-bold">@totalVisitas</div>
                                <div class="stat-label text-muted small">Total</div>
                            </div>
                        </div>
                    </div>

                    @if (visitasComprador.Any())
                    {
                        <!-- Filtros de Status - Horizontal -->
                        <div class="d-flex gap-2 mb-4 flex-wrap">
                            <button class="btn btn-outline-primary active" data-filter-visitas="todas">
                                <i class="bi bi-grid-fill me-1"></i>Todas <span class="badge bg-primary ms-1">@totalVisitas</span>
                            </button>
                            <button class="btn btn-outline-warning" data-filter-visitas="Pendente">
                                <i class="bi bi-clock-fill me-1"></i>Pendentes <span class="badge bg-warning ms-1">@visitasPendentes</span>
                            </button>
                            <button class="btn btn-outline-success" data-filter-visitas="Confirmada">
                                <i class="bi bi-check-circle-fill me-1"></i>Confirmadas <span class="badge bg-success ms-1">@visitasConfirmadas</span>
                            </button>
                            <button class="btn btn-outline-secondary" data-filter-visitas="Concluída">
                                <i class="bi bi-archive-fill me-1"></i>Concluídas <span class="badge bg-secondary ms-1">@visitasConcluidas</span>
                            </button>
                        </div>

                        <!-- Lista de Visitas -->
                        <div class="visitas-list">
                            @foreach (var visita in visitasComprador)
                            {
                                var anuncio = visita.Anuncio;
                                var imagemPrincipal = anuncio.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/default-car.jpg";
                                var marcaModelo = $"{anuncio.Marca?.Nome} {anuncio.Modelo?.Nome}";
                                var minhaVisitaBadge = visita.Estado switch
                                {
                                    "Confirmada" => "bg-success",
                                    "Pendente" => "bg-warning",
                                    "Concluída" => "bg-secondary",
                                    "Cancelada" => "bg-danger",
                                    _ => "bg-info"
                                };
                                var borderClass = visita.Estado switch
                                {
                                    "Confirmada" => "border-success",
                                    "Pendente" => "border-warning",
                                    "Concluída" => "border-secondary",
                                    "Cancelada" => "border-danger",
                                    _ => "border-info"
                                };

                                <div class="card shadow-sm @borderClass mb-3" data-status-visita="@visita.Estado">
                                    <div class="card-body p-4">
                                        <div class="row g-3">
                                            <div class="col-auto">
                                                <img src="@imagemPrincipal" alt="@anuncio.Titulo" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                            </div>
                                            <div class="col">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h5 class="mb-1 fw-bold">@anuncio.Titulo</h5>
                                                        <p class="text-muted mb-2 small">
                                                            @marcaModelo
                                                            @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                            {
                                                                <span> • @anuncio.Localizacao</span>
                                                            }
                                                        </p>
                                                    </div>
                                                    <span class="badge @minhaVisitaBadge fs-6">
                                                        @if (visita.Estado == "Confirmada")
                                                        {
                                                            <i class="bi bi-check-circle-fill me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Pendente")
                                                        {
                                                            <i class="bi bi-clock-fill me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Concluída")
                                                        {
                                                            <i class="bi bi-check-all me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Cancelada")
                                                        {
                                                            <i class="bi bi-x-circle-fill me-1"></i>
                                                        }
                                                        @visita.Estado
                                                    </span>
                                                </div>

                                                <div class="row g-3 mb-3">
                                                    <div class="col-md-6">
                                                        <p class="text-muted mb-0 small">Data e Hora:</p>
                                                        <p class="mb-0 fw-bold text-primary">
                                                            <i class="bi bi-calendar-event me-1"></i>@visita.Data.ToString("dd/MM/yyyy 'às' HH:mm")
                                                        </p>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                    {
                                                        <div class="col-md-6">
                                                            <p class="text-muted mb-0 small">Local:</p>
                                                            <p class="mb-0 fw-semibold">@anuncio.Localizacao</p>
                                                        </div>
                                                    }
                                                </div>

                                                @if (!string.IsNullOrEmpty(visita.Observacoes))
                                                {
                                                    <div class="alert alert-info mb-3 small">
                                                        <i class="bi bi-info-circle-fill me-2"></i>
                                                        <strong>Observações:</strong> @visita.Observacoes
                                                    </div>
                                                }

                                                @if (visita.Estado == "Confirmada")
                                                {
                                                    <div class="alert alert-success mb-3 small">
                                                        <i class="bi bi-check-circle-fill me-2"></i>
                                                        <strong>Visita confirmada pelo vendedor.</strong> Compareça no local na data e hora agendadas.
                                                    </div>
                                                }
                                                else if (visita.Estado == "Pendente")
                                                {
                                                    <div class="alert alert-warning mb-3 small">
                                                        <i class="bi bi-clock-fill me-2"></i>
                                                        <strong>Aguardando confirmação do vendedor.</strong>
                                                    </div>
                                                }

                                                <div class="visita-vendedor mb-3 p-3 bg-light rounded">
                                                    <h6 class="mb-2 small fw-bold">
                                                        <i class="bi bi-person-badge me-1"></i>Vendedor
                                                    </h6>
                                                    <div class="d-flex align-items-center">
                                                        @if (!string.IsNullOrEmpty(visita.Vendedor?.ImagemPerfil))
                                                        {
                                                            <img src="@visita.Vendedor.ImagemPerfil" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="@visita.Vendedor.Nome">
                                                        }
                                                        else
                                                        {
                                                            <div class="rounded-circle me-3 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                <i class="bi bi-person-fill fs-4"></i>
                                                            </div>
                                                        }
                                                        <div>
                                                            <p class="mb-0 fw-semibold">@visita.Vendedor?.Nome</p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="d-flex gap-2 flex-wrap">
                                                    <a asp-controller="Visitas" asp-action="Details" asp-route-id="@visita.Id" class="btn btn-sm btn-info text-white">
                                                        <i class="bi bi-eye me-1"></i>Ver Detalhes
                                                    </a>
                                                    <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-car-front me-1"></i>Ver Anúncio
                                                    </a>
                                                    @if (visita.Estado == "Pendente" || visita.Estado == "Confirmada")
                                                    {
                                                        <a asp-controller="Visitas" asp-action="Edit" asp-route-id="@visita.Id" class="btn btn-sm btn-outline-secondary">
                                                            <i class="bi bi-pencil me-1"></i>Editar
                                                        </a>
                                                        <form asp-controller="Visitas" asp-action="Cancelar" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja cancelar esta visita?')">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <input type="hidden" name="motivo" value="Cancelado pelo comprador" />
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                <i class="bi bi-x-circle me-1"></i>Cancelar
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Estado Vazio -->
                        <div class="visitas-empty text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                            </div>
                            <h4 class="text-muted mb-2">Sem visitas agendadas</h4>
                            <p class="text-muted mb-4">Agende uma visita para conhecer o veículo pessoalmente</p>
                            <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Explorar Anúncios
                            </a>
                        </div>
                    }
                    </div>
                }

                <!-- Aba: Minhas Compras (Comprador) -->
                @if (User.IsInRole("Comprador"))
                {
                    var compras = ViewBag.Compras as List<Marketplace.Models.Compra> ?? new List<Marketplace.Models.Compra>();
                    <div class="tab-pane fade" id="minhas-compras">
                        <!-- Cabeçalho da Página -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h3 class="mb-1 fw-bold">
                                    <i class="bi bi-bag-check-fill text-success me-2"></i>Minhas Compras
                                </h3>
                                <p class="text-muted mb-0">Veículos que adquiriu através da plataforma</p>
                            </div>
                            <div class="compras-stats d-flex gap-3">
                                <div class="stat-item text-center">
                                    <div class="stat-value text-success fw-bold">@compras.Count</div>
                                    <div class="stat-label text-muted small">Total</div>
                                </div>
                            </div>
                        </div>

                        @if (compras.Any())
                        {
                            <!-- Lista de Compras -->
                            <div class="compras-list">
                                @foreach (var compra in compras)
                                {
                                    var anuncio = compra.Anuncio;
                                    var imagemPrincipal = anuncio.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/default-car.jpg";
                                    var marcaModelo = $"{anuncio.Marca?.Nome} {anuncio.Modelo?.Nome}";

                                    <div class="card shadow-sm border-success mb-3">
                                        <div class="card-body p-4">
                                            <div class="row g-3">
                                                <div class="col-auto">
                                                    <img src="@imagemPrincipal" alt="@anuncio.Titulo" class="rounded" style="width: 150px; height: 112px; object-fit: cover;">
                                                </div>
                                                <div class="col">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div>
                                                            <h5 class="mb-1 fw-bold">@anuncio.Titulo</h5>
                                                            <p class="text-muted mb-2">
                                                                <i class="bi bi-car-front me-1"></i>@marcaModelo
                                                                @if (anuncio.Ano != null)
                                                                {
                                                                    <span> • @anuncio.Ano</span>
                                                                }
                                                            </p>
                                                        </div>
                                                        <span class="badge bg-success fs-6">
                                                            <i class="bi bi-check-circle-fill me-1"></i>Pago
                                                        </span>
                                                    </div>

                                                    <div class="row g-3 mb-3">
                                                        <div class="col-md-4">
                                                            <p class="text-muted mb-0 small">Data da Compra:</p>
                                                            <p class="mb-0 fw-bold text-success">
                                                                <i class="bi bi-calendar-check me-1"></i>@compra.Data.ToString("dd/MM/yyyy")
                                                            </p>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <p class="text-muted mb-0 small">Valor Pago:</p>
                                                            <p class="mb-0 fw-bold text-primary">
                                                                <i class="bi bi-currency-euro me-1"></i>@anuncio.Preco.ToString("N0")€
                                                            </p>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <p class="text-muted mb-0 small">Estado do Pagamento:</p>
                                                            <p class="mb-0 fw-bold text-success">
                                                                <i class="bi bi-check-all me-1"></i>@compra.EstadoPagamento
                                                            </p>
                                                        </div>
                                                    </div>

                                                    @if (anuncio.Quilometragem != null || !string.IsNullOrEmpty(anuncio.Combustivel?.Tipo))
                                                    {
                                                        <div class="mb-3 p-3 bg-light rounded">
                                                            <h6 class="mb-2 small fw-bold">
                                                                <i class="bi bi-info-circle me-1"></i>Características
                                                            </h6>
                                                            <div class="row g-2 small">
                                                                @if (anuncio.Quilometragem != null)
                                                                {
                                                                    <div class="col-md-6">
                                                                        <i class="bi bi-speedometer2 me-1 text-primary"></i>
                                                                        <strong>Quilometragem:</strong> @anuncio.Quilometragem.Value.ToString("N0") km
                                                                    </div>
                                                                }
                                                                @if (!string.IsNullOrEmpty(anuncio.Combustivel?.Tipo))
                                                                {
                                                                    <div class="col-md-6">
                                                                        <i class="bi bi-fuel-pump me-1 text-primary"></i>
                                                                        <strong>Combustível:</strong> @anuncio.Combustivel.Tipo
                                                                    </div>
                                                                }
                                                            </div>
                                                        </div>
                                                    }

                                                    <div class="compra-vendedor mb-3 p-3 bg-light rounded">
                                                        <h6 class="mb-2 small fw-bold">
                                                            <i class="bi bi-person-badge me-1"></i>Vendedor
                                                        </h6>
                                                        <div class="d-flex align-items-center">
                                                            @if (!string.IsNullOrEmpty(anuncio.Vendedor?.ImagemPerfil))
                                                            {
                                                                <img src="@anuncio.Vendedor.ImagemPerfil" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="@anuncio.Vendedor.Nome">
                                                            }
                                                            else
                                                            {
                                                                <div class="rounded-circle me-3 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                    <i class="bi bi-person-fill fs-4"></i>
                                                                </div>
                                                            }
                                                            <div>
                                                                <p class="mb-0 fw-semibold">@anuncio.Vendedor?.Nome</p>
                                                                <p class="mb-0 text-muted small">@anuncio.Vendedor?.Email</p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="alert alert-success small mb-3">
                                                        <i class="bi bi-check-circle-fill me-2"></i>
                                                        <strong>Compra finalizada com sucesso!</strong> O vendedor entrará em contacto consigo para combinar a entrega do veículo.
                                                    </div>

                                                    <div class="d-flex gap-2 flex-wrap">
                                                        <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-sm btn-primary">
                                                            <i class="bi bi-car-front me-1"></i>Ver Anúncio
                                                        </a>
                                                        <a href="mailto:@anuncio.Vendedor?.Email" class="btn btn-sm btn-outline-primary">
                                                            <i class="bi bi-envelope me-1"></i>Contactar Vendedor
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <!-- Estado Vazio -->
                            <div class="compras-empty text-center py-5">
                                <div class="mb-4">
                                    <i class="bi bi-bag-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                                </div>
                                <h4 class="text-muted mb-2">Sem compras registadas</h4>
                                <p class="text-muted mb-4">Quando comprar um veículo, ele aparecerá aqui</p>
                                <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>Explorar Anúncios
                                </a>
                            </div>
                        }
                    </div>
                }

                <!-- Aba: Definições -->

                <!-- Aba: Pesquisas Guardadas -->
                <div class="tab-pane fade" id="pesquisas-guardadas">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0 fw-bold"><i class="bi bi-bookmark-heart-fill me-2 text-primary"></i>Pesquisas Guardadas</h4>
                        <a class="btn btn-sm btn-outline-primary" asp-controller="Anuncios" asp-action="Index">
                            <i class="bi bi-search me-1"></i>Ir para Anúncios
                        </a>
                    </div>
                    <p class="text-muted mb-4">Aceda rapidamente às suas pesquisas favoritas e receba notificações de novos anúncios</p>

                    @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                    {
                        var saved = ViewBag.SavedFilters as List<Marketplace.Models.FiltrosFav> ?? new List<Marketplace.Models.FiltrosFav>();
                        if (saved.Count == 0)
                        {
                            <div class="text-center py-5">
                                <div class="mb-4">
                                    <i class="bi bi-bookmark-heart text-muted" style="font-size: 4rem;"></i>
                                </div>
                                <h4 class="text-muted mb-2">Sem pesquisas guardadas</h4>
                                <p class="text-muted mb-4">Guarde as suas pesquisas favoritas para acesso rápido e notificações automáticas</p>
                                <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>Pesquisar Veículos
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="row row-cols-1 row-cols-md-2 g-3">
                                @foreach (var f in saved)
                                {
                                    <div class="col">
                                        <div class="card h-100 border-start border-4 border-primary shadow-sm">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h5 class="card-title mb-0">
                                                        <i class="bi bi-bookmark-fill text-primary me-2"></i>
                                                        @f.Nome
                                                    </h5>
                                                    <span class="badge bg-success" title="Notificações ativas">
                                                        <i class="bi bi-bell-fill"></i>
                                                    </span>
                                                </div>

                                                <div class="mb-3">
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar3 me-1"></i>
                                                        Criado em @f.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                                    </small>
                                                </div>

                                                <div class="mb-3">
                                                    @{
                                                        var filtros = new List<string>();
                                                        if (f.MarcaId.HasValue) filtros.Add($"Marca: {f.MarcaId}");
                                                        if (f.ModeloId.HasValue) filtros.Add($"Modelo: {f.ModeloId}");
                                                        if (f.PrecoMax.HasValue) filtros.Add($"Até {f.PrecoMax:N0}€");
                                                        if (f.AnoMin.HasValue || f.AnoMax.HasValue)
                                                            filtros.Add($"Ano: {f.AnoMin ?? 0}-{f.AnoMax ?? DateTime.Now.Year}");
                                                    }
                                                    @if (filtros.Any())
                                                    {
                                                        <div class="d-flex flex-wrap gap-1">
                                                            @foreach (var filtro in filtros.Take(3))
                                                            {
                                                                <span class="badge bg-light text-dark border">@filtro</span>
                                                            }
                                                            @if (filtros.Count > 3)
                                                            {
                                                                <span class="badge bg-light text-dark border">+@(filtros.Count - 3) mais</span>
                                                            }
                                                        </div>
                                                    }
                                                </div>

                                                <div class="d-grid gap-2">
                                                    <a href="@Url.Action("Index", "Anuncios", new {
                                                        marcaId = f.MarcaId,
                                                        modeloId = f.ModeloId,
                                                        tipoId = f.TipoId,
                                                        categoriaId = f.CategoriaId,
                                                        combustivelId = f.CombustivelId,
                                                        precoMax = f.PrecoMax,
                                                        anoMin = f.AnoMin,
                                                        anoMax = f.AnoMax,
                                                        kmMax = f.KmMax,
                                                        caixa = f.Caixa,
                                                        localizacao = f.Localizacao
                                                    })" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-search me-1"></i>Aplicar Filtros
                                                    </a>
                                                    <form asp-controller="Anuncios" asp-action="DeleteFiltro" method="post" onsubmit="return confirm('Remover esta pesquisa guardada? Deixará de receber notificações.');">
                                                        <input type="hidden" name="id" value="@f.Id" />
                                                        <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                                                            <i class="bi bi-trash me-1"></i>Remover
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Apenas compradores e vendedores podem guardar pesquisas.
                        </div>
                    }
                </div>
                <div class="tab-pane fade" id="historico-pesquisa">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0 fw-bold"><i class="bi bi-clock-history me-2 text-primary"></i>Histórico de Pesquisa</h4>
                        <a class="btn btn-sm btn-outline-primary" asp-controller="Anuncios" asp-action="Index">Nova Pesquisa</a>
                    </div>
                    <p class="text-muted mb-4">Consulte as suas pesquisas recentes e repita-as facilmente</p>

                    @{
                        var history = ViewBag.PesquisasPassadas as List<Marketplace.Models.PesquisasPassadas> ?? new List<Marketplace.Models.PesquisasPassadas>();
                    }
                    @if (!history.Any())
                    {
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-clock-history text-muted" style="font-size: 4rem;"></i>
                            </div>
                            <h4 class="text-muted mb-2">Sem histórico recente</h4>
                            <p class="text-muted mb-4">As suas pesquisas de veículos aparecerão aqui</p>
                            <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Pesquisar Veículos
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="list-group shadow-sm">
                            @foreach (var p in history)
                            {
                                <a href="@Url.Action("Index", "Anuncios")?@p.Parametros" class="list-group-item list-group-item-action p-3 border-start border-4 border-primary border-start-0-hover">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <h6 class="mb-1 fw-bold text-dark">@p.Descricao</h6>
                                        <small class="text-muted"><i class="bi bi-calendar3 me-1"></i>@p.Data.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-end mt-2">
                                        <small class="text-muted text-truncate w-75">
                                            <i class="bi bi-sliders me-1"></i>Filtros: @(string.IsNullOrEmpty(p.Parametros) ? "Nenhum" : p.Parametros.Replace("&", ", ").Replace("=", ": "))
                                        </small>
                                        <span class="badge bg-light text-dark border">
                                           @p.Count resultados
                                        </span>
                                    </div>
                                </a>
                            }
                        </div>
                    }
                </div>

                <div class="tab-pane fade" id="definicoes">
                    <!-- Cabeçalho da Página -->
                    <div class="mb-4">
                        <h3 class="mb-1 fw-bold">
                            <i class="bi bi-gear-fill text-primary me-2"></i>Definições da Conta
                        </h3>
                        <p class="text-muted mb-0">Gerir as preferências e segurança da sua conta</p>
                    </div>

                    <!-- Segurança da Conta -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-shield-lock text-primary me-2"></i>Segurança
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <div id="security-alerts"></div>

                            <!-- Alterar Password -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-primary-subtle">
                                        <i class="bi bi-key-fill text-primary"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Alterar Password</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Última alteração há 3 meses. Recomendamos alterar a cada 6 meses.
                                        </p>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#alterarPasswordModal">
                                    <i class="bi bi-pencil me-1"></i>Alterar
                                </button>
                            </div>

                            <hr class="my-3">

                            <!-- Autenticação de Dois Fatores -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-success-subtle">
                                        <i class="bi bi-shield-check text-success"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Autenticação de Dois Fatores</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Adicione uma camada extra de segurança à sua conta.
                                        </p>
                                        <div class="text-muted small" id="twofaStatusHelper">Estado: a verificar...</div>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switch2FA">
                                    <label class="form-check-label" for="switch2FA">
                                        <span class="badge bg-secondary">Desativado</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Sessões Ativas -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-info-subtle">
                                        <i class="bi bi-devices text-info"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Sessões Ativas</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Gerir dispositivos com sessão iniciada. 1 dispositivo ativo.
                                        </p>
                                    </div>
                                </div>
                                <button class="btn btn-outline-secondary" id="btnSessions">
                                    <i class="bi bi-list-ul me-1"></i>Ver
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Notificações -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-bell text-primary me-2"></i>Notificações
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <!-- Email Notificações -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-primary-subtle">
                                        <i class="bi bi-envelope text-primary"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Notificações por Email</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Receber atualizações sobre anúncios e mensagens.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchEmailNotif" checked>
                                    <label class="form-check-label" for="switchEmailNotif">
                                        <span class="badge bg-success">Ativo</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Notificações de Novos Anúncios -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-warning-subtle">
                                        <i class="bi bi-bookmark-star text-warning"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Novos Anúncios</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Alertas quando houver anúncios que correspondam às suas preferências.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchNovosAnuncios" checked>
                                    <label class="form-check-label" for="switchNovosAnuncios">
                                        <span class="badge bg-success">Ativo</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Notificações de Preço -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-success-subtle">
                                        <i class="bi bi-graph-down text-success"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Alertas de Redução de Preço</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Notificações quando veículos favoritos baixarem de preço.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchPreco">
                                    <label class="form-check-label" for="switchPreco">
                                        <span class="badge bg-secondary">Desativado</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Newsletter -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-info-subtle">
                                        <i class="bi bi-newspaper text-info"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Newsletter</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Receber dicas, novidades e ofertas especiais.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchNewsletter" checked>
                                    <label class="form-check-label" for="switchNewsletter">
                                        <span class="badge bg-success">Ativo</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Privacidade -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-eye-slash text-primary me-2"></i>Privacidade
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <!-- Perfil Público -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-primary-subtle">
                                        <i class="bi bi-person-badge text-primary"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Perfil Público</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Permitir que outros utilizadores vejam o seu perfil.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchPerfilPublico" checked>
                                    <label class="form-check-label" for="switchPerfilPublico">
                                        <span class="badge bg-success">Público</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Mostrar Email -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-warning-subtle">
                                        <i class="bi bi-at text-warning"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Mostrar Email Publicamente</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Exibir o seu email nos anúncios publicados.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchMostrarEmail">
                                    <label class="form-check-label" for="switchMostrarEmail">
                                        <span class="badge bg-secondary">Oculto</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zona de Perigo -->
                    <div class="card shadow-sm border-danger mb-4">
                        <div class="card-header bg-danger-subtle border-bottom border-danger py-3">
                            <h5 class="mb-0 fw-semibold text-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>Zona de Perigo
                            </h5>
                        </div>
                            <!-- Desativar Conta -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-warning-subtle">
                                        <i class="bi bi-pause-circle text-warning"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Desativar Conta</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            A sua conta será temporariamente desativada. Pode reativá-la a qualquer momento.
                                        </p>
                                    </div>
                                </div>
                                <form asp-controller="Utilizadores" asp-action="DeactivateAccount" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja desativar a sua conta?');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-outline-warning">
                                        <i class="bi bi-pause me-1"></i>Desativar
                                    </button>
                                </form>
                            </div>

                            <hr class="my-3">

                            <!-- Eliminar Conta -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-danger-subtle">
                                        <i class="bi bi-trash text-danger"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Eliminar Conta</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Eliminar permanentemente a sua conta e todos os dados. Esta ação é irreversível.
                                        </p>
                                    </div>
                                </div>
                                <form asp-controller="Utilizadores" asp-action="DeleteAccount" method="post" class="d-inline" onsubmit="return confirm('Eliminar conta? Esta ação é irreversível.');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class="bi bi-trash me-1"></i>Eliminar
                                    </button>
                                </form>
                            </div>
                    <!-- Botão de Guardar Alterações -->
                    <div class="text-end">
                        <button class="btn btn-lg btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Guardar Alterações
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Alterar Password -->
<div class="modal fade" id="alterarPasswordModal" tabindex="-1" aria-labelledby="alterarPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="formAlterarPassword" method="post" action="@Url.Action("AlterarPassword", "Utilizadores")">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="alterarPasswordModalLabel"><i class="bi bi-key-fill me-2"></i>Alterar Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="alterarPasswordErro"></div>
                    <div class="mb-3">
                        <label class="form-label">Password atual</label>
                        <input type="password" name="PasswordAtual" class="form-control" required autocomplete="current-password" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nova password</label>
                        <input type="password" name="PasswordNova" class="form-control" required minlength="8" autocomplete="new-password" />
                        <div class="form-text">Mínimo 8 caracteres, com maiúsculas, minúsculas e números.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirmar nova password</label>
                        <input type="password" name="PasswordNovaConfirmacao" class="form-control" required autocomplete="new-password" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Configurar 2FA -->
<div class="modal fade" id="twofaSetupModal" tabindex="-1" aria-labelledby="twofaSetupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <form id="formTwoFactor" method="post" action="@Url.Action("EnableTwoFactor", "Utilizadores")">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="twofaSetupModalLabel"><i class="bi bi-shield-check me-2"></i>Ativar Autenticação de Dois Fatores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger d-none" id="twofaError"></div>
                    <ol class="ps-3">
                        <li class="mb-3">
                            Abra a sua app de autenticação (Google Authenticator, Microsoft Authenticator, etc.) e adicione uma nova conta.
                        </li>
                        <li class="mb-3">
                            Utilize a chave abaixo na sua app de autenticação:
                            <div class="bg-light border rounded p-3 mt-2">
                                <div class="fw-semibold mb-1" id="twofaSharedKey">---</div>
                                <small class="text-muted d-block" id="twofaUriText"></small>
                            </div>
                        </li>
                        <li class="mb-3">
                            Introduza o código de 6 dígitos gerado:
                            <div class="mt-2">
                                <input type="text" name="Code" class="form-control" placeholder="000000" maxlength="8" required autocomplete="one-time-code" inputmode="numeric">
                            </div>
                        </li>
                    </ol>
                    <div class="alert alert-info d-none" id="twofaRecoveryContainer">
                        <div class="fw-semibold mb-2">Guarde estes códigos de recuperação em local seguro:</div>
                        <ul id="twofaRecoveryList" class="mb-0 ps-3 small"></ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-shield-lock me-1"></i>Ativar 2FA
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="securityAntiForgery" class="d-none">
    @Html.AntiForgeryToken()
</form>

<!-- Modal: Sessões Ativas -->
<div class="modal fade" id="sessionsModal" tabindex="-1" aria-labelledby="sessionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionsModalLabel"><i class="bi bi-devices me-2"></i>Sessões Ativas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    Por questões de privacidade não listamos dispositivos, mas pode terminar sessões em outros dispositivos mantendo esta aberta.
                </p>
                <div class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <div>Se usou computadores públicos ou partilhados, termine sessões para impedir acessos futuros.</div>
                </div>
                <div id="sessionsFeedback"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-danger" id="btnTerminateSessions">
                    <i class="bi bi-power me-1"></i>Terminar outras sessões
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Destacar Anúncio -->
<div class="modal fade" id="destacarModal" tabindex="-1" aria-labelledby="destacarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white border-0">
                <h5 class="modal-title fw-bold" id="destacarModalLabel">
                    <i class="bi bi-star-fill me-2"></i>Destacar Anúncio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="destacar-icon mb-3">
                        <i class="bi bi-rocket-takeoff" style="font-size: 3.5rem; color: #fbbf24;"></i>
                    </div>
                    <h5 class="fw-bold mb-2">Aumente a visibilidade do seu anúncio!</h5>
                    <p class="text-muted mb-0">
                        Destaque o seu veículo e coloque-o no topo das listagens para obter mais visualizações e contactos.
                    </p>
                </div>

                <div class="destacar-features mb-4">
                    <div class="feature-item d-flex align-items-center mb-3">
                        <div class="feature-icon-circle me-3 flex-shrink-0">
                            <i class="bi bi-arrow-up-circle-fill text-warning"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">Posição de Topo</h6>
                            <p class="text-muted small mb-0">O seu anúncio aparece no topo dos resultados de pesquisa</p>
                        </div>
                    </div>
                    <div class="feature-item d-flex align-items-center mb-3">
                        <div class="feature-icon-circle me-3 flex-shrink-0">
                            <i class="bi bi-eye-fill text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">Mais Visualizações</h6>
                            <p class="text-muted small mb-0">Até 5x mais visualizações comparado com anúncios normais</p>
                        </div>
                    </div>
                    <div class="feature-item d-flex align-items-center mb-3">
                        <div class="feature-icon-circle me-3 flex-shrink-0">
                            <i class="bi bi-badge-vr-fill text-success"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">Badge Especial</h6>
                            <p class="text-muted small mb-0">O seu anúncio recebe um badge "Em Destaque" visível</p>
                        </div>
                    </div>
                    <div class="feature-item d-flex align-items-center">
                        <div class="feature-icon-circle me-3 flex-shrink-0">
                            <i class="bi bi-lightning-charge-fill text-danger"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">Venda Mais Rápida</h6>
                            <p class="text-muted small mb-0">Anúncios destacados vendem 3x mais rápido</p>
                        </div>
                    </div>
                </div>

                <div class="destacar-pricing card bg-light border-warning border-2 mb-4">
                    <div class="card-body text-center p-4">
                        <div class="d-flex justify-content-center align-items-baseline mb-3">
                            <span class="display-4 fw-bold text-warning">1,99€</span>
                            <span class="text-muted ms-2">/ 7 dias</span>
                        </div>
                        <p class="text-muted small mb-0">
                            <i class="bi bi-info-circle me-1"></i>Renovação automática desativada por padrão
                        </p>
                    </div>
                </div>

                <div class="alert alert-info d-flex align-items-center mb-0" role="alert">
                    <i class="bi bi-lightbulb-fill me-2 flex-shrink-0"></i>
                    <div class="small">
                        <strong>Dica:</strong> Os melhores resultados são obtidos em anúncios com fotos de qualidade e descrições completas.
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning text-white" id="btnConfirmarDestaque">
                    <i class="bi bi-star-fill me-2"></i>Destacar por 1,99€
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Adicionar Disponibilidade -->
<div class="modal fade" id="modalAdicionarDisponibilidade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formAdicionarDisponibilidade" asp-controller="Disponibilidade" asp-action="Create" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus me-2"></i>Adicionar Disponibilidade
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-calendar-day me-1"></i>Dia da Semana <span class="text-danger">*</span>
                        </label>
                        <select name="DiaSemana" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="0">Domingo</option>
                            <option value="1">Segunda-feira</option>
                            <option value="2">Terça-feira</option>
                            <option value="3">Quarta-feira</option>
                            <option value="4">Quinta-feira</option>
                            <option value="5">Sexta-feira</option>
                            <option value="6">Sábado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-clock me-1"></i>Hora de Início <span class="text-danger">*</span>
                        </label>
                        <input type="time" name="HoraInicio" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-clock-fill me-1"></i>Hora de Fim <span class="text-danger">*</span>
                        </label>
                        <input type="time" name="HoraFim" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-hourglass-split me-1"></i>Intervalo entre Visitas <span class="text-danger">*</span>
                        </label>
                        <select name="IntervaloMinutos" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="15">15 minutos</option>
                            <option value="30">30 minutos</option>
                            <option value="60" selected>60 minutos (recomendado)</option>
                            <option value="90">90 minutos</option>
                            <option value="120">120 minutos</option>
                        </select>
                    </div>
                    <div class="form-check form-switch">
                        <input type="checkbox" name="Ativo" id="Ativo" class="form-check-input" value="true" checked />
                        <input type="hidden" name="Ativo" value="false" />
                        <label for="Ativo" class="form-check-label">Ativo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Editar Disponibilidade -->
<div class="modal fade" id="modalEditarDisponibilidade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formEditarDisponibilidade" asp-controller="Disponibilidade" asp-action="Edit" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" id="editId" />
                <input type="hidden" name="VendedorId" id="editVendedorId" />
                <input type="hidden" name="DataCriacao" id="editDataCriacao" />
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Editar Disponibilidade
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-calendar-day me-1"></i>Dia da Semana <span class="text-danger">*</span>
                        </label>
                        <select name="DiaSemana" id="editDiaSemana" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="0">Domingo</option>
                            <option value="1">Segunda-feira</option>
                            <option value="2">Terça-feira</option>
                            <option value="3">Quarta-feira</option>
                            <option value="4">Quinta-feira</option>
                            <option value="5">Sexta-feira</option>
                            <option value="6">Sábado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-clock me-1"></i>Hora de Início <span class="text-danger">*</span>
                        </label>
                        <input type="time" name="HoraInicio" id="editHoraInicio" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-clock-fill me-1"></i>Hora de Fim <span class="text-danger">*</span>
                        </label>
                        <input type="time" name="HoraFim" id="editHoraFim" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-hourglass-split me-1"></i>Intervalo entre Visitas <span class="text-danger">*</span>
                        </label>
                        <select name="IntervaloMinutos" id="editIntervaloMinutos" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="15">15 minutos</option>
                            <option value="30">30 minutos</option>
                            <option value="60">60 minutos (recomendado)</option>
                            <option value="90">90 minutos</option>
                            <option value="120">120 minutos</option>
                        </select>
                    </div>
                    <div class="form-check form-switch">
                        <input type="checkbox" name="Ativo" id="editAtivo" class="form-check-input" value="true" />
                        <input type="hidden" name="Ativo" value="false" />
                        <label for="editAtivo" class="form-check-label">Ativo</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Atualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Upload Foto de Perfil -->
<div class="modal fade" id="modalFotoPerfil" tabindex="-1" aria-labelledby="modalFotoPerfilLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalFotoPerfilLabel">
                    <i class="bi bi-camera-fill me-2"></i>Alterar Foto de Perfil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formFotoPerfil" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <img id="previewFotoPerfil"
                             src="@((ViewBag.ImagemPerfil as string) ?? Url.Content("~/imagens/logo.png"))"
                             class="rounded-circle mb-3"
                             style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #dee2e6;"
                             alt="Preview">
                    </div>
                    <div class="mb-3">
                        <label for="inputFotoPerfil" class="form-label">Escolha uma nova foto</label>
                        <input type="file"
                               class="form-control"
                               id="inputFotoPerfil"
                               name="fotoPerfil"
                               accept="image/jpeg,image/jpg,image/png"
                               required>
                        <div class="form-text">
                            <i class="bi bi-info-circle me-1"></i>Formatos aceites: JPG, PNG (máx. 2MB)
                        </div>
                    </div>
                    <div id="erroUploadFoto" class="alert alert-danger d-none" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload me-2"></i>Guardar Foto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Pedir para Tornar-se Vendedor -->
<div class="modal fade" id="modalTornarVendedor" tabindex="-1" aria-labelledby="modalTornarVendedorLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title" id="modalTornarVendedorLabel">
                    <i class="bi bi-shop me-2"></i>Pedido para Tornar-se Vendedor
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formTornarVendedor">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-info border-0 shadow-sm mb-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-3" style="font-size: 2rem;"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Como funciona?</h6>
                                <p class="mb-0 small">
                                    Após submeter o pedido, um administrador irá rever a sua solicitação.
                                    Receberá um email quando o pedido for aprovado ou rejeitado.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="nifVendedor" class="form-label">
                            <i class="bi bi-credit-card-2-front me-1"></i>NIF <span class="text-danger">*</span>
                        </label>
                        <input type="text"
                               class="form-control"
                               id="nifVendedor"
                               name="nif"
                               placeholder="123456789"
                               pattern="[0-9]{9}"
                               maxlength="9"
                               required>
                        <div class="form-text">
                            <i class="bi bi-shield-check me-1"></i>Necessário para faturação e verificação fiscal
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="dadosFaturacao" class="form-label">
                            <i class="bi bi-building me-1"></i>Dados de Faturação
                        </label>
                        <textarea class="form-control"
                                  id="dadosFaturacao"
                                  name="dadosFaturacao"
                                  rows="3"
                                  placeholder="Nome da empresa/pessoa, morada de faturação, etc."></textarea>
                        <div class="form-text">Opcional - pode preencher mais tarde</div>
                    </div>

                    <div class="mb-3">
                        <label for="motivacao" class="form-label">
                            <i class="bi bi-chat-text me-1"></i>Motivação <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control"
                                  id="motivacao"
                                  name="motivacao"
                                  rows="4"
                                  placeholder="Conte-nos porque quer ser vendedor na plataforma 404 Ride..."
                                  required></textarea>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               id="aceitarTermos"
                               name="aceitarTermos"
                               required>
                        <label class="form-check-label" for="aceitarTermos">
                            Aceito os <a href="#" target="_blank">Termos e Condições</a> para vendedores
                        </label>
                    </div>

                    <div id="erroTornarVendedor" class="alert alert-danger d-none mt-3" role="alert"></div>
                    <div id="sucessoTornarVendedor" class="alert alert-success d-none mt-3" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send me-2"></i>Enviar Pedido
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Sistema de Tabs do Perfil
        document.addEventListener('DOMContentLoaded', function () {
            // Selecionar todos os itens de navegação
            const navItems = document.querySelectorAll('.perfil-nav-item');
            const tabPanes = document.querySelectorAll('.tab-pane');

            // Função para ativar uma tab
            function activateTab(targetId) {
                // Remover classe active de todos os itens
                navItems.forEach(item => item.classList.remove('active'));
                tabPanes.forEach(pane => {
                    pane.classList.remove('show', 'active');
                });

                // Adicionar classe active ao item clicado
                const clickedItem = document.querySelector(`[href="${targetId}"]`);
                if (clickedItem) {
                    clickedItem.classList.add('active');
                }

                // Mostrar o conteúdo correspondente
                const targetPane = document.querySelector(targetId);
                if (targetPane) {
                    targetPane.classList.add('show', 'active');
                }
            }

            // Adicionar event listeners aos itens de navegação
            navItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    activateTab(targetId);

                    // Scroll suave para o topo do conteúdo (opcional)
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            });

            // Sistema de Filtros de Anúncios
            const filterButtons = document.querySelectorAll('.anuncios-filter-btn');
            const anuncioCards = document.querySelectorAll('.anuncio-card');
            const anunciosEmpty = document.querySelector('.anuncios-empty');

            filterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Remover classe active de todos os botões
                    filterButtons.forEach(btn => btn.classList.remove('active'));

                    // Adicionar classe active ao botão clicado
                    this.classList.add('active');

                    // Obter o filtro selecionado
                    const filter = this.getAttribute('data-filter');

                    let visibleCount = 0;

                    // Filtrar os anúncios
                    anuncioCards.forEach(card => {
                        const status = card.getAttribute('data-status');

                        if (filter === 'todos' || filter === status) {
                            card.style.display = '';
                            visibleCount++;
                        } else {
                            card.style.display = 'none';
                        }
                    });

                    // Mostrar mensagem se não houver resultados
                    if (anunciosEmpty) {
                        if (visibleCount === 0) {
                            anunciosEmpty.classList.remove('d-none');
                        } else {
                            anunciosEmpty.classList.add('d-none');
                        }
                    }
                });
            });

            // Sistema de Favoritos
            const favoritoHeartBtns = document.querySelectorAll('.favorito-heart-btn');
            const favoritoRemoveBtns = document.querySelectorAll('.favorito-remove-btn');

            // Função para remover favorito
            function removeFavorito(card) {
                // Animação de saída
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(-20px)';

                setTimeout(() => {
                    card.remove();

                    // Verificar se ainda existem favoritos
                    const remainingFavoritos = document.querySelectorAll('.favorito-card');
                    if (remainingFavoritos.length === 0) {
                        document.querySelector('.favoritos-grid').classList.add('d-none');
                        document.querySelector('.favoritos-empty').classList.remove('d-none');
                    }

                    // Atualizar contador
                    const favoritoCount = document.querySelector('.favoritos-stats .stat-value');
                    if (favoritoCount) {
                        favoritoCount.textContent = remainingFavoritos.length;
                    }
                }, 300);
            }

            // Event listeners para botões de coração
            favoritoHeartBtns.forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const card = this.closest('.favorito-card');
                    if (confirm('Deseja remover este anúncio dos favoritos?')) {
                        removeFavorito(card);
                    }
                });
            });

            // Event listeners para botões de remover
            favoritoRemoveBtns.forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const card = this.closest('.favorito-card');
                    if (confirm('Deseja remover este anúncio dos favoritos?')) {
                        removeFavorito(card);
                    }
                });
            });

            // Sistema de Ordenação de Favoritos
            const sortButtons = document.querySelectorAll('.favoritos-sort-bar .btn-group .btn');

            sortButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    // Remover active de todos
                    sortButtons.forEach(b => b.classList.remove('active'));
                    // Adicionar active ao clicado
                    this.classList.add('active');

                    // Aqui você pode implementar a lógica de ordenação
                    // Por exemplo, reorganizar os cards baseado no critério selecionado
                    console.log('Ordenar por:', this.textContent.trim());
                });
            });

            // Sistema de Switches de Definições
            const switches = document.querySelectorAll('.form-check-input[type="checkbox"]');

            switches.forEach(switchElement => {
                switchElement.addEventListener('change', function () {
                    const label = this.nextElementSibling;
                    const badge = label.querySelector('.badge');

                    if (badge) {
                        if (this.checked) {
                            // Estado Ativo
                            badge.classList.remove('bg-secondary');
                            badge.classList.add('bg-success');
                            badge.textContent = this.id === 'switchPerfilPublico' ? 'Público' : 'Ativo';
                        } else {
                            // Estado Desativado
                            badge.classList.remove('bg-success', 'bg-primary');
                            badge.classList.add('bg-secondary');
                            badge.textContent = this.id === 'switchPerfilPublico' ? 'Privado' :
                                              this.id === 'switchMostrarEmail' ? 'Oculto' : 'Desativado';
                        }
                    }

                    // Aqui você pode adicionar lógica para salvar a preferência
                    console.log(`${this.id}: ${this.checked ? 'Ativo' : 'Desativado'}`);
                });
            });

            // Botão Guardar Alterações
            const btnGuardarDefinicoes = document.querySelector('#definicoes .btn-primary');

            if (btnGuardarDefinicoes) {
                btnGuardarDefinicoes.addEventListener('click', function () {
                    // Coletar todos os valores dos switches
                    const preferencias = {};

                    switches.forEach(sw => {
                        preferencias[sw.id] = sw.checked;
                    });

                    console.log('Guardar preferências:', preferencias);

                    // Mostrar feedback visual
                    const btnText = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Guardado!';
                    this.classList.add('btn-success');
                    this.classList.remove('btn-primary');

                    setTimeout(() => {
                        this.innerHTML = btnText;
                        this.classList.remove('btn-success');
                        this.classList.add('btn-primary');
                    }, 2000);

                    // Aqui você implementaria a chamada AJAX para o backend
                });
            }

            // ===== Sistema de Destacar Anúncios =====
            const btnConfirmarDestaque = document.getElementById('btnConfirmarDestaque');
            const btnRenovarDestaque = document.querySelectorAll('.btn-renovar-destaque');
            const destacarModal = document.getElementById('destacarModal');
            let anuncioAtual = null;

            // Capturar qual anúncio está sendo destacado
            document.querySelectorAll('.btn-destacar').forEach(btn => {
                btn.addEventListener('click', function() {
                    anuncioAtual = this.closest('.anuncio-card');
                });
            });

            // Confirmar destaque
            if (btnConfirmarDestaque) {
                btnConfirmarDestaque.addEventListener('click', function() {
                    if (!anuncioAtual) {
                        alert('Por favor, selecione um anúncio para destacar.');
                        return;
                    }

                    const anuncioId = anuncioAtual.getAttribute('data-id');
                    if (!anuncioId) {
                        alert('Erro ao obter ID do anúncio.');
                        return;
                    }

                    // Feedback visual no botão
                    this.disabled = true;
                    this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>A processar pagamento...';

                    // Criar e submeter form para o backend
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/Anuncios/ProcessarDestaque';

                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'id';
                    input.value = anuncioId;

                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                });
            }

            // Botões de renovar destaque
            btnRenovarDestaque.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Renovar destaque por mais 7 dias?\n\nCusto: 1,99€')) {
                        const anuncioCard = this.closest('.anuncio-card');
                        const anuncioId = anuncioCard?.getAttribute('data-id');

                        if (!anuncioId) {
                            alert('Erro ao obter ID do anúncio.');
                            return;
                        }

                        this.disabled = true;
                        this.innerHTML = '<i class="bi bi-hourglass-split"></i>';

                        // Criar e submeter form para o backend
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/Anuncios/ProcessarDestaque';

                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'id';
                        input.value = anuncioId;

                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });

            // Sistema de Filtros para Visitas (Comprador)
            const visitasFilterButtons = document.querySelectorAll('[data-filter-visitas]');
            const visitasCards = document.querySelectorAll('[data-status-visita]');

            visitasFilterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Remove active de todos os botões
                    visitasFilterButtons.forEach(btn => {
                        btn.classList.remove('active');
                        // Restaura classes originais
                        if (btn.getAttribute('data-filter-visitas') === 'todas') {
                            btn.className = 'btn btn-outline-primary';
                        } else if (btn.getAttribute('data-filter-visitas') === 'pendentes') {
                            btn.className = 'btn btn-outline-warning';
                        } else if (btn.getAttribute('data-filter-visitas') === 'confirmadas') {
                            btn.className = 'btn btn-outline-success';
                        } else if (btn.getAttribute('data-filter-visitas') === 'concluidas') {
                            btn.className = 'btn btn-outline-secondary';
                        }
                    });

                    // Adiciona active ao botão clicado
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter-visitas');

                    visitasCards.forEach(card => {
                        const status = card.getAttribute('data-status-visita');

                        if (filter === 'todas') {
                            card.style.display = '';
                        } else if (filter === 'pendentes' && status === 'pendente') {
                            card.style.display = '';
                        } else if (filter === 'confirmadas' && status === 'confirmada') {
                            card.style.display = '';
                        } else if (filter === 'concluidas' && status === 'concluida') {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // Sistema de Filtros para Reservas (Vendedor)
            const reservasVendedorFilterButtons = document.querySelectorAll('[data-filter-reservas-vendedor]');
            const reservasVendedorCards = document.querySelectorAll('[data-status-reserva-vendedor]');

            reservasVendedorFilterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    reservasVendedorFilterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter-reservas-vendedor');

                    reservasVendedorCards.forEach(card => {
                        const status = card.getAttribute('data-status-reserva-vendedor');

                        if (filter === 'todas') {
                            card.style.display = '';
                        } else if (filter === 'pendentes' && status === 'pendente') {
                            card.style.display = '';
                        } else if (filter === 'ativas' && status === 'ativa') {
                            card.style.display = '';
                        } else if (filter === 'expiradas' && status === 'expirada') {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // Sistema de Filtros para Visitas Recebidas (Vendedor)
            const visitasRecebidasFilterButtons = document.querySelectorAll('[data-filter-visitas-recebidas]');
            const visitasRecebidasCards = document.querySelectorAll('[data-status-visita-recebida]');

            visitasRecebidasFilterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    visitasRecebidasFilterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter-visitas-recebidas');

                    visitasRecebidasCards.forEach(card => {
                        const status = card.getAttribute('data-status-visita-recebida');
                        if (filter === 'todas' || filter === status) {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // Sistema de Filtros para Visitas Agendadas (Vendedor como Comprador)
            const visitasAgendadasFilterButtons = document.querySelectorAll('[data-filter-visitas-agendadas]');
            const visitasAgendadasCards = document.querySelectorAll('[data-status-visita-agendada]');

            visitasAgendadasFilterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    visitasAgendadasFilterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter-visitas-agendadas');

                    visitasAgendadasCards.forEach(card => {
                        const status = card.getAttribute('data-status-visita-agendada');
                        if (filter === 'todas' || filter === status) {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // O sistema de toggle de utilizador agora está no _Layout.cshtml e funciona globalmente
        });

        // ========== Dados Bancários - MB WAY Toggle ==========
        const metodoMbwayCheckbox = document.getElementById('metodo-mbway');
        const campoMbway = document.getElementById('campo-mbway');

        if (metodoMbwayCheckbox && campoMbway) {
            // Mostrar/esconder campo MB WAY
            metodoMbwayCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    campoMbway.style.display = 'block';
                    campoMbway.querySelector('input').required = true;
                } else {
                    campoMbway.style.display = 'none';
                    campoMbway.querySelector('input').required = false;
                }
            });

            // Verificar estado inicial
            if (metodoMbwayCheckbox.checked) {
                campoMbway.style.display = 'block';
                campoMbway.querySelector('input').required = true;
            }
        }

        // ========== Formulário de Dados Bancários ==========
        const formDadosBancarios = document.getElementById('formDadosBancarios');
        if (formDadosBancarios) {
            formDadosBancarios.addEventListener('submit', function(e) {
                e.preventDefault();

                // Validar se pelo menos um método de pagamento está selecionado
                const metodosCheckboxes = [
                    document.getElementById('metodo-transferencia'),
                    document.getElementById('metodo-mbway'),
                    document.getElementById('metodo-multibanco'),
                    document.getElementById('metodo-dinheiro')
                ];

                const algumSelecionado = metodosCheckboxes.some(cb => cb && cb.checked);

                if (!algumSelecionado) {
                    alert('Por favor, selecione pelo menos um método de pagamento.');
                    return;
                }

                // Simular sucesso
                alert('Dados bancários guardados com sucesso!');

                // Feedback visual
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Guardado!';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');

                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-primary');
                }, 2000);
            });
        }

        // ========== Hover Effect nos Payment Method Cards ==========
        const paymentCards = document.querySelectorAll('.payment-method-card');
        paymentCards.forEach(card => {
            const checkbox = card.querySelector('.form-check-input');

            if (checkbox) {
                // Aplicar classe checked inicial
                if (checkbox.checked) {
                    card.classList.add('border-primary', 'bg-light');
                }

                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        card.classList.add('border-primary', 'bg-light');
                    } else {
                        card.classList.remove('border-primary', 'bg-light');
                    }
                });
            }
        });
</script>
<script>
    // Dinamizar cabeçalho e "Dados Pessoais" sem depender do encoding do ficheiro
    (function () {
        // Carregar dados dinâmicos do perfil via JSON para evitar problemas de encoding no ficheiro
        fetch('/Utilizadores/PerfilDados', { cache: 'no-store' })
            .then(r => r.ok ? r.json() : null)
            .then(data => {
                if (!data) return;
                const nome = data.nome || '';
                const email = data.email || '';
                const phone = data.phone || '';
                const rua = (data.morada && data.morada.rua) || '';
                const localidade = (data.morada && data.morada.localidade) || '';
                const cp = (data.morada && data.morada.codigoPostal) || '';

                // Substituir o nome e avatar no header
                try {
                    const headerName = document.querySelector('.perfil-header h5');
                    if (headerName && nome) headerName.textContent = nome;
                    const avatarImg = document.querySelector('.perfil-avatar');
                    if (avatarImg && data.imagemPerfil) avatarImg.setAttribute('src', data.imagemPerfil);
                } catch {}

                // Atualizar cartões de Dados Pessoais
                try {
                    const labelValuePairs = document.querySelectorAll('.perfil-info-item');
                    labelValuePairs.forEach(it => {
                        const label = it.querySelector('.perfil-info-label');
                        const value = it.querySelector('.perfil-info-value');
                        if (!label || !value) return;
                        const text = (label.textContent || '').trim().toLowerCase();
                        if (text.includes('nome')) {
                            if (nome) value.textContent = nome;
                        } else if (text.includes('email')) {
                            if (email) value.textContent = email;
                        } else if (text.includes('telefone') || text.includes('telemóvel') || text.includes('telemovel')) {
                            if (phone) value.textContent = phone;
                        } else if (text.includes('rua')) {
                            if (rua) value.textContent = rua;
                        } else if (text.includes('código postal') || text.includes('codigo postal')) {
                            if (cp) value.textContent = cp;
                        } else if (text.includes('localidade')) {
                            if (localidade) value.textContent = localidade;
                        }
                    });
                } catch {}
            })
            .catch(() => { /* ignora erros */ });
    })();
</script>

<script src="~/js/favoritos.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const securityAlerts = document.getElementById('security-alerts');
        const switch2FA = document.getElementById('switch2FA');
        const twofaLabel = document.querySelector('#switch2FA + label span');
        const twofaHelper = document.getElementById('twofaStatusHelper');
        const twofaKeyEl = document.getElementById('twofaSharedKey');
        const twofaUriEl = document.getElementById('twofaUriText');
        const twofaRecoveryContainer = document.getElementById('twofaRecoveryContainer');
        const twofaRecoveryList = document.getElementById('twofaRecoveryList');
        const twofaForm = document.getElementById('formTwoFactor');
        const twofaError = document.getElementById('twofaError');
        const changePwdForm = document.getElementById('formAlterarPassword');
        const changePwdError = document.getElementById('alterarPasswordErro');
        const sessionsModalEl = document.getElementById('sessionsModal');
        const sessionsModal = sessionsModalEl ? bootstrap.Modal.getOrCreateInstance(sessionsModalEl) : null;
        const sessionsFeedback = document.getElementById('sessionsFeedback');
        const btnTerminateSessions = document.getElementById('btnTerminateSessions');
        const btnSessions = document.getElementById('btnSessions');
        const switchEmailNotif = document.getElementById('switchEmailNotif');
        const switchNovos = document.getElementById('switchNovosAnuncios');
        const switchPreco = document.getElementById('switchPreco');
        const switchPerfilPublico = document.getElementById('switchPerfilPublico');
        const switchMostrarEmail = document.getElementById('switchMostrarEmail');
        const tokenField = () => document.querySelector('#securityAntiForgery input[name="__RequestVerificationToken"]')?.value;

        let twofaEnabled = false;

        const showSecurityAlert = (type, message) => {
            if (!securityAlerts) return;
            securityAlerts.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>`;
        };

        const update2faUI = (enabled, recoveryCount) => {
            twofaEnabled = enabled;
            if (switch2FA) switch2FA.checked = enabled;
            if (twofaLabel) {
                twofaLabel.innerHTML = `<span class="badge ${enabled ? 'bg-success' : 'bg-secondary'}">${enabled ? 'Ativo' : 'Desativado'}</span>`;
            }
            if (twofaHelper) {
                twofaHelper.textContent = enabled
                    ? `Ativo. Códigos de recuperação disponíveis: ${recoveryCount ?? 0}.`
                    : 'Desativado. Recomendamos ativar a verificação em 2 passos.';
            }
        };

        const loadSecurityStatus = async () => {
            try {
                const res = await fetch('/Utilizadores/SecurityStatus');
                if (!res.ok) throw new Error();
                const data = await res.json();
                update2faUI(!!data.twoFactorEnabled, data.recoveryCodes ?? 0);
                await loadNotificationStatus();
                await loadPrivacyStatus();
            } catch {
                update2faUI(false, 0);
                showSecurityAlert('warning', 'Não foi possível verificar o estado de segurança neste momento.');
            }
        };

        const setToggleUI = (el, active) => {
            if (!el) return;
            el.checked = active;
            const label = el.parentElement?.querySelector('label span');
            if (label) {
                label.classList.remove('bg-success', 'bg-secondary');
                label.classList.add(active ? 'bg-success' : 'bg-secondary');
                label.textContent = active ? 'Ativo' : 'Desativado';
            }
        };

        const loadNotificationStatus = async () => {
            try {
                const res = await fetch('/Utilizadores/GetNotificationPreferences');
                if (!res.ok) throw new Error();
                const data = await res.json();
                setToggleUI(switchEmailNotif, !!data.email);
                setToggleUI(switchNovos, !!data.novos);
                setToggleUI(switchPreco, !!data.preco);
                // Newsletter switch
                const switchNewsletter = document.getElementById('switchNewsletter');
                setToggleUI(switchNewsletter, !!data.newsletter);
            } catch {
                showSecurityAlert('warning', 'Não foi possível carregar as preferências de notificação.');
            }
        };

        const saveNotification = async (tipo, ativo) => {
            const token = tokenField();
            const formData = new FormData();
            formData.append('tipo', tipo);
            formData.append('ativo', ativo ? 'true' : 'false');
            if (token) formData.append('__RequestVerificationToken', token);
            const res = await fetch('/Utilizadores/UpdateNotificationPreference', { method: 'POST', body: formData });
            if (!res.ok) {
                showSecurityAlert('danger', 'Não foi possível atualizar notificações.');
                return false;
            }
            return true;
        };

        const bindNotifToggle = (el, tipo) => {
            if (!el) return;
            el.addEventListener('change', async () => {
                const desired = el.checked;
                const ok = await saveNotification(tipo, desired);
                if (ok) {
                    setToggleUI(el, desired);
                    showSecurityAlert('success', `Notificação de ${tipo} ${desired ? 'ativada' : 'desativada'}.`);
                } else {
                    setToggleUI(el, !desired);
                }
            });
        };

        const openTwoFaSetup = async () => {
            const twofaModalEl = document.getElementById('twofaSetupModal');
            if (!twofaModalEl) return;
            const twofaModal = bootstrap.Modal.getOrCreateInstance(twofaModalEl);

            try {
                const res = await fetch('/Utilizadores/TwoFactorSetup');
                if (!res.ok) throw new Error();
                const data = await res.json();
                if (twofaKeyEl) twofaKeyEl.textContent = data.sharedKey || '---';
                if (twofaUriEl) twofaUriEl.textContent = data.authenticatorUri || '';

                // Não carregar QR externo em ambientes restritos; mostrar apenas URI e chave
                if (twofaRecoveryContainer) twofaRecoveryContainer.classList.add('d-none');
                if (twofaRecoveryList) twofaRecoveryList.innerHTML = '';
                if (twofaError) {
                    twofaError.classList.add('d-none');
                    twofaError.textContent = '';
                }
                twofaForm?.reset();
                twofaModal.show();
            } catch {
                showSecurityAlert('danger', 'Não foi possível iniciar a configuração de 2FA. Tente novamente.');
            }
        };

        const disableTwoFa = async () => {
            const token = tokenField();
            const formData = new FormData();
            if (token) formData.append('__RequestVerificationToken', token);
            const res = await fetch('/Utilizadores/DisableTwoFactor', {
                method: 'POST',
                body: formData
            });
            if (!res.ok) {
                showSecurityAlert('danger', 'Não foi possível desativar o 2FA. Tente novamente.');
                update2faUI(true, 0);
                return;
            }
            update2faUI(false, 0);
            showSecurityAlert('success', 'Autenticação de dois fatores desativada.');
        };

        changePwdForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (changePwdError) {
                changePwdError.classList.add('d-none');
                changePwdError.textContent = '';
            }
            const formData = new FormData(changePwdForm);
            const res = await fetch(changePwdForm.action, {
                method: 'POST',
                body: formData
            });
            let data = {};
            try { data = await res.json(); } catch { }

            if (res.ok && data.success) {
                showSecurityAlert('success', data.message || 'Password alterada com sucesso.');
                changePwdForm.reset();
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('alterarPasswordModal'));
                modalInstance?.hide();
            } else {
                const msg = data.error || (data.errors ? data.errors.join('; ') : 'Não foi possível alterar a password.');
                if (changePwdError) {
                    changePwdError.textContent = msg;
                    changePwdError.classList.remove('d-none');
                } else {
                    showSecurityAlert('danger', msg);
                }
            }
        });

        twofaForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (twofaError) {
                twofaError.classList.add('d-none');
                twofaError.textContent = '';
            }
            const formData = new FormData(twofaForm);
            const res = await fetch(twofaForm.action, { method: 'POST', body: formData });
            let data = {};
            try { data = await res.json(); } catch { }

            if (res.ok && data.success) {
                update2faUI(true, data.recoveryCodes?.length ?? 0);
                if (Array.isArray(data.recoveryCodes) && data.recoveryCodes.length > 0) {
                    if (twofaRecoveryList) {
                        twofaRecoveryList.innerHTML = data.recoveryCodes.map(c => `<li>${c}</li>`).join('');
                    }
                    if (twofaRecoveryContainer) {
                        twofaRecoveryContainer.classList.remove('d-none');
                    }
                }
                showSecurityAlert('success', 'Autenticação de dois fatores ativada.');
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('twofaSetupModal'));
                modalInstance?.hide();
            } else {
                const msg = data.error || 'Código inválido. Volte a tentar.';
                if (twofaError) {
                    twofaError.textContent = msg;
                    twofaError.classList.remove('d-none');
                } else {
                    showSecurityAlert('danger', msg);
                }
            }
        });

        if (switch2FA) {
            switch2FA.addEventListener('change', async () => {
                if (switch2FA.checked && !twofaEnabled) {
                    switch2FA.checked = false;
                    await openTwoFaSetup();
                } else if (!switch2FA.checked && twofaEnabled) {
                    if (confirm('Deseja mesmo desativar a autenticação de dois fatores?')) {
                        await disableTwoFa();
                    } else {
                        switch2FA.checked = true;
                    }
                }
            });
        }

        document.getElementById('twofaSetupModal')?.addEventListener('shown.bs.modal', () => {
            const codeInput = twofaForm?.querySelector('input[name="Code"]');
            codeInput?.focus();
        });

        bindNotifToggle(switchEmailNotif, 'email');
        bindNotifToggle(switchNovos, 'novos');
        bindNotifToggle(switchPreco, 'preco');
        const switchNewsletter = document.getElementById('switchNewsletter');
        bindNotifToggle(switchNewsletter, 'newsletter');

        const loadPrivacyStatus = async () => {
            try {
                const res = await fetch('/Utilizadores/PrivacySettings');
                if (!res.ok) throw new Error();
                const data = await res.json();
                setToggleUI(switchPerfilPublico, !!data.perfilPublico);
                setToggleUI(switchMostrarEmail, !!data.mostrarEmail);
            } catch {
                showSecurityAlert('warning', 'Não foi possível carregar as definições de privacidade.');
            }
        };

        const savePrivacy = async (tipo, ativo) => {
            const token = tokenField();
            const formData = new FormData();
            formData.append('tipo', tipo);
            formData.append('ativo', ativo ? 'true' : 'false');
            if (token) formData.append('__RequestVerificationToken', token);
            const res = await fetch('/Utilizadores/SetPrivacy', { method: 'POST', body: formData });
            return res.ok;
        };

        const bindPrivacyToggle = (el, tipo) => {
            if (!el) return;
            el.addEventListener('change', async () => {
                const desired = el.checked;
                const ok = await savePrivacy(tipo, desired);
                if (ok) {
                    setToggleUI(el, desired);
                    showSecurityAlert('success', `Privacidade (${tipo}) ${desired ? 'ativada' : 'desativada'}.`);
                } else {
                    setToggleUI(el, !desired);
                    showSecurityAlert('danger', 'Não foi possível atualizar privacidade.');
                }
            });
        };

        bindPrivacyToggle(switchPerfilPublico, 'perfil');
        bindPrivacyToggle(switchMostrarEmail, 'email');

        btnSessions?.addEventListener('click', () => {
            if (sessionsFeedback) sessionsFeedback.innerHTML = '';
            sessionsModal?.show();
        });

        btnTerminateSessions?.addEventListener('click', async () => {
            if (!btnTerminateSessions) return;
            btnTerminateSessions.disabled = true;
            const token = tokenField();
            const formData = new FormData();
            if (token) formData.append('__RequestVerificationToken', token);

            try {
                const res = await fetch('/Utilizadores/TerminateOtherSessions', { method: 'POST', body: formData });
                let data = {};
                try { data = await res.json(); } catch { }
                if (res.ok && data.success) {
                    if (sessionsFeedback) {
                        sessionsFeedback.innerHTML = `<div class="alert alert-success">Sessões terminadas. Se tinha sessões noutros dispositivos, as respetivas credenciais foram invalidadas.</div>`;
                    }
                } else {
                    if (sessionsFeedback) {
                        sessionsFeedback.innerHTML = `<div class="alert alert-danger">${data.error || 'Não foi possível terminar sessões.'}</div>`;
                    }
                }
            } catch {
                if (sessionsFeedback) sessionsFeedback.innerHTML = `<div class="alert alert-danger">Erro ao terminar sessões.</div>`;
            } finally {
                btnTerminateSessions.disabled = false;
            }
        });

        loadSecurityStatus();
    });
</script>
<script>
    // JavaScript adicional para manejar remoção de favoritos na página de perfil
    document.addEventListener('DOMContentLoaded', function () {
        // Confirmação antes de remover favorito (formulário)
        document.querySelectorAll('.remove-favorito-form-perfil').forEach(form => {
            form.addEventListener('submit', function (e) {
                if (!confirm('Tem certeza que deseja remover este anúncio dos favoritos?')) {
                    e.preventDefault();
                }
            });
        });

        // Adicionar evento customizado para atualizar UI quando favorito é removido via AJAX
        document.addEventListener('favoritoRemoved', function (e) {
            const anuncioId = e.detail.anuncioId;
            const card = document.querySelector(`[data-favorito-id] .btn-favorito[data-anuncio-id="${anuncioId}"]`)?.closest('[data-favorito-id]');

            if (card) {
                // Remove o card com animação
                card.style.transition = 'opacity 0.3s ease';
                card.style.opacity = '0';

                setTimeout(() => {
                    card.remove();

                    // Atualiza contadores
                    const remainingCards = document.querySelectorAll('#favoritos-container-perfil [data-favorito-id]').length;
                    document.getElementById('favoritos-badge-nav').textContent = remainingCards;
                    document.getElementById('favoritos-count-perfil').textContent = remainingCards;

                    // Se não houver mais favoritos, mostra empty state
                    if (remainingCards === 0) {
                        const container = document.getElementById('favoritos-container-perfil');
                        if (container) {
                            container.innerHTML = `
                                <div class="favoritos-empty text-center py-5">
                                    <div class="mb-4">
                                        <i class="bi bi-heart" style="font-size: 4rem; color: #e2e8f0;"></i>
                                    </div>
                                    <h4 class="text-muted mb-2">Ainda não tem favoritos</h4>
                                    <p class="text-muted mb-4">Guarde os anúncios que mais gosta para acesso rápido</p>
                                    <a href="/Anuncios" class="btn btn-primary">
                                        <i class="bi bi-search me-2"></i>Explorar Anúncios
                                    </a>
                                </div>
                            `;
                        }
                    }
                }, 300);
            }
        });

        // Sobrescrever função de toggle do favoritos.js para disparar evento customizado
        const originalToggle = window.FavoritosApp?.toggleFavorito;
        if (originalToggle && typeof originalToggle === 'function') {
            window.FavoritosApp.toggleFavorito = async function (anuncioId, button) {
                const result = await originalToggle.call(this, anuncioId, button);

                // Disparar evento customizado quando favorito é removido
                if (result && !result.adicionado) {
                    document.dispatchEvent(new CustomEvent('favoritoRemoved', {
                        detail: { anuncioId: anuncioId }
                    }));
                }

                return result;
            };
        }
    });
</script>

<script>
    // Função para editar disponibilidade
    function editarDisponibilidade(id, nomeDia, diaSemana, horaInicio, horaFim, intervalo, ativo, vendedorId, dataCriacao) {
        document.getElementById('editId').value = id;
        document.getElementById('editDiaSemana').value = diaSemana;
        document.getElementById('editHoraInicio').value = horaInicio;
        document.getElementById('editHoraFim').value = horaFim;
        document.getElementById('editIntervaloMinutos').value = intervalo;
        document.getElementById('editAtivo').checked = ativo;
        document.getElementById('editVendedorId').value = vendedorId;
        document.getElementById('editDataCriacao').value = dataCriacao;

        // Mostrar modal
        var modal = new bootstrap.Modal(document.getElementById('modalEditarDisponibilidade'));
        modal.show();
    }

    // ===== UPLOAD DE FOTO DE PERFIL =====
    document.addEventListener('DOMContentLoaded', function() {
        // Abrir modal ao clicar no botão da câmera
        const btnCamera = document.querySelector('.perfil-avatar-edit');
        if (btnCamera) {
            btnCamera.addEventListener('click', function(e) {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('modalFotoPerfil'));
                modal.show();
            });
        }

        // Preview da imagem quando selecionar
        const inputFoto = document.getElementById('inputFotoPerfil');
        if (inputFoto) {
            inputFoto.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validar tamanho (2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        alert('A imagem é muito grande! Tamanho máximo: 2MB');
                        inputFoto.value = '';
                        return;
                    }

                    // Preview
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('previewFotoPerfil').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Submit form de foto via AJAX
        const formFoto = document.getElementById('formFotoPerfil');
        if (formFoto) {
            formFoto.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const btnSubmit = this.querySelector('button[type="submit"]');
                const erroDiv = document.getElementById('erroUploadFoto');

                erroDiv.classList.add('d-none');
                btnSubmit.disabled = true;
                btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>A carregar...';

                try {
                    const response = await fetch('@Url.Action("UploadFotoPerfil", "Utilizadores")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Atualizar imagem no avatar do sidebar
                        const avatarImg = document.querySelector('.perfil-avatar');
                        if (avatarImg) {
                            avatarImg.src = result.imagemUrl + '?t=' + new Date().getTime();
                        }

                        // Fechar modal
                        bootstrap.Modal.getInstance(document.getElementById('modalFotoPerfil')).hide();

                        // Mostrar mensagem de sucesso
                        alert('Foto de perfil atualizada com sucesso!');
                    } else {
                        erroDiv.textContent = result.message || 'Erro ao carregar imagem';
                        erroDiv.classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    erroDiv.textContent = 'Erro ao comunicar com o servidor';
                    erroDiv.classList.remove('d-none');
                } finally {
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = '<i class="bi bi-upload me-2"></i>Guardar Foto';
                }
            });
        }

        // ===== PEDIDO PARA TORNAR-SE VENDEDOR =====
        const formVendedor = document.getElementById('formTornarVendedor');
        if (formVendedor) {
            formVendedor.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const btnSubmit = this.querySelector('button[type="submit"]');
                const erroDiv = document.getElementById('erroTornarVendedor');
                const sucessoDiv = document.getElementById('sucessoTornarVendedor');

                erroDiv.classList.add('d-none');
                sucessoDiv.classList.add('d-none');
                btnSubmit.disabled = true;
                btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>A enviar...';

                try {
                    const response = await fetch('@Url.Action("PedirSerVendedor", "Utilizadores")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        sucessoDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i>' + (result.message || 'Pedido enviado com sucesso!');
                        sucessoDiv.classList.remove('d-none');

                        // Limpar form
                        formVendedor.reset();

                        // Fechar modal após 2 segundos
                        setTimeout(() => {
                            bootstrap.Modal.getInstance(document.getElementById('modalTornarVendedor')).hide();
                            location.reload(); // Recarregar página para atualizar estado
                        }, 2000);
                    } else {
                        erroDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>' + (result.message || 'Erro ao enviar pedido');
                        erroDiv.classList.remove('d-none');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    erroDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Erro ao comunicar com o servidor';
                    erroDiv.classList.remove('d-none');
                } finally {
                    btnSubmit.disabled = false;
                    btnSubmit.innerHTML = '<i class="bi bi-send me-2"></i>Enviar Pedido';
                }
            });
        }
    });
</script>
}

<!-- Modal Selecionar Marcas -->
<div class="modal fade" id="modalSelecionarMarcas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-tags-fill text-primary me-2"></i>Gerir Marcas Favoritas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4 position-relative">
                    <input type="text" id="paramsSearchMarcas" class="form-control ps-5" placeholder="Pesquisar marcas...">
                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                </div>
                
                <div id="loadingMarcas" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">A carregar...</span>
                    </div>
                </div>

                <div id="containerMarcas" class="row g-3" style="display: none;">
                    <!-- Marcas injetadas via JS -->
                </div>
                
                <div id="emptyMarcas" class="text-center py-5 d-none">
                    <p class="text-muted">Nenhuma marca encontrada com esse nome.</p>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modalMarcas = document.getElementById('modalSelecionarMarcas');
        const containerMarcas = document.getElementById('containerMarcas');
        const searchInput = document.getElementById('paramsSearchMarcas');
        const loadingDiv = document.getElementById('loadingMarcas');
        const emptyDiv = document.getElementById('emptyMarcas');
        let brandsData = [];
        let hasChanges = false;

        if (modalMarcas) {
            modalMarcas.addEventListener('show.bs.modal', function() {
                loadBrands();
            });

            modalMarcas.addEventListener('hidden.bs.modal', function() {
                if (hasChanges) {
                    window.location.reload();
                }
            });
        }

        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                filterBrands(term);
            });
        }

        async function loadBrands() {
            loadingDiv.style.display = 'block';
            containerMarcas.style.display = 'none';
            emptyDiv.classList.add('d-none');
            
            try {
                const response = await fetch('/Favoritos/GetBrandsForSelection');
                const data = await response.json();
                
                if (data.success) {
                    brandsData = data.brands;
                    renderBrands(brandsData);
                } else {
                    console.error('Erro ao carregar marcas:', data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
            } finally {
                loadingDiv.style.display = 'none';
                containerMarcas.style.display = 'flex';
            }
        }

        function renderBrands(brands) {
            containerMarcas.innerHTML = '';
            
            if (brands.length === 0) {
                emptyDiv.classList.remove('d-none');
                return;
            } else {
                emptyDiv.classList.add('d-none');
            }

            brands.forEach(brand => {
                const div = document.createElement('div');
                div.className = 'col-md-4 col-sm-6';
                
                const isFav = brand.isFavorito;
                const btnClass = isFav ? 'btn-danger' : 'btn-outline-secondary';
                const iconClass = isFav ? 'bi-heart-fill' : 'bi-heart';
                const text = isFav ? 'Remover' : 'Seguir';
                
                div.innerHTML = `
                    <div class="card h-100 shadow-sm border-0 bg-light brand-item">
                        <div class="card-body d-flex align-items-center justify-content-between p-3">
                            <div class="d-flex align-items-center overflow-hidden">
                                <div class="rounded-circle bg-white shadow-sm d-flex align-items-center justify-content-center me-3 flex-shrink-0" style="width: 40px; height: 40px;">
                                    <i class="bi bi-car-front-fill text-secondary"></i>
                                </div>
                                <h6 class="mb-0 fw-bold text-truncate" title="${brand.nome}">${brand.nome}</h6>
                            </div>
                            <button class="btn btn-sm ${btnClass} btn-toggle-fav rounded-pill px-3" data-id="${brand.id}" onclick="toggleBrandFav(${brand.id}, this)">
                                <i class="bi ${iconClass}"></i>
                            </button>
                        </div>
                    </div>
                `;
                containerMarcas.appendChild(div);
            });
        }

        function filterBrands(term) {
            const filtered = brandsData.filter(b => b.nome.toLowerCase().includes(term));
            renderBrands(filtered);
        }

        // Expor para o global para ser chamado pelo onclick
        window.toggleBrandFav = async function(id, btn) {
            // Estado visual otimista
            const isFav = btn.classList.contains('btn-danger');
            
            // Toggle visual imediato
            updateBtnVisual(btn, !isFav);

            try {
                const response = await fetch('/Favoritos/ToggleMarca', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(id)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    hasChanges = true;
                    // Atualiza o dado em memória para que o filtro funcione corretamente
                    const brand = brandsData.find(b => b.id === id);
                    if (brand) brand.isFavorito = !isFav;
                } else {
                    // Reverte se der erro
                    updateBtnVisual(btn, isFav);
                    console.error(result.message);
                }
            } catch (error) {
                // Reverte se der erro
                updateBtnVisual(btn, isFav);
                console.error(error);
            }
        };

        function updateBtnVisual(btn, isActive) {
            if (isActive) {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-danger', 'heart-beat');
                btn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                setTimeout(() => btn.classList.remove('heart-beat'), 300);
            } else {
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-secondary');
                btn.innerHTML = '<i class="bi bi-heart"></i>';
            }
        }
    });
</script>

<style>
    .brand-item { transition: transform 0.2s; }
    .brand-item:hover { transform: translateY(-2px); }
    
    @@keyframes heartBeat {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }
    .heart-beat i {
        animation: heartBeat 0.3s ease-in-out;
        display: inline-block;
    }
</style>
