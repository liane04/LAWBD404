@{
    ViewData["Title"] = "Meu Perfil";
}

<div class="container mt-5 pt-5 mb-5 pb-5">
    <div class="row g-4">
        <!-- Barra Lateral de Navegação do Perfil -->
        <div class="col-lg-3">
            <div class="perfil-sidebar card shadow-sm border-0">
                <div class="card-body p-0">
                    <!-- Cabeçalho do Perfil -->
                    <div class="perfil-header text-center p-4">
                        <div class="perfil-avatar-wrapper position-relative d-inline-block mb-3">
                            <img src="@((ViewBag.ImagemPerfil as string) ?? Url.Content("~/imagens/logo.png"))"
                                 class="perfil-avatar rounded-circle"
                                 alt="Foto de Perfil">
                            <button class="perfil-avatar-edit btn btn-sm btn-primary rounded-circle position-absolute">
                                <i class="bi bi-camera-fill"></i>
                            </button>
                        </div>
                        <h5 class="mb-2 fw-bold">João Duarte Silva</h5>
                        <div class="perfil-user-badges mb-2">
                            @if (User.IsInRole("Comprador"))
                            {
                                <span class="perfil-badge perfil-badge-comprador">
                                    <i class="bi bi-person-check-fill"></i> Comprador
                                </span>
                            }
                            @if (User.IsInRole("Vendedor"))
                            {
                                <span class="perfil-badge perfil-badge-vendedor">
                                    <i class="bi bi-shop"></i> Vendedor
                                </span>
                            }
                            @if (User.IsInRole("Administrador"))
                            {
                                <span class="perfil-badge perfil-badge-admin">
                                    <i class="bi bi-shield-check"></i> Administrador
                                </span>
                            }
                        </div>
                        <small class="perfil-member-since">
                            <i class="bi bi-calendar-check me-1"></i>Membro desde Out 2025
                        </small>
                    </div>

                    <hr class="m-0">

                    <!-- Menu de Navegação -->
                    <div class="perfil-nav-menu">
                        <a href="#dados-pessoais" class="perfil-nav-item active" data-bs-toggle="tab">
                            <i class="bi bi-person-fill"></i>
                            <span>Dados Pessoais</span>
                            <i class="bi bi-chevron-right ms-auto"></i>
                        </a>
                        @if (User.IsInRole("Vendedor"))
                        {
                            <a href="#meus-anuncios" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-card-list"></i>
                                <span>Meus Anúncios</span>
                                <span class="badge bg-primary rounded-pill ms-auto">@((ViewBag.AnunciosCount ?? 0))</span>
                            </a>
                            <a href="#reservas-recebidas" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-bookmark-check-fill"></i>
                                <span>Reservas Recebidas</span>
                                <span class="badge bg-success rounded-pill ms-auto">@((ViewBag.ReservasRecebidasCount ?? 0))</span>
                            </a>
                            <a href="#visitas-agendadas-vendedor" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-calendar-event"></i>
                                <span>Visitas Agendadas</span>
                                <span class="badge bg-info rounded-pill ms-auto">@((ViewBag.VisitasAgendadasCount ?? 0))</span>
                            </a>
                        }
                        @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                        {
                            <a href="#favoritos" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-heart-fill"></i>
                                <span>Anúncios Favoritos</span>
                                <span class="badge bg-danger rounded-pill ms-auto" id="favoritos-badge-nav">@(ViewBag.FavoritosCount ?? 0)</span>
                            </a>
                        }
                        @if (User.IsInRole("Comprador"))
                        {
                            <a href="#minhas-reservas" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-bookmark-star-fill"></i>
                                <span>Minhas Reservas</span>
                                <span class="badge bg-warning rounded-pill ms-auto">1</span>
                            </a>
                            <a href="#minhas-visitas" class="perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-calendar-check-fill"></i>
                                <span>Minhas Visitas</span>
                                <span class="badge bg-info rounded-pill ms-auto">1</span>
                            </a>
                        }
                        <a href="#definicoes" class="perfil-nav-item" data-bs-toggle="tab">
                            <i class="bi bi-gear-fill"></i>
                            <span>Definições</span>
                            <i class="bi bi-chevron-right ms-auto"></i>
                        </a>
                    </div>

                    <hr class="m-0">

                    <!-- Botão de Sair -->
                    <div class="p-3">
                        <a asp-controller="Home" asp-action="Index" class="perfil-logout-btn btn btn-outline-danger w-100">
                            <i class="bi bi-box-arrow-right me-2"></i>Terminar Sessão
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conteúdo do Perfil -->
        <div class="col-lg-9">
            <!-- Mensagens de Feedback -->
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>@TempData["Error"]</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }
            @if (TempData["PerfilSucesso"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>@TempData["PerfilSucesso"]</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @* Aviso permanente para vendedores pendentes *@
            @if (User.IsInRole("Vendedor") && ViewBag.VendedorEstado != null && ViewBag.VendedorEstado != "Ativo")
            {
                <div class="alert alert-warning border-0 shadow-sm" role="alert">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="alert-heading mb-2">
                                <i class="bi bi-info-circle-fill me-2"></i>Conta Pendente de Aprovação
                            </h5>
                            <p class="mb-0">
                                A sua conta de vendedor está pendente de aprovação pelo administrador.
                                Assim que for aprovada, receberá um email de confirmação e poderá começar a criar anúncios.
                            </p>
                        </div>
                    </div>
                </div>
            }

            <div class="tab-content">
                <!-- Aba: Dados Pessoais -->
                <div class="tab-pane fade show active" id="dados-pessoais">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-person-circle text-primary me-2"></i>Dados Pessoais
                            </h3>
                            <p class="text-muted mb-0">Gerir as suas informações pessoais e de contacto</p>
                        </div>
                        <a asp-action="Edit" class="btn btn-primary">
                            <i class="bi bi-pencil-square me-2"></i>Editar Perfil
                        </a>
                    </div>

                    <!-- Informações Pessoais -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-info-circle text-primary me-2"></i>Informação Pessoal
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-person-badge"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Nome Completo</label>
                                            <p class="perfil-info-value">João Duarte Silva</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-at"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Username</label>
                                            <p class="perfil-info-value">joao.silva</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-envelope"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Email</label>
                                            <p class="perfil-info-value">joao.silva@exemplo.com</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-shield-check"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Estado da Conta</label>
                                            <p class="perfil-info-value">
                                                <span class="badge bg-success-subtle text-success">
                                                    <i class="bi bi-check-circle-fill me-1"></i>Ativo
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informações de Contacto -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-telephone text-primary me-2"></i>Contactos
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-phone"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Telemóvel</label>
                                            <p class="perfil-info-value">+351 912 345 678</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-telephone-fill"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Telefone Alternativo</label>
                                            <p class="perfil-info-value text-muted">Não definido</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Morada -->
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-geo-alt text-primary me-2"></i>Morada
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-4">
                                <div class="col-md-8">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-house-door"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Rua</label>
                                            <p class="perfil-info-value">Rua Dr. Manuel Cardona, nº 123, 2º Esq.</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-mailbox"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Código Postal</label>
                                            <p class="perfil-info-value">5000-558</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-pin-map"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">Localidade</label>
                                            <p class="perfil-info-value">Vila Real</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="perfil-info-item">
                                        <div class="perfil-info-icon">
                                            <i class="bi bi-flag"></i>
                                        </div>
                                        <div class="perfil-info-content">
                                            <label class="perfil-info-label">País</label>
                                            <p class="perfil-info-value">Portugal</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @if (User.IsInRole("Vendedor"))
                {
                    <!-- Aba: Meus Anúncios (para Vendedores) -->
                    <div class="tab-pane fade" id="meus-anuncios">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-card-list text-primary me-2"></i>Meus Anúncios
                            </h3>
                            <p class="text-muted mb-0">Gerir os seus veículos anunciados na plataforma</p>
                        </div>
                        <a asp-controller="Anuncios" asp-action="Create" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>Criar Novo Anúncio
                        </a>
                    </div>

                    <!-- Filtros/Tabs de Estado -->
                    <div class="anuncios-filter-tabs mb-4">
                        <button class="anuncios-filter-btn active" data-filter="todos">
                            <i class="bi bi-grid-fill me-1"></i>Todos <span class="badge bg-primary ms-1">5</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter="ativo">
                            <i class="bi bi-check-circle-fill me-1"></i>Ativos <span class="badge bg-success ms-1">2</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter="reservado">
                            <i class="bi bi-bookmark-check-fill me-1"></i>Reservados <span class="badge bg-warning ms-1">1</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter="vendido">
                            <i class="bi bi-check2-circle me-1"></i>Vendidos <span class="badge bg-info ms-1">2</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter="pausado">
                            <i class="bi bi-pause-circle-fill me-1"></i>Pausados <span class="badge bg-secondary ms-1">0</span>
                        </button>
                    </div>

                    <!-- Lista de Anúncios -->
                    <div class="anuncios-list">
                        @await Html.PartialAsync("_MeusAnunciosList", ViewBag.MeusAnuncios as IEnumerable<Marketplace.Models.Anuncio>)
                        <div class="mt-3">
                            <a asp-controller="Utilizadores" asp-action="Edit" class="btn btn-outline-primary">
                                <i class="bi bi-person-gear me-1"></i> Editar Perfil
                            </a>
                        </div>
                    </div>

                    <!-- Estado Vazio (quando filtrado e sem resultados) -->
                    <div class="anuncios-empty text-center py-5 d-none">
                        <div class="mb-4">
                            <i class="bi bi-inbox" style="font-size: 4rem; color: #e2e8f0;"></i>
                        </div>
                        <h4 class="text-muted mb-2">Nenhum anúncio encontrado</h4>
                        <p class="text-muted mb-4">Não tem anúncios com este estado</p>
                    </div>
                    </div>

                    <!-- Aba: Reservas Recebidas (para Vendedores) -->
                    <div class="tab-pane fade" id="reservas-recebidas">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-bookmark-check-fill text-success me-2"></i>Reservas Recebidas
                            </h3>
                            <p class="text-muted mb-0">Gerir reservas recebidas nos seus anúncios</p>
                        </div>
                        <div class="reservas-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-success fw-bold">1</div>
                                <div class="stat-label text-muted small">Ativa</div>
                            </div>
                            <div class="stat-item text-center">
                                <div class="stat-value text-primary fw-bold">500€</div>
                                <div class="stat-label text-muted small">Em Sinais</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros de Status -->
                    <div class="anuncios-filter-tabs mb-4">
                        <button class="anuncios-filter-btn active" data-filter-reservas-vendedor="todas">
                            <i class="bi bi-grid-fill me-1"></i>Todas <span class="badge bg-primary ms-1">1</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter-reservas-vendedor="pendentes">
                            <i class="bi bi-clock-fill me-1"></i>Aguardam Confirmação <span class="badge bg-warning ms-1">0</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter-reservas-vendedor="ativas">
                            <i class="bi bi-check-circle-fill me-1"></i>Ativas <span class="badge bg-success ms-1">1</span>
                        </button>
                        <button class="anuncios-filter-btn" data-filter-reservas-vendedor="expiradas">
                            <i class="bi bi-x-circle-fill me-1"></i>Expiradas <span class="badge bg-secondary ms-1">0</span>
                        </button>
                    </div>

                    <!-- Lista de Reservas -->
                    <div class="reservas-vendedor-list">
                        <!-- Reserva Ativa -->
                        <div class="card shadow-sm border-success mb-3" data-status-reserva-vendedor="ativa">
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-auto">
                                        <img src="~/imagens/bmwSerie1.jpg" alt="BMW Série 1" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                    </div>
                                    <div class="col">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h5 class="mb-1 fw-bold">Reserva: BMW Série 1 116d</h5>
                                                <p class="text-muted mb-2 small">Seu anúncio • Preço: 15.900€</p>
                                            </div>
                                            <span class="badge bg-success fs-6">
                                                <i class="bi bi-check-circle-fill me-1"></i>Ativa
                                            </span>
                                        </div>

                                        <div class="row g-3 mb-3">
                                            <div class="col-md-3">
                                                <p class="text-muted mb-0 small">Data da Reserva:</p>
                                                <p class="mb-0 fw-semibold">23/10/2025 14:32</p>
                                            </div>
                                            <div class="col-md-3">
                                                <p class="text-muted mb-0 small">Expira em:</p>
                                                <p class="mb-0 fw-semibold text-danger">
                                                    <i class="bi bi-hourglass-split me-1"></i>18 horas
                                                </p>
                                            </div>
                                            <div class="col-md-3">
                                                <p class="text-muted mb-0 small">Sinal Recebido:</p>
                                                <p class="mb-0 fw-bold text-success fs-5">500€</p>
                                            </div>
                                            <div class="col-md-3">
                                                <p class="text-muted mb-0 small">Método Pagamento:</p>
                                                <p class="mb-0 fw-semibold">MB WAY</p>
                                            </div>
                                        </div>

                                        <div class="alert alert-warning mb-3 small">
                                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                            <strong>Ação necessária:</strong> Entre em contacto com o comprador nas próximas 24h para acordar os detalhes da venda.
                                        </div>

                                        <div class="reserva-comprador mb-3 p-3 bg-light rounded">
                                            <h6 class="mb-2 small fw-bold">
                                                <i class="bi bi-person-badge me-1"></i>Comprador
                                            </h6>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <img src="https://placehold.co/50x50/0d6efd/ffffff?text=JS" class="rounded-circle me-3" alt="João Silva">
                                                    <div>
                                                        <p class="mb-0 fw-semibold">João Duarte Silva</p>
                                                        <p class="mb-0 small text-muted">
                                                            <i class="bi bi-envelope me-1"></i>joao.silva@exemplo.com •
                                                            <i class="bi bi-telephone-fill me-1"></i>+351 912 345 678
                                                        </p>
                                                    </div>
                                                </div>
                                                <span class="badge bg-success-subtle text-success">
                                                    <i class="bi bi-shield-check me-1"></i>Verificado
                                                </span>
                                            </div>
                                            <div class="mt-2 p-2 bg-white rounded border">
                                                <p class="mb-0 small"><strong>Mensagem do comprador:</strong></p>
                                                <p class="mb-0 small text-muted">"Boa tarde, tenho muito interesse no veículo. Estou disponível para visitar nos próximos dias. Aguardo o vosso contacto."</p>
                                            </div>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <a asp-controller="Anuncios" asp-action="Details" class="btn btn-primary">
                                                <i class="bi bi-eye me-1"></i>Ver Anúncio
                                            </a>
                                            <button class="btn btn-success">
                                                <i class="bi bi-chat-dots-fill me-1"></i>Contactar Comprador
                                            </button>
                                            <button class="btn btn-info text-white">
                                                <i class="bi bi-calendar-plus me-1"></i>Agendar Visita
                                            </button>
                                            <button class="btn btn-outline-danger ms-auto">
                                                <i class="bi bi-x-circle me-1"></i>Cancelar Reserva
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estado Vazio -->
                    <div class="reservas-vendedor-empty text-center py-5 d-none">
                        <div class="mb-4">
                            <i class="bi bi-bookmark-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                        </div>
                        <h4 class="text-muted mb-2">Sem reservas recebidas</h4>
                        <p class="text-muted mb-4">Quando alguém reservar um dos seus veículos, aparecerá aqui</p>
                        <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                            <i class="bi bi-grid-3x3-gap me-2"></i>Ver Meus Anúncios
                        </a>
                    </div>
                </div>

                    var visitasVendedor = ViewBag.MinhasVisitasVendedor as List<Marketplace.Models.Visita> ?? new List<Marketplace.Models.Visita>();
                    var totalVisitasVend = visitasVendedor.Count;
                    var visitasPendentesVend = visitasVendedor.Count(v => v.Estado == "Pendente");
                    var visitasConfirmadasVend = visitasVendedor.Count(v => v.Estado == "Confirmada");
                    var visitasConcluidasVend = visitasVendedor.Count(v => v.Estado == "Concluída");
                    <!-- Aba: Visitas Agendadas Vendedor (para Vendedores) -->
                <div class="tab-pane fade" id="visitas-agendadas-vendedor">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-calendar-event text-info me-2"></i>Visitas Agendadas
                            </h3>
                            <p class="text-muted mb-0">Visitas agendadas aos seus veículos</p>
                        </div>
                        <div class="visitas-vendedor-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-warning fw-bold">@visitasPendentesVend</div>
                                <div class="stat-label text-muted small">Pendente</div>
                            </div>
                            <div class="stat-item text-center">
                                <div class="stat-value text-success fw-bold">@visitasConfirmadasVend</div>
                                <div class="stat-label text-muted small">Confirmada</div>
                            </div>
                        </div>
                    </div>

                    @if (visitasVendedor.Any())
                    {
                        <!-- Filtros de Status - Horizontal -->
                        <div class="d-flex gap-2 mb-4 flex-wrap">
                            <button class="btn btn-outline-primary active" data-filter-visitas-vendedor="todas">
                                <i class="bi bi-grid-fill me-1"></i>Todas <span class="badge bg-primary ms-1">@totalVisitasVend</span>
                            </button>
                            <button class="btn btn-outline-warning" data-filter-visitas-vendedor="Pendente">
                                <i class="bi bi-clock-fill me-1"></i>Aguardam Confirmação <span class="badge bg-warning ms-1">@visitasPendentesVend</span>
                            </button>
                            <button class="btn btn-outline-success" data-filter-visitas-vendedor="Confirmada">
                                <i class="bi bi-check-circle-fill me-1"></i>Confirmadas <span class="badge bg-success ms-1">@visitasConfirmadasVend</span>
                            </button>
                            <button class="btn btn-outline-secondary" data-filter-visitas-vendedor="Concluída">
                                <i class="bi bi-archive-fill me-1"></i>Concluídas <span class="badge bg-secondary ms-1">@visitasConcluidasVend</span>
                            </button>
                        </div>

                        <!-- Lista de Visitas -->
                        <div class="visitas-vendedor-list">
                            @foreach (var visita in visitasVendedor)
                            {
                                var anuncio = visita.Anuncio;
                                var imagemPrincipal = anuncio.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/default-car.jpg";
                                var marcaModelo = $"{anuncio.Marca?.Nome} {anuncio.Modelo?.Nome}";
                                var badgeClass = visita.Estado switch
                                {
                                    "Confirmada" => "bg-success",
                                    "Pendente" => "bg-warning text-dark",
                                    "Concluída" => "bg-secondary",
                                    "Cancelada" => "bg-danger",
                                    _ => "bg-info"
                                };
                                var borderClass = visita.Estado switch
                                {
                                    "Confirmada" => "border-success",
                                    "Pendente" => "border-warning",
                                    "Concluída" => "border-secondary",
                                    "Cancelada" => "border-danger",
                                    _ => "border-info"
                                };

                                <div class="card shadow-sm @borderClass mb-3" data-status-visita-vendedor="@visita.Estado">
                                    <div class="card-body p-4">
                                        <div class="row g-3">
                                            <div class="col-auto">
                                                <img src="@imagemPrincipal" alt="@anuncio.Titulo" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                            </div>
                                            <div class="col">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h5 class="mb-1 fw-bold">Visita: @anuncio.Titulo</h5>
                                                        <p class="text-muted mb-2 small">
                                                            Seu anúncio • @marcaModelo • Preço: @anuncio.Preco.ToString("N0")€
                                                        </p>
                                                    </div>
                                                    <span class="badge @badgeClass fs-6">
                                                        @if (visita.Estado == "Confirmada")
                                                        {
                                                            <i class="bi bi-check-circle-fill me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Pendente")
                                                        {
                                                            <i class="bi bi-clock-fill me-1"></i><text>Aguarda Confirmação</text>
                                                        }
                                                        else if (visita.Estado == "Concluída")
                                                        {
                                                            <i class="bi bi-check-all me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Cancelada")
                                                        {
                                                            <i class="bi bi-x-circle-fill me-1"></i>
                                                        }
                                                        @if (visita.Estado != "Pendente")
                                                        {
                                                            @visita.Estado
                                                        }
                                                    </span>
                                                </div>

                                                <div class="row g-3 mb-3">
                                                    <div class="col-md-4">
                                                        <p class="text-muted mb-0 small">@(visita.Estado == "Pendente" ? "Data Solicitada:" : "Data e Hora:")</p>
                                                        <p class="mb-0 fw-bold @(visita.Estado == "Confirmada" ? "text-success" : "text-primary")">
                                                            <i class="bi bi-calendar-event me-1"></i>@visita.Data.ToString("dd/MM/yyyy 'às' HH:mm")
                                                        </p>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                    {
                                                        <div class="col-md-8">
                                                            <p class="text-muted mb-0 small">Local @(visita.Estado == "Pendente" ? "Sugerido" : ""):</p>
                                                            <p class="mb-0 fw-semibold">@anuncio.Localizacao</p>
                                                        </div>
                                                    }
                                                </div>

                                                @if (visita.Estado == "Pendente")
                                                {
                                                    <div class="alert alert-warning mb-3 small">
                                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                                        <strong>Ação necessária:</strong> Confirme ou proponha uma data alternativa para a visita.
                                                    </div>
                                                }
                                                else if (visita.Estado == "Confirmada")
                                                {
                                                    <div class="alert alert-success mb-3 small">
                                                        <i class="bi bi-check-circle-fill me-2"></i>
                                                        <strong>Visita confirmada.</strong> Prepare toda a documentação do veículo e esteja disponível no local combinado.
                                                    </div>
                                                }

                                                <div class="visita-comprador-info mb-3 p-3 bg-light rounded">
                                                    <h6 class="mb-2 small fw-bold">
                                                        <i class="bi bi-person-badge me-1"></i>Interessado
                                                    </h6>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="d-flex align-items-center">
                                                            @if (!string.IsNullOrEmpty(visita.Comprador?.ImagemPerfil))
                                                            {
                                                                <img src="@visita.Comprador.ImagemPerfil" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="@visita.Comprador.Nome">
                                                            }
                                                            else
                                                            {
                                                                <div class="rounded-circle me-3 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                    <i class="bi bi-person-fill fs-4"></i>
                                                                </div>
                                                            }
                                                            <div>
                                                                <p class="mb-0 fw-semibold">@visita.Comprador?.Nome</p>
                                                                <p class="mb-0 small text-muted">
                                                                    @if (!string.IsNullOrEmpty(visita.Comprador?.Email))
                                                                    {
                                                                        <i class="bi bi-envelope me-1"></i>@visita.Comprador.Email
                                                                    }
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(visita.Observacoes))
                                                    {
                                                        <div class="mt-2 p-2 bg-white rounded border">
                                                            <p class="mb-0 small"><strong>Observações:</strong></p>
                                                            <p class="mb-0 small text-muted">"@visita.Observacoes"</p>
                                                        </div>
                                                    }
                                                </div>

                                                <div class="d-flex gap-2 flex-wrap">
                                                    <a asp-controller="Visitas" asp-action="Details" asp-route-id="@visita.Id" class="btn btn-sm btn-info text-white">
                                                        <i class="bi bi-eye me-1"></i>Ver Detalhes
                                                    </a>
                                                    <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-car-front me-1"></i>Ver Anúncio
                                                    </a>
                                                    @if (visita.Estado == "Pendente")
                                                    {
                                                        <form asp-controller="Visitas" asp-action="Confirmar" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <button type="submit" class="btn btn-sm btn-success">
                                                                <i class="bi bi-check-circle-fill me-1"></i>Confirmar Visita
                                                            </button>
                                                        </form>
                                                        <a asp-controller="Visitas" asp-action="Edit" asp-route-id="@visita.Id" class="btn btn-sm btn-outline-info">
                                                            <i class="bi bi-calendar-x me-1"></i>Propor Outra Data
                                                        </a>
                                                        <form asp-controller="Visitas" asp-action="Cancelar" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja recusar esta visita?')">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <input type="hidden" name="motivo" value="Recusado pelo vendedor" />
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                <i class="bi bi-x-circle me-1"></i>Recusar
                                                            </button>
                                                        </form>
                                                    }
                                                    else if (visita.Estado == "Confirmada")
                                                    {
                                                        <a asp-controller="Visitas" asp-action="Edit" asp-route-id="@visita.Id" class="btn btn-sm btn-outline-warning">
                                                            <i class="bi bi-calendar-x me-1"></i>Remarcar
                                                        </a>
                                                        <form asp-controller="Visitas" asp-action="Concluir" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <button type="submit" class="btn btn-sm btn-outline-success">
                                                                <i class="bi bi-check-all me-1"></i>Marcar como Concluída
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Estado Vazio -->
                        <div class="visitas-vendedor-empty text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                            </div>
                            <h4 class="text-muted mb-2">Sem visitas agendadas</h4>
                            <p class="text-muted mb-4">Quando alguém agendar uma visita aos seus anúncios, aparecerá aqui</p>
                            <a href="#meus-anuncios" class="btn btn-primary perfil-nav-item" data-bs-toggle="tab">
                                <i class="bi bi-grid-3x3-gap me-2"></i>Ver Meus Anúncios
                            </a>
                        </div>
                    }
                </div>

                <!-- Aba: Dados Bancários (para Vendedores) -->
                <div class="tab-pane fade" id="dados-bancarios">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-bank text-primary me-2"></i>Dados Bancários
                            </h3>
                            <p class="text-muted mb-0">Configure os seus dados de pagamento para receber transferências</p>
                        </div>
                    </div>

                    <!-- Alert Informativo -->
                    <div class="alert alert-info border-0 mb-4">
                        <div class="d-flex">
                            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                            <div>
                                <h6 class="mb-2 fw-bold">Porquê adicionar dados bancários?</h6>
                                <p class="mb-2">
                                    Quando um comprador reservar um dos seus veículos, ele precisará fazer uma transferência bancária do sinal.
                                    Configure aqui os seus dados para facilitar o processo de pagamento.
                                </p>
                                <ul class="mb-0 ps-3">
                                    <li>Receba sinais de reserva diretamente na sua conta</li>
                                    <li>Os seus dados ficam seguros e privados</li>
                                    <li>Partilhados apenas com compradores que reservarem</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Formulário de Dados Bancários -->
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <form id="formDadosBancarios">
                                <div class="row g-4">
                                    <!-- NIB -->
                                    <div class="col-12">
                                        <label for="nib" class="form-label fw-semibold">
                                            <i class="bi bi-credit-card-2-front text-primary me-2"></i>NIB (Número de Identificação Bancária)
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="nib"
                                               placeholder="0000 0000 0000 0000 0000 000"
                                               maxlength="25"
                                               pattern="[0-9 ]+"
                                               value="1234 5678 9012 3456 7890 123"
                                               required>
                                        <div class="form-text">
                                            <i class="bi bi-shield-check text-success me-1"></i>
                                            O NIB é composto por 21 dígitos
                                        </div>
                                    </div>

                                    <!-- IBAN -->
                                    <div class="col-12">
                                        <label for="iban" class="form-label fw-semibold">
                                            <i class="bi bi-bank text-primary me-2"></i>IBAN
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="iban"
                                               placeholder="PT50 0000 0000 0000 0000 0000 0"
                                               maxlength="29"
                                               value="PT50 1234 5678 9012 3456 7890 1"
                                               required>
                                        <div class="form-text">
                                            <i class="bi bi-globe me-1"></i>
                                            Formato internacional (PT + 23 dígitos)
                                        </div>
                                    </div>

                                    <!-- Nome do Titular -->
                                    <div class="col-md-6">
                                        <label for="titularConta" class="form-label fw-semibold">
                                            <i class="bi bi-person-badge text-primary me-2"></i>Nome do Titular
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control form-control-lg" id="titularConta"
                                               placeholder="Nome completo"
                                               value="João Duarte Silva"
                                               required>
                                        <div class="form-text">Deve corresponder ao nome registado no banco</div>
                                    </div>

                                    <!-- Banco -->
                                    <div class="col-md-6">
                                        <label for="banco" class="form-label fw-semibold">
                                            <i class="bi bi-building text-primary me-2"></i>Banco
                                            <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select form-select-lg" id="banco" required>
                                            <option value="">Selecione o banco...</option>
                                            <option value="caixa" selected>Caixa Geral de Depósitos</option>
                                            <option value="millennium">Millennium BCP</option>
                                            <option value="santander">Santander Totta</option>
                                            <option value="novo">Novo Banco</option>
                                            <option value="montepio">Montepio</option>
                                            <option value="bpi">Banco BPI</option>
                                            <option value="activobank">ActivoBank</option>
                                            <option value="bankinter">Bankinter</option>
                                            <option value="abanca">Abanca</option>
                                            <option value="outro">Outro</option>
                                        </select>
                                    </div>

                                    <!-- Método de Pagamento Preferencial -->
                                    <div class="col-12">
                                        <label class="form-label fw-semibold">
                                            <i class="bi bi-wallet2 text-primary me-2"></i>Métodos de Pagamento Aceites
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="card h-100 border-2 payment-method-card">
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="metodo-transferencia" checked>
                                                            <label class="form-check-label w-100" for="metodo-transferencia">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="bi bi-bank2 fs-3 text-primary me-3"></i>
                                                                    <div>
                                                                        <strong class="d-block">Transferência Bancária</strong>
                                                                        <small class="text-muted">Pagamento direto para a sua conta</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card h-100 border-2 payment-method-card">
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="metodo-mbway" checked>
                                                            <label class="form-check-label w-100" for="metodo-mbway">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="bi bi-phone fs-3 text-success me-3"></i>
                                                                    <div>
                                                                        <strong class="d-block">MB WAY</strong>
                                                                        <small class="text-muted">Pagamento instantâneo via telemóvel</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card h-100 border-2 payment-method-card">
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="metodo-multibanco">
                                                            <label class="form-check-label w-100" for="metodo-multibanco">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="bi bi-receipt fs-3 text-info me-3"></i>
                                                                    <div>
                                                                        <strong class="d-block">Referência Multibanco</strong>
                                                                        <small class="text-muted">Pagamento em ATM ou homebanking</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card h-100 border-2 payment-method-card">
                                                    <div class="card-body">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="metodo-dinheiro">
                                                            <label class="form-check-label w-100" for="metodo-dinheiro">
                                                                <div class="d-flex align-items-center">
                                                                    <i class="bi bi-cash-stack fs-3 text-warning me-3"></i>
                                                                    <div>
                                                                        <strong class="d-block">Dinheiro</strong>
                                                                        <small class="text-muted">Pagamento em mãos na entrega</small>
                                                                    </div>
                                                                </div>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- MB WAY (Condicional) -->
                                    <div class="col-md-6" id="campo-mbway" style="display: none;">
                                        <label for="numeroMbway" class="form-label fw-semibold">
                                            <i class="bi bi-phone-fill text-primary me-2"></i>Número MB WAY
                                        </label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text">
                                                <i class="bi bi-phone"></i>
                                            </span>
                                            <input type="tel" class="form-control" id="numeroMbway"
                                                   placeholder="+351 912 345 678"
                                                   value="+351 912 345 678">
                                        </div>
                                    </div>

                                    <!-- Notas Adicionais -->
                                    <div class="col-12">
                                        <label for="notasBancarias" class="form-label fw-semibold">
                                            <i class="bi bi-journal-text text-primary me-2"></i>Notas Adicionais
                                        </label>
                                        <textarea class="form-control" id="notasBancarias" rows="3"
                                            placeholder="Informações adicionais sobre pagamentos, horários de disponibilidade, etc.">Disponível para receber pagamentos de segunda a sexta, das 9h às 18h. Preferência por MB WAY para pagamentos mais rápidos.</textarea>
                                        <div class="form-text">Máximo 200 caracteres</div>
                                    </div>

                                    <!-- Botões de Ação -->
                                    <div class="col-12">
                                        <hr class="my-4">
                                        <div class="d-flex gap-3 justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary btn-lg px-4">
                                                <i class="bi bi-x-circle me-2"></i>Cancelar
                                            </button>
                                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                                <i class="bi bi-check-circle me-2"></i>Guardar Dados Bancários
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Card de Segurança -->
                    <div class="card border-0 bg-light mt-4">
                        <div class="card-body p-4">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-shield-lock-fill text-success me-2"></i>Segurança e Privacidade
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-lock-fill text-success fs-4 me-2"></i>
                                        <div>
                                            <strong class="d-block small">Dados Encriptados</strong>
                                            <small class="text-muted">Informações protegidas com criptografia SSL</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-eye-slash-fill text-success fs-4 me-2"></i>
                                        <div>
                                            <strong class="d-block small">Acesso Restrito</strong>
                                            <small class="text-muted">Apenas compradores confirmados veem seus dados</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-start">
                                        <i class="bi bi-shield-check-fill text-success fs-4 me-2"></i>
                                        <div>
                                            <strong class="d-block small">Conformidade RGPD</strong>
                                            <small class="text-muted">Cumprimos todas as normas de proteção de dados</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                }

                <!-- Aba: Anúncios Favoritos (para Compradores e Vendedores) -->
                @{
                    var favoritos = ViewBag.MeusFavoritos as List<Marketplace.Models.AnuncioFav> ?? new List<Marketplace.Models.AnuncioFav>();
                    var favoritosCount = ViewBag.FavoritosCount ?? 0;
                    var mediaPreco = favoritos.Any() ? favoritos.Average(f => f.Anuncio.Preco) : 0;
                }
                @if (User.IsInRole("Comprador") || User.IsInRole("Vendedor"))
                {
                    <div class="tab-pane fade" id="favoritos">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-heart-fill text-danger me-2"></i>Anúncios Favoritos
                            </h3>
                            <p class="text-muted mb-0">Os seus veículos guardados para consulta rápida</p>
                        </div>
                        <div class="favoritos-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-primary fw-bold" id="favoritos-count-perfil">@favoritosCount</div>
                                <div class="stat-label text-muted small">Favoritos</div>
                            </div>
                            @if (favoritos.Any())
                            {
                                <div class="stat-item text-center">
                                    <div class="stat-value text-success fw-bold">@mediaPreco.ToString("N0")€</div>
                                    <div class="stat-label text-muted small">Média de Preço</div>
                                </div>
                            }
                        </div>
                    </div>

                    @if (favoritos.Any())
                    {
                        <!-- Grid de Favoritos -->
                        <div class="favoritos-grid" id="favoritos-container-perfil">
                            @foreach (var favorito in favoritos)
                            {
                                var anuncio = favorito.Anuncio;
                                var imagemPrincipal = anuncio.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "/imagens/default-car.jpg";
                                var marcaModelo = $"{anuncio.Marca?.Nome} {anuncio.Modelo?.Nome}";

                                <div class="favorito-card card shadow-sm border-0 mb-3" data-favorito-id="@favorito.Id">
                                    <div class="card-body p-0">
                                        <div class="row g-0">
                                            <div class="col-md-5">
                                                <div class="favorito-image-wrapper">
                                                    <img src="@imagemPrincipal" alt="@anuncio.Titulo" class="favorito-image">
                                                    <button class="favorito-heart-btn active btn-favorito"
                                                            data-anuncio-id="@anuncio.Id"
                                                            title="Remover dos favoritos">
                                                        <i class="bi bi-heart-fill"></i>
                                                    </button>
                                                    @if (anuncio.Tipo != null)
                                                    {
                                                        <span class="favorito-badge badge-disponivel">
                                                            <i class="bi bi-check-circle-fill me-1"></i>@anuncio.Tipo.Nome
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="col-md-7">
                                                <div class="favorito-content p-4">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <div>
                                                            <h5 class="favorito-title mb-1">@anuncio.Titulo</h5>
                                                            <p class="favorito-subtitle text-muted mb-0">@marcaModelo @(anuncio.Ano.HasValue ? "| " + anuncio.Ano : "")</p>
                                                        </div>
                                                        <div class="favorito-price-tag">
                                                            <span class="price-value">@anuncio.Preco.ToString("N0")€</span>
                                                        </div>
                                                    </div>

                                                    <div class="favorito-specs mt-3 mb-3">
                                                        @if (anuncio.Quilometragem.HasValue)
                                                        {
                                                            <div class="spec-item">
                                                                <i class="bi bi-speedometer2 text-primary"></i>
                                                                <span>@anuncio.Quilometragem.Value.ToString("N0") km</span>
                                                            </div>
                                                        }
                                                        @if (anuncio.Combustivel != null)
                                                        {
                                                            <div class="spec-item">
                                                                <i class="bi bi-fuel-pump text-primary"></i>
                                                                <span>@anuncio.Combustivel.Tipo</span>
                                                            </div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(anuncio.Caixa))
                                                        {
                                                            <div class="spec-item">
                                                                <i class="bi bi-gear text-primary"></i>
                                                                <span>@anuncio.Caixa</span>
                                                            </div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                        {
                                                            <div class="spec-item">
                                                                <i class="bi bi-geo-alt text-primary"></i>
                                                                <span>@anuncio.Localizacao</span>
                                                            </div>
                                                        }
                                                    </div>

                                                    <div class="favorito-actions d-flex gap-2">
                                                        <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-primary flex-grow-1">
                                                            <i class="bi bi-eye me-2"></i>Ver Detalhes
                                                        </a>
                                                        <button class="btn btn-outline-primary" title="Contactar Vendedor">
                                                            <i class="bi bi-chat-dots"></i>
                                                        </button>
                                                        <form asp-controller="Favoritos" asp-action="Remove" asp-route-id="@favorito.Id" method="post" class="d-inline remove-favorito-form-perfil">
                                                            <button type="submit" class="btn btn-outline-danger" title="Remover dos favoritos">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Estado Vazio (mostrar quando não houver favoritos) -->
                        <div class="favoritos-empty text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-heart" style="font-size: 4rem; color: #e2e8f0;"></i>
                            </div>
                            <h4 class="text-muted mb-2">Ainda não tem favoritos</h4>
                            <p class="text-muted mb-4">Guarde os anúncios que mais gosta para acesso rápido</p>
                            <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Explorar Anúncios
                            </a>
                        </div>
                    }
                    </div>
                }

                <!-- Aba: Minhas Reservas (para Compradores) -->
                @if (User.IsInRole("Comprador"))
                {
                    <div class="tab-pane fade" id="minhas-reservas">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-bookmark-star-fill text-warning me-2"></i>Minhas Reservas
                            </h3>
                            <p class="text-muted mb-0">Gerir as suas reservas de veículos</p>
                        </div>
                        <div class="reservas-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-warning fw-bold">1</div>
                                <div class="stat-label text-muted small">Ativa</div>
                            </div>
                            <div class="stat-item text-center">
                                <div class="stat-value text-muted fw-bold">0</div>
                                <div class="stat-label text-muted small">Expiradas</div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Reservas -->
                    <div class="reservas-list">
                        <!-- Reserva Ativa -->
                        <div class="card shadow-sm border-warning mb-3">
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <div class="col-auto">
                                        <img src="~/imagens/bmwSerie1.jpg" alt="BMW Série 3" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                    </div>
                                    <div class="col">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h5 class="mb-1 fw-bold">BMW Série 3 320d Pack M</h5>
                                                <p class="text-muted mb-2 small">2019 • 85.000 km • Diesel • Manual</p>
                                            </div>
                                            <span class="badge bg-warning text-dark fs-6">
                                                <i class="bi bi-clock-fill me-1"></i>Ativa
                                            </span>
                                        </div>

                                        <div class="row g-3 mb-3">
                                            <div class="col-md-3">
                                                <p class="text-muted mb-0 small">Data da Reserva:</p>
                                                <p class="mb-0 fw-semibold">23/10/2025 14:32</p>
                                            </div>
                                            <div class="col-md-3">
                                                <p class="text-muted mb-0 small">Expira em:</p>
                                                <p class="mb-0 fw-semibold text-danger">
                                                    <i class="bi bi-hourglass-split me-1"></i>18 horas
                                                </p>
                                            </div>
                                            <div class="col-md-3">
                                                <p class="text-muted mb-0 small">Sinal Pago:</p>
                                                <p class="mb-0 fw-semibold text-success">500€</p>
                                            </div>
                                            <div class="col-md-3">
                                                <p class="text-muted mb-0 small">Preço Total:</p>
                                                <p class="mb-0 fw-bold text-primary fs-5">28.500€</p>
                                            </div>
                                        </div>

                                        <div class="alert alert-info mb-3 small">
                                            <i class="bi bi-info-circle-fill me-2"></i>
                                            <strong>Prioridade garantida até 25/10/2025 14:32.</strong> Entre em contacto com o vendedor para finalizar a compra.
                                        </div>

                                        <div class="reserva-vendedor mb-3 p-3 bg-light rounded">
                                            <h6 class="mb-2 small fw-bold">
                                                <i class="bi bi-person-badge me-1"></i>Vendedor
                                            </h6>
                                            <div class="d-flex align-items-center">
                                                <img src="https://placehold.co/50x50/0d6efd/ffffff?text=PC" class="rounded-circle me-3" alt="Pedro Costa">
                                                <div>
                                                    <p class="mb-0 fw-semibold">Pedro Costa</p>
                                                    <p class="mb-0 small text-muted">
                                                        <i class="bi bi-star-fill text-warning me-1"></i>4.5 • +351 912 345 678
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <a asp-controller="Anuncios" asp-action="Details" class="btn btn-primary">
                                                <i class="bi bi-eye me-1"></i>Ver Anúncio
                                            </a>
                                            <button class="btn btn-success">
                                                <i class="bi bi-chat-dots-fill me-1"></i>Contactar Vendedor
                                            </button>
                                            <button class="btn btn-outline-danger ms-auto">
                                                <i class="bi bi-x-circle me-1"></i>Cancelar Reserva
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estado Vazio -->
                    <div class="reservas-empty text-center py-5 d-none">
                        <div class="mb-4">
                            <i class="bi bi-bookmark-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                        </div>
                        <h4 class="text-muted mb-2">Sem reservas ativas</h4>
                        <p class="text-muted mb-4">Quando reservar um veículo, ele aparecerá aqui</p>
                        <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                            <i class="bi bi-search me-2"></i>Explorar Anúncios
                        </a>
                    </div>
                </div>

                    var visitasComprador = ViewBag.MinhasVisitasComprador as List<Marketplace.Models.Visita> ?? new List<Marketplace.Models.Visita>();
                    var totalVisitas = visitasComprador.Count;
                    var visitasPendentes = visitasComprador.Count(v => v.Estado == "Pendente");
                    var visitasConfirmadas = visitasComprador.Count(v => v.Estado == "Confirmada");
                    var visitasConcluidas = visitasComprador.Count(v => v.Estado == "Concluída");
                    <!-- Aba: Minhas Visitas (para Compradores) -->
                <div class="tab-pane fade" id="minhas-visitas">
                    <!-- Cabeçalho da Página -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-1 fw-bold">
                                <i class="bi bi-calendar-check-fill text-info me-2"></i>Minhas Visitas
                            </h3>
                            <p class="text-muted mb-0">Visitas agendadas aos veículos</p>
                        </div>
                        <div class="visitas-stats d-flex gap-3">
                            <div class="stat-item text-center">
                                <div class="stat-value text-info fw-bold">@totalVisitas</div>
                                <div class="stat-label text-muted small">Total</div>
                            </div>
                        </div>
                    </div>

                    @if (visitasComprador.Any())
                    {
                        <!-- Filtros de Status - Horizontal -->
                        <div class="d-flex gap-2 mb-4 flex-wrap">
                            <button class="btn btn-outline-primary active" data-filter-visitas="todas">
                                <i class="bi bi-grid-fill me-1"></i>Todas <span class="badge bg-primary ms-1">@totalVisitas</span>
                            </button>
                            <button class="btn btn-outline-warning" data-filter-visitas="Pendente">
                                <i class="bi bi-clock-fill me-1"></i>Pendentes <span class="badge bg-warning ms-1">@visitasPendentes</span>
                            </button>
                            <button class="btn btn-outline-success" data-filter-visitas="Confirmada">
                                <i class="bi bi-check-circle-fill me-1"></i>Confirmadas <span class="badge bg-success ms-1">@visitasConfirmadas</span>
                            </button>
                            <button class="btn btn-outline-secondary" data-filter-visitas="Concluída">
                                <i class="bi bi-archive-fill me-1"></i>Concluídas <span class="badge bg-secondary ms-1">@visitasConcluidas</span>
                            </button>
                        </div>

                        <!-- Lista de Visitas -->
                        <div class="visitas-list">
                            @foreach (var visita in visitasComprador)
                            {
                                var anuncio = visita.Anuncio;
                                var imagemPrincipal = anuncio.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "~/imagens/default-car.jpg";
                                var marcaModelo = $"{anuncio.Marca?.Nome} {anuncio.Modelo?.Nome}";
                                var badgeClass = visita.Estado switch
                                {
                                    "Confirmada" => "bg-success",
                                    "Pendente" => "bg-warning",
                                    "Concluída" => "bg-secondary",
                                    "Cancelada" => "bg-danger",
                                    _ => "bg-info"
                                };
                                var borderClass = visita.Estado switch
                                {
                                    "Confirmada" => "border-success",
                                    "Pendente" => "border-warning",
                                    "Concluída" => "border-secondary",
                                    "Cancelada" => "border-danger",
                                    _ => "border-info"
                                };

                                <div class="card shadow-sm @borderClass mb-3" data-status-visita="@visita.Estado">
                                    <div class="card-body p-4">
                                        <div class="row g-3">
                                            <div class="col-auto">
                                                <img src="@imagemPrincipal" alt="@anuncio.Titulo" class="rounded" style="width: 120px; height: 90px; object-fit: cover;">
                                            </div>
                                            <div class="col">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h5 class="mb-1 fw-bold">@anuncio.Titulo</h5>
                                                        <p class="text-muted mb-2 small">
                                                            @marcaModelo
                                                            @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                            {
                                                                <span> • @anuncio.Localizacao</span>
                                                            }
                                                        </p>
                                                    </div>
                                                    <span class="badge @badgeClass fs-6">
                                                        @if (visita.Estado == "Confirmada")
                                                        {
                                                            <i class="bi bi-check-circle-fill me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Pendente")
                                                        {
                                                            <i class="bi bi-clock-fill me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Concluída")
                                                        {
                                                            <i class="bi bi-check-all me-1"></i>
                                                        }
                                                        else if (visita.Estado == "Cancelada")
                                                        {
                                                            <i class="bi bi-x-circle-fill me-1"></i>
                                                        }
                                                        @visita.Estado
                                                    </span>
                                                </div>

                                                <div class="row g-3 mb-3">
                                                    <div class="col-md-6">
                                                        <p class="text-muted mb-0 small">Data e Hora:</p>
                                                        <p class="mb-0 fw-bold text-primary">
                                                            <i class="bi bi-calendar-event me-1"></i>@visita.Data.ToString("dd/MM/yyyy 'às' HH:mm")
                                                        </p>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(anuncio.Localizacao))
                                                    {
                                                        <div class="col-md-6">
                                                            <p class="text-muted mb-0 small">Local:</p>
                                                            <p class="mb-0 fw-semibold">@anuncio.Localizacao</p>
                                                        </div>
                                                    }
                                                </div>

                                                @if (!string.IsNullOrEmpty(visita.Observacoes))
                                                {
                                                    <div class="alert alert-info mb-3 small">
                                                        <i class="bi bi-info-circle-fill me-2"></i>
                                                        <strong>Observações:</strong> @visita.Observacoes
                                                    </div>
                                                }

                                                @if (visita.Estado == "Confirmada")
                                                {
                                                    <div class="alert alert-success mb-3 small">
                                                        <i class="bi bi-check-circle-fill me-2"></i>
                                                        <strong>Visita confirmada pelo vendedor.</strong> Compareça no local na data e hora agendadas.
                                                    </div>
                                                }
                                                else if (visita.Estado == "Pendente")
                                                {
                                                    <div class="alert alert-warning mb-3 small">
                                                        <i class="bi bi-clock-fill me-2"></i>
                                                        <strong>Aguardando confirmação do vendedor.</strong>
                                                    </div>
                                                }

                                                <div class="visita-vendedor mb-3 p-3 bg-light rounded">
                                                    <h6 class="mb-2 small fw-bold">
                                                        <i class="bi bi-person-badge me-1"></i>Vendedor
                                                    </h6>
                                                    <div class="d-flex align-items-center">
                                                        @if (!string.IsNullOrEmpty(visita.Vendedor?.ImagemPerfil))
                                                        {
                                                            <img src="@visita.Vendedor.ImagemPerfil" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;" alt="@visita.Vendedor.Nome">
                                                        }
                                                        else
                                                        {
                                                            <div class="rounded-circle me-3 bg-primary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                                                <i class="bi bi-person-fill fs-4"></i>
                                                            </div>
                                                        }
                                                        <div>
                                                            <p class="mb-0 fw-semibold">@visita.Vendedor?.Nome</p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="d-flex gap-2 flex-wrap">
                                                    <a asp-controller="Visitas" asp-action="Details" asp-route-id="@visita.Id" class="btn btn-sm btn-info text-white">
                                                        <i class="bi bi-eye me-1"></i>Ver Detalhes
                                                    </a>
                                                    <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@anuncio.Id" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-car-front me-1"></i>Ver Anúncio
                                                    </a>
                                                    @if (visita.Estado == "Pendente" || visita.Estado == "Confirmada")
                                                    {
                                                        <a asp-controller="Visitas" asp-action="Edit" asp-route-id="@visita.Id" class="btn btn-sm btn-outline-secondary">
                                                            <i class="bi bi-pencil me-1"></i>Editar
                                                        </a>
                                                        <form asp-controller="Visitas" asp-action="Cancelar" method="post" class="d-inline" onsubmit="return confirm('Tem certeza que deseja cancelar esta visita?')">
                                                            <input type="hidden" name="id" value="@visita.Id" />
                                                            <input type="hidden" name="motivo" value="Cancelado pelo comprador" />
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                <i class="bi bi-x-circle me-1"></i>Cancelar
                                                            </button>
                                                        </form>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- Estado Vazio -->
                        <div class="visitas-empty text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-calendar-x" style="font-size: 4rem; color: #e2e8f0;"></i>
                            </div>
                            <h4 class="text-muted mb-2">Sem visitas agendadas</h4>
                            <p class="text-muted mb-4">Agende uma visita para conhecer o veículo pessoalmente</p>
                            <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Explorar Anúncios
                            </a>
                        </div>
                    }
                    </div>
                }

                <!-- Aba: Definições -->
                <div class="tab-pane fade" id="definicoes">
                    <!-- Cabeçalho da Página -->
                    <div class="mb-4">
                        <h3 class="mb-1 fw-bold">
                            <i class="bi bi-gear-fill text-primary me-2"></i>Definições da Conta
                        </h3>
                        <p class="text-muted mb-0">Gerir as preferências e segurança da sua conta</p>
                    </div>

                    <!-- Segurança da Conta -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-shield-lock text-primary me-2"></i>Segurança
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <!-- Alterar Password -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-primary-subtle">
                                        <i class="bi bi-key-fill text-primary"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Alterar Password</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Última alteração há 3 meses. Recomendamos alterar a cada 6 meses.
                                        </p>
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#alterarPasswordModal">
                                    <i class="bi bi-pencil me-1"></i>Alterar
                                </button>
                            </div>

                            <hr class="my-3">

                            <!-- Autenticação de Dois Fatores -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-success-subtle">
                                        <i class="bi bi-shield-check text-success"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Autenticação de Dois Fatores</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Adicione uma camada extra de segurança à sua conta.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switch2FA">
                                    <label class="form-check-label" for="switch2FA">
                                        <span class="badge bg-secondary">Desativado</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Sessões Ativas -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-info-subtle">
                                        <i class="bi bi-devices text-info"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Sessões Ativas</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Gerir dispositivos com sessão iniciada. 1 dispositivo ativo.
                                        </p>
                                    </div>
                                </div>
                                <button class="btn btn-outline-secondary">
                                    <i class="bi bi-list-ul me-1"></i>Ver
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Notificações -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-bell text-primary me-2"></i>Notificações
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <!-- Email Notificações -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-primary-subtle">
                                        <i class="bi bi-envelope text-primary"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Notificações por Email</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Receber atualizações sobre anúncios e mensagens.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchEmailNotif" checked>
                                    <label class="form-check-label" for="switchEmailNotif">
                                        <span class="badge bg-success">Ativo</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Notificações de Novos Anúncios -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-warning-subtle">
                                        <i class="bi bi-bookmark-star text-warning"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Novos Anúncios</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Alertas quando houver anúncios que correspondam às suas preferências.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchNovosAnuncios" checked>
                                    <label class="form-check-label" for="switchNovosAnuncios">
                                        <span class="badge bg-success">Ativo</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Notificações de Preço -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-success-subtle">
                                        <i class="bi bi-graph-down text-success"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Alertas de Redução de Preço</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Notificações quando veículos favoritos baixarem de preço.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchPreco">
                                    <label class="form-check-label" for="switchPreco">
                                        <span class="badge bg-secondary">Desativado</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Newsletter -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-info-subtle">
                                        <i class="bi bi-newspaper text-info"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Newsletter</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Receber dicas, novidades e ofertas especiais.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchNewsletter" checked>
                                    <label class="form-check-label" for="switchNewsletter">
                                        <span class="badge bg-success">Ativo</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Privacidade -->
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header bg-white border-bottom py-3">
                            <h5 class="mb-0 fw-semibold">
                                <i class="bi bi-eye-slash text-primary me-2"></i>Privacidade
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <!-- Perfil Público -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-primary-subtle">
                                        <i class="bi bi-person-badge text-primary"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Perfil Público</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Permitir que outros utilizadores vejam o seu perfil.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchPerfilPublico" checked>
                                    <label class="form-check-label" for="switchPerfilPublico">
                                        <span class="badge bg-success">Público</span>
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3">

                            <!-- Mostrar Email -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-warning-subtle">
                                        <i class="bi bi-at text-warning"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Mostrar Email Publicamente</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Exibir o seu email nos anúncios publicados.
                                        </p>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" id="switchMostrarEmail">
                                    <label class="form-check-label" for="switchMostrarEmail">
                                        <span class="badge bg-secondary">Oculto</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zona de Perigo -->
                    <div class="card shadow-sm border-danger mb-4">
                        <div class="card-header bg-danger-subtle border-bottom border-danger py-3">
                            <h5 class="mb-0 fw-semibold text-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>Zona de Perigo
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <!-- Desativar Conta -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-warning-subtle">
                                        <i class="bi bi-pause-circle text-warning"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Desativar Conta</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            A sua conta será temporariamente desativada. Pode reativá-la a qualquer momento.
                                        </p>
                                    </div>
                                </div>
                                <button class="btn btn-outline-warning">
                                    <i class="bi bi-pause me-1"></i>Desativar
                                </button>
                            </div>

                            <hr class="my-3">

                            <!-- Eliminar Conta -->
                            <div class="definicao-item">
                                <div class="definicao-info">
                                    <div class="definicao-icon bg-danger-subtle">
                                        <i class="bi bi-trash text-danger"></i>
                                    </div>
                                    <div class="definicao-content">
                                        <h6 class="definicao-title">Eliminar Conta</h6>
                                        <p class="definicao-description text-muted mb-0">
                                            Eliminar permanentemente a sua conta e todos os dados. Esta ação é irreversível.
                                        </p>
                                    </div>
                                </div>
                                <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#eliminarContaModal">
                                    <i class="bi bi-trash me-1"></i>Eliminar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Botão de Guardar Alterações -->
                    <div class="text-end">
                        <button class="btn btn-lg btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Guardar Alterações
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Destacar Anúncio -->
<div class="modal fade" id="destacarModal" tabindex="-1" aria-labelledby="destacarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white border-0">
                <h5 class="modal-title fw-bold" id="destacarModalLabel">
                    <i class="bi bi-star-fill me-2"></i>Destacar Anúncio
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="destacar-icon mb-3">
                        <i class="bi bi-rocket-takeoff" style="font-size: 3.5rem; color: #fbbf24;"></i>
                    </div>
                    <h5 class="fw-bold mb-2">Aumente a visibilidade do seu anúncio!</h5>
                    <p class="text-muted mb-0">
                        Destaque o seu veículo e coloque-o no topo das listagens para obter mais visualizações e contactos.
                    </p>
                </div>

                <div class="destacar-features mb-4">
                    <div class="feature-item d-flex align-items-center mb-3">
                        <div class="feature-icon-circle me-3 flex-shrink-0">
                            <i class="bi bi-arrow-up-circle-fill text-warning"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">Posição de Topo</h6>
                            <p class="text-muted small mb-0">O seu anúncio aparece no topo dos resultados de pesquisa</p>
                        </div>
                    </div>
                    <div class="feature-item d-flex align-items-center mb-3">
                        <div class="feature-icon-circle me-3 flex-shrink-0">
                            <i class="bi bi-eye-fill text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">Mais Visualizações</h6>
                            <p class="text-muted small mb-0">Até 5x mais visualizações comparado com anúncios normais</p>
                        </div>
                    </div>
                    <div class="feature-item d-flex align-items-center mb-3">
                        <div class="feature-icon-circle me-3 flex-shrink-0">
                            <i class="bi bi-badge-vr-fill text-success"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">Badge Especial</h6>
                            <p class="text-muted small mb-0">O seu anúncio recebe um badge "Em Destaque" visível</p>
                        </div>
                    </div>
                    <div class="feature-item d-flex align-items-center">
                        <div class="feature-icon-circle me-3 flex-shrink-0">
                            <i class="bi bi-lightning-charge-fill text-danger"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold">Venda Mais Rápida</h6>
                            <p class="text-muted small mb-0">Anúncios destacados vendem 3x mais rápido</p>
                        </div>
                    </div>
                </div>

                <div class="destacar-pricing card bg-light border-warning border-2 mb-4">
                    <div class="card-body text-center p-4">
                        <div class="d-flex justify-content-center align-items-baseline mb-3">
                            <span class="display-4 fw-bold text-warning">1,99€</span>
                            <span class="text-muted ms-2">/ 7 dias</span>
                        </div>
                        <p class="text-muted small mb-0">
                            <i class="bi bi-info-circle me-1"></i>Renovação automática desativada por padrão
                        </p>
                    </div>
                </div>

                <div class="alert alert-info d-flex align-items-center mb-0" role="alert">
                    <i class="bi bi-lightbulb-fill me-2 flex-shrink-0"></i>
                    <div class="small">
                        <strong>Dica:</strong> Os melhores resultados são obtidos em anúncios com fotos de qualidade e descrições completas.
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning text-white" id="btnConfirmarDestaque">
                    <i class="bi bi-star-fill me-2"></i>Destacar por 9,99€
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Sistema de Tabs do Perfil
        document.addEventListener('DOMContentLoaded', function () {
            // Selecionar todos os itens de navegação
            const navItems = document.querySelectorAll('.perfil-nav-item');
            const tabPanes = document.querySelectorAll('.tab-pane');

            // Função para ativar uma tab
            function activateTab(targetId) {
                // Remover classe active de todos os itens
                navItems.forEach(item => item.classList.remove('active'));
                tabPanes.forEach(pane => {
                    pane.classList.remove('show', 'active');
                });

                // Adicionar classe active ao item clicado
                const clickedItem = document.querySelector(`[href="${targetId}"]`);
                if (clickedItem) {
                    clickedItem.classList.add('active');
                }

                // Mostrar o conteúdo correspondente
                const targetPane = document.querySelector(targetId);
                if (targetPane) {
                    targetPane.classList.add('show', 'active');
                }
            }

            // Adicionar event listeners aos itens de navegação
            navItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    activateTab(targetId);

                    // Scroll suave para o topo do conteúdo (opcional)
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            });

            // Sistema de Filtros de Anúncios
            const filterButtons = document.querySelectorAll('.anuncios-filter-btn');
            const anuncioCards = document.querySelectorAll('.anuncio-card');
            const anunciosEmpty = document.querySelector('.anuncios-empty');

            filterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Remover classe active de todos os botões
                    filterButtons.forEach(btn => btn.classList.remove('active'));

                    // Adicionar classe active ao botão clicado
                    this.classList.add('active');

                    // Obter o filtro selecionado
                    const filter = this.getAttribute('data-filter');

                    let visibleCount = 0;

                    // Filtrar os anúncios
                    anuncioCards.forEach(card => {
                        const status = card.getAttribute('data-status');

                        if (filter === 'todos' || filter === status) {
                            card.style.display = '';
                            visibleCount++;
                        } else {
                            card.style.display = 'none';
                        }
                    });

                    // Mostrar mensagem se não houver resultados
                    if (anunciosEmpty) {
                        if (visibleCount === 0) {
                            anunciosEmpty.classList.remove('d-none');
                        } else {
                            anunciosEmpty.classList.add('d-none');
                        }
                    }
                });
            });

            // Sistema de Favoritos
            const favoritoHeartBtns = document.querySelectorAll('.favorito-heart-btn');
            const favoritoRemoveBtns = document.querySelectorAll('.favorito-remove-btn');

            // Função para remover favorito
            function removeFavorito(card) {
                // Animação de saída
                card.style.transition = 'all 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'translateX(-20px)';

                setTimeout(() => {
                    card.remove();

                    // Verificar se ainda existem favoritos
                    const remainingFavoritos = document.querySelectorAll('.favorito-card');
                    if (remainingFavoritos.length === 0) {
                        document.querySelector('.favoritos-grid').classList.add('d-none');
                        document.querySelector('.favoritos-empty').classList.remove('d-none');
                    }

                    // Atualizar contador
                    const favoritoCount = document.querySelector('.favoritos-stats .stat-value');
                    if (favoritoCount) {
                        favoritoCount.textContent = remainingFavoritos.length;
                    }
                }, 300);
            }

            // Event listeners para botões de coração
            favoritoHeartBtns.forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const card = this.closest('.favorito-card');
                    if (confirm('Deseja remover este anúncio dos favoritos?')) {
                        removeFavorito(card);
                    }
                });
            });

            // Event listeners para botões de remover
            favoritoRemoveBtns.forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const card = this.closest('.favorito-card');
                    if (confirm('Deseja remover este anúncio dos favoritos?')) {
                        removeFavorito(card);
                    }
                });
            });

            // Sistema de Ordenação de Favoritos
            const sortButtons = document.querySelectorAll('.favoritos-sort-bar .btn-group .btn');

            sortButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    // Remover active de todos
                    sortButtons.forEach(b => b.classList.remove('active'));
                    // Adicionar active ao clicado
                    this.classList.add('active');

                    // Aqui você pode implementar a lógica de ordenação
                    // Por exemplo, reorganizar os cards baseado no critério selecionado
                    console.log('Ordenar por:', this.textContent.trim());
                });
            });

            // Sistema de Switches de Definições
            const switches = document.querySelectorAll('.form-check-input[type="checkbox"]');

            switches.forEach(switchElement => {
                switchElement.addEventListener('change', function () {
                    const label = this.nextElementSibling;
                    const badge = label.querySelector('.badge');

                    if (badge) {
                        if (this.checked) {
                            // Estado Ativo
                            badge.classList.remove('bg-secondary');
                            badge.classList.add('bg-success');
                            badge.textContent = this.id === 'switchPerfilPublico' ? 'Público' : 'Ativo';
                        } else {
                            // Estado Desativado
                            badge.classList.remove('bg-success', 'bg-primary');
                            badge.classList.add('bg-secondary');
                            badge.textContent = this.id === 'switchPerfilPublico' ? 'Privado' :
                                              this.id === 'switchMostrarEmail' ? 'Oculto' : 'Desativado';
                        }
                    }

                    // Aqui você pode adicionar lógica para salvar a preferência
                    console.log(`${this.id}: ${this.checked ? 'Ativo' : 'Desativado'}`);
                });
            });

            // Botão Guardar Alterações
            const btnGuardarDefinicoes = document.querySelector('#definicoes .btn-primary');

            if (btnGuardarDefinicoes) {
                btnGuardarDefinicoes.addEventListener('click', function () {
                    // Coletar todos os valores dos switches
                    const preferencias = {};

                    switches.forEach(sw => {
                        preferencias[sw.id] = sw.checked;
                    });

                    console.log('Guardar preferências:', preferencias);

                    // Mostrar feedback visual
                    const btnText = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Guardado!';
                    this.classList.add('btn-success');
                    this.classList.remove('btn-primary');

                    setTimeout(() => {
                        this.innerHTML = btnText;
                        this.classList.remove('btn-success');
                        this.classList.add('btn-primary');
                    }, 2000);

                    // Aqui você implementaria a chamada AJAX para o backend
                });
            }

            // ===== Sistema de Destacar Anúncios =====
            const btnConfirmarDestaque = document.getElementById('btnConfirmarDestaque');
            const btnRenovarDestaque = document.querySelectorAll('.btn-renovar-destaque');
            const destacarModal = document.getElementById('destacarModal');
            let anuncioAtual = null;

            // Capturar qual anúncio está sendo destacado
            document.querySelectorAll('.btn-destacar').forEach(btn => {
                btn.addEventListener('click', function() {
                    anuncioAtual = this.closest('.anuncio-card');
                });
            });

            // Confirmar destaque
            if (btnConfirmarDestaque) {
                btnConfirmarDestaque.addEventListener('click', function() {
                    if (!anuncioAtual) return;

                    // Feedback visual no botão
                    const btnOriginalText = this.innerHTML;
                    this.disabled = true;
                    this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>A processar...';

                    // Simular processamento
                    setTimeout(() => {
                        // Transformar anúncio em destacado
                        anuncioAtual.classList.add('anuncio-destacado');
                        anuncioAtual.classList.add('border-warning');
                        anuncioAtual.setAttribute('data-destacado', 'true');

                        // Adicionar informação de destaque na meta
                        const anuncioMeta = anuncioAtual.querySelector('.anuncio-meta');
                        const dataExpiracao = new Date();
                        dataExpiracao.setDate(dataExpiracao.getDate() + 7);
                        const dataFormatada = dataExpiracao.toLocaleDateString('pt-PT');

                        const metaDestaque = document.createElement('span');
                        metaDestaque.className = 'anuncio-meta-item text-warning';
                        metaDestaque.innerHTML = `<i class="bi bi-star-fill me-1"></i>Destaque até ${dataFormatada}`;
                        anuncioMeta.appendChild(metaDestaque);

                        // Trocar botão "Destacar" por "Renovar"
                        const actions = anuncioAtual.querySelector('.anuncio-actions');
                        const btnDestacar = actions.querySelector('.btn-destacar');
                        if (btnDestacar) {
                            btnDestacar.className = 'btn btn-sm btn-success btn-renovar-destaque w-100';
                            btnDestacar.title = 'Renovar Destaque';
                            btnDestacar.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Renovar';
                            btnDestacar.removeAttribute('data-bs-toggle');
                            btnDestacar.removeAttribute('data-bs-target');
                        }

                        // Feedback de sucesso
                        this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Destacado!';
                        this.classList.remove('btn-warning');
                        this.classList.add('btn-success');

                        setTimeout(() => {
                            // Fechar modal
                            const modalInstance = bootstrap.Modal.getInstance(destacarModal);
                            if (modalInstance) {
                                modalInstance.hide();
                            }

                            // Resetar botão
                            this.innerHTML = btnOriginalText;
                            this.classList.remove('btn-success');
                            this.classList.add('btn-warning');
                            this.disabled = false;

                            // Scroll suave até o anúncio
                            anuncioAtual.scrollIntoView({ behavior: 'smooth', block: 'center' });

                            // Notificação de sucesso
                            alert('✨ Anúncio destacado com sucesso! O seu veículo irá aparecer no topo das listagens durante 7 dias.');
                        }, 1500);

                        // Aqui você implementaria a chamada AJAX para o backend
                        console.log('Destacar anúncio:', anuncioAtual.getAttribute('data-id'));
                    }, 1500);
                });
            }

            // Botões de renovar destaque
            btnRenovarDestaque.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Renovar destaque por mais 7 dias?\n\nCusto: 9,99€')) {
                        const btnOriginalText = this.innerHTML;
                        this.disabled = true;
                        this.innerHTML = '<i class="bi bi-hourglass-split"></i>';

                        setTimeout(() => {
                            this.innerHTML = '<i class="bi bi-check-circle-fill me-1"></i>Renovado';

                            // Atualizar data de expiração no anúncio
                            const anuncioCard = this.closest('.anuncio-card');
                            const metaDestaque = anuncioCard.querySelector('.anuncio-meta-item.text-warning');
                            if (metaDestaque && metaDestaque.textContent.includes('Destaque até')) {
                                const novaData = new Date();
                                novaData.setDate(novaData.getDate() + 7);
                                metaDestaque.innerHTML = `<i class="bi bi-star-fill me-1"></i>Destaque até ${novaData.toLocaleDateString('pt-PT')}`;
                            }

                            setTimeout(() => {
                                this.innerHTML = btnOriginalText;
                                this.disabled = false;
                                alert('✨ Destaque renovado com sucesso!');
                            }, 1500);

                            // Aqui você implementaria a chamada AJAX para o backend
                            console.log('Renovar destaque do anúncio');
                        }, 1500);
                    }
                });
            });

            // Sistema de Filtros para Visitas (Comprador)
            const visitasFilterButtons = document.querySelectorAll('[data-filter-visitas]');
            const visitasCards = document.querySelectorAll('[data-status-visita]');

            visitasFilterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Remove active de todos os botões
                    visitasFilterButtons.forEach(btn => {
                        btn.classList.remove('active');
                        // Restaura classes originais
                        if (btn.getAttribute('data-filter-visitas') === 'todas') {
                            btn.className = 'btn btn-outline-primary';
                        } else if (btn.getAttribute('data-filter-visitas') === 'pendentes') {
                            btn.className = 'btn btn-outline-warning';
                        } else if (btn.getAttribute('data-filter-visitas') === 'confirmadas') {
                            btn.className = 'btn btn-outline-success';
                        } else if (btn.getAttribute('data-filter-visitas') === 'concluidas') {
                            btn.className = 'btn btn-outline-secondary';
                        }
                    });

                    // Adiciona active ao botão clicado
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter-visitas');

                    visitasCards.forEach(card => {
                        const status = card.getAttribute('data-status-visita');

                        if (filter === 'todas') {
                            card.style.display = '';
                        } else if (filter === 'pendentes' && status === 'pendente') {
                            card.style.display = '';
                        } else if (filter === 'confirmadas' && status === 'confirmada') {
                            card.style.display = '';
                        } else if (filter === 'concluidas' && status === 'concluida') {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // Sistema de Filtros para Reservas (Vendedor)
            const reservasVendedorFilterButtons = document.querySelectorAll('[data-filter-reservas-vendedor]');
            const reservasVendedorCards = document.querySelectorAll('[data-status-reserva-vendedor]');

            reservasVendedorFilterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    reservasVendedorFilterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter-reservas-vendedor');

                    reservasVendedorCards.forEach(card => {
                        const status = card.getAttribute('data-status-reserva-vendedor');

                        if (filter === 'todas') {
                            card.style.display = '';
                        } else if (filter === 'pendentes' && status === 'pendente') {
                            card.style.display = '';
                        } else if (filter === 'ativas' && status === 'ativa') {
                            card.style.display = '';
                        } else if (filter === 'expiradas' && status === 'expirada') {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // Sistema de Filtros para Visitas (Vendedor)
            const visitasVendedorFilterButtons = document.querySelectorAll('[data-filter-visitas-vendedor]');
            const visitasVendedorCards = document.querySelectorAll('[data-status-visita-vendedor]');

            visitasVendedorFilterButtons.forEach(button => {
                button.addEventListener('click', function () {
                    // Remove active de todos os botões
                    visitasVendedorFilterButtons.forEach(btn => {
                        btn.classList.remove('active');
                        // Restaura classes originais
                        if (btn.getAttribute('data-filter-visitas-vendedor') === 'todas') {
                            btn.className = 'btn btn-outline-primary';
                        } else if (btn.getAttribute('data-filter-visitas-vendedor') === 'pendentes') {
                            btn.className = 'btn btn-outline-warning';
                        } else if (btn.getAttribute('data-filter-visitas-vendedor') === 'confirmadas') {
                            btn.className = 'btn btn-outline-success';
                        } else if (btn.getAttribute('data-filter-visitas-vendedor') === 'concluidas') {
                            btn.className = 'btn btn-outline-secondary';
                        }
                    });

                    // Adiciona active ao botão clicado
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter-visitas-vendedor');

                    visitasVendedorCards.forEach(card => {
                        const status = card.getAttribute('data-status-visita-vendedor');

                        if (filter === 'todas') {
                            card.style.display = '';
                        } else if (filter === 'pendentes' && status === 'pendente') {
                            card.style.display = '';
                        } else if (filter === 'confirmadas' && status === 'confirmada') {
                            card.style.display = '';
                        } else if (filter === 'concluidas' && status === 'concluida') {
                            card.style.display = '';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });

            // O sistema de toggle de utilizador agora está no _Layout.cshtml e funciona globalmente
        });

        // ========== Dados Bancários - MB WAY Toggle ==========
        const metodoMbwayCheckbox = document.getElementById('metodo-mbway');
        const campoMbway = document.getElementById('campo-mbway');

        if (metodoMbwayCheckbox && campoMbway) {
            // Mostrar/esconder campo MB WAY
            metodoMbwayCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    campoMbway.style.display = 'block';
                    campoMbway.querySelector('input').required = true;
                } else {
                    campoMbway.style.display = 'none';
                    campoMbway.querySelector('input').required = false;
                }
            });

            // Verificar estado inicial
            if (metodoMbwayCheckbox.checked) {
                campoMbway.style.display = 'block';
                campoMbway.querySelector('input').required = true;
            }
        }

        // ========== Formulário de Dados Bancários ==========
        const formDadosBancarios = document.getElementById('formDadosBancarios');
        if (formDadosBancarios) {
            formDadosBancarios.addEventListener('submit', function(e) {
                e.preventDefault();

                // Validar se pelo menos um método de pagamento está selecionado
                const metodosCheckboxes = [
                    document.getElementById('metodo-transferencia'),
                    document.getElementById('metodo-mbway'),
                    document.getElementById('metodo-multibanco'),
                    document.getElementById('metodo-dinheiro')
                ];

                const algumSelecionado = metodosCheckboxes.some(cb => cb && cb.checked);

                if (!algumSelecionado) {
                    alert('Por favor, selecione pelo menos um método de pagamento.');
                    return;
                }

                // Simular sucesso
                alert('Dados bancários guardados com sucesso!');

                // Feedback visual
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Guardado!';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');

                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-primary');
                }, 2000);
            });
        }

        // ========== Hover Effect nos Payment Method Cards ==========
        const paymentCards = document.querySelectorAll('.payment-method-card');
        paymentCards.forEach(card => {
            const checkbox = card.querySelector('.form-check-input');

            if (checkbox) {
                // Aplicar classe checked inicial
                if (checkbox.checked) {
                    card.classList.add('border-primary', 'bg-light');
                }

                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        card.classList.add('border-primary', 'bg-light');
                    } else {
                        card.classList.remove('border-primary', 'bg-light');
                    }
                });
            }
        });
</script>
<script>
    // Dinamizar cabeçalho e "Dados Pessoais" sem depender do encoding do ficheiro
    (function () {
        // Carregar dados dinâmicos do perfil via JSON para evitar problemas de encoding no ficheiro
        fetch('/Utilizadores/PerfilDados', { cache: 'no-store' })
            .then(r => r.ok ? r.json() : null)
            .then(data => {
                if (!data) return;
                const nome = data.nome || '';
                const email = data.email || '';
                const phone = data.phone || '';
                const rua = (data.morada && data.morada.rua) || '';
                const localidade = (data.morada && data.morada.localidade) || '';
                const cp = (data.morada && data.morada.codigoPostal) || '';

                // Substituir o nome e avatar no header
                try {
                    const headerName = document.querySelector('.perfil-header h5');
                    if (headerName && nome) headerName.textContent = nome;
                    const avatarImg = document.querySelector('.perfil-avatar');
                    if (avatarImg && data.imagemPerfil) avatarImg.setAttribute('src', data.imagemPerfil);
                } catch {}

                // Atualizar cartões de Dados Pessoais
                try {
                    const labelValuePairs = document.querySelectorAll('.perfil-info-item');
                    labelValuePairs.forEach(it => {
                        const label = it.querySelector('.perfil-info-label');
                        const value = it.querySelector('.perfil-info-value');
                        if (!label || !value) return;
                        const text = (label.textContent || '').trim().toLowerCase();
                        if (text.includes('nome')) {
                            if (nome) value.textContent = nome;
                        } else if (text.includes('email')) {
                            if (email) value.textContent = email;
                        } else if (text.includes('telefone') || text.includes('telemóvel') || text.includes('telemovel')) {
                            if (phone) value.textContent = phone;
                        } else if (text.includes('rua')) {
                            if (rua) value.textContent = rua;
                        } else if (text.includes('código postal') || text.includes('codigo postal')) {
                            if (cp) value.textContent = cp;
                        } else if (text.includes('localidade')) {
                            if (localidade) value.textContent = localidade;
                        }
                    });
                } catch {}
            })
            .catch(() => { /* ignora erros */ });
    })();
</script>

<script src="~/js/favoritos.js"></script>
<script>
    // JavaScript adicional para manejar remoção de favoritos na página de perfil
    document.addEventListener('DOMContentLoaded', function () {
        // Confirmação antes de remover favorito (formulário)
        document.querySelectorAll('.remove-favorito-form-perfil').forEach(form => {
            form.addEventListener('submit', function (e) {
                if (!confirm('Tem certeza que deseja remover este anúncio dos favoritos?')) {
                    e.preventDefault();
                }
            });
        });

        // Adicionar evento customizado para atualizar UI quando favorito é removido via AJAX
        document.addEventListener('favoritoRemoved', function (e) {
            const anuncioId = e.detail.anuncioId;
            const card = document.querySelector(`[data-favorito-id] .btn-favorito[data-anuncio-id="${anuncioId}"]`)?.closest('[data-favorito-id]');

            if (card) {
                // Remove o card com animação
                card.style.transition = 'opacity 0.3s ease';
                card.style.opacity = '0';

                setTimeout(() => {
                    card.remove();

                    // Atualiza contadores
                    const remainingCards = document.querySelectorAll('#favoritos-container-perfil [data-favorito-id]').length;
                    document.getElementById('favoritos-badge-nav').textContent = remainingCards;
                    document.getElementById('favoritos-count-perfil').textContent = remainingCards;

                    // Se não houver mais favoritos, mostra empty state
                    if (remainingCards === 0) {
                        const container = document.getElementById('favoritos-container-perfil');
                        if (container) {
                            container.innerHTML = `
                                <div class="favoritos-empty text-center py-5">
                                    <div class="mb-4">
                                        <i class="bi bi-heart" style="font-size: 4rem; color: #e2e8f0;"></i>
                                    </div>
                                    <h4 class="text-muted mb-2">Ainda não tem favoritos</h4>
                                    <p class="text-muted mb-4">Guarde os anúncios que mais gosta para acesso rápido</p>
                                    <a href="/Anuncios" class="btn btn-primary">
                                        <i class="bi bi-search me-2"></i>Explorar Anúncios
                                    </a>
                                </div>
                            `;
                        }
                    }
                }, 300);
            }
        });

        // Sobrescrever função de toggle do favoritos.js para disparar evento customizado
        const originalToggle = window.FavoritosApp?.toggleFavorito;
        if (originalToggle && typeof originalToggle === 'function') {
            window.FavoritosApp.toggleFavorito = async function (anuncioId, button) {
                const result = await originalToggle.call(this, anuncioId, button);

                // Disparar evento customizado quando favorito é removido
                if (result && !result.adicionado) {
                    document.dispatchEvent(new CustomEvent('favoritoRemoved', {
                        detail: { anuncioId: anuncioId }
                    }));
                }

                return result;
            };
        }
    });
</script>
}
