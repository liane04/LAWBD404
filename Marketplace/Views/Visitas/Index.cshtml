@model IEnumerable<Marketplace.Models.Visita>

@{
    ViewData["Title"] = ViewBag.UserRole == "Vendedor" ? "Visitas aos Meus Anúncios" : "Minhas Visitas Agendadas";
    var isVendedor = ViewBag.UserRole == "Vendedor";
    var pendentes = Model.Count(v => v.Estado == "Pendente");
    var confirmadas = Model.Count(v => v.Estado == "Confirmada");
    var concluidas = Model.Count(v => v.Estado == "Concluída");
    var canceladas = Model.Count(v => v.Estado == "Cancelada");
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="bg-light border-bottom">
    <div class="container">
        <ol class="breadcrumb py-3 mb-0">
            <li class="breadcrumb-item"><a href="/"><i class="bi bi-house-door-fill me-1"></i>Início</a></li>
            <li class="breadcrumb-item active" aria-current="page">Minhas Visitas</li>
        </ol>
    </div>
</nav>

<div class="container my-5">
    <!-- Cabeçalho -->
    <div class="row align-items-center mb-4">
        <div class="col">
            <h1 class="h2 fw-bold text-primary mb-2">
                <i class="bi bi-calendar-check-fill me-2"></i>@ViewData["Title"]
            </h1>
            <p class="text-muted mb-0">
                @if (isVendedor)
                {
                    <text>Gerir as visitas agendadas aos seus veículos</text>
                }
                else
                {
                    <text>Consulte e gerir as suas visitas agendadas</text>
                }
            </p>
        </div>
        @if (!isVendedor)
        {
            <div class="col-auto">
                <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>Agendar Nova Visita
                </a>
            </div>
        }
    </div>

    <!-- Mensagens de Sucesso -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show border-success border-3 shadow-sm mb-4" role="alert">
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0">
                    <i class="bi bi-check-circle-fill fs-3 me-3"></i>
                </div>
                <div class="flex-grow-1">
                    <h5 class="alert-heading fw-bold mb-2">
                        <i class="bi bi-calendar-check me-2"></i>Confirmado!
                    </h5>
                    <p class="mb-2">@TempData["SuccessMessage"]</p>
                    @if (TempData["VisitaId"] != null)
                    {
                        <a asp-controller="Visitas" asp-action="Details" asp-route-id="@TempData["VisitaId"]" class="btn btn-sm btn-success mt-2">
                            <i class="bi bi-eye me-1"></i>Ver Detalhes da Visita
                        </a>
                    }
                    else
                    {
                        <div class="mt-2 small text-muted">
                            <i class="bi bi-info-circle me-1"></i>A visita foi agendada com sucesso. Consulte a lista abaixo para ver os detalhes.
                        </div>
                    }
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    }

    @if (!Model.Any())
    {
        <!-- Estado Vazio -->
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="card shadow-sm border-0 text-center py-5">
                    <div class="card-body">
                        <div class="mb-4">
                            <i class="bi bi-calendar-x text-muted" style="font-size: 5rem;"></i>
                        </div>
                        <h3 class="h4 fw-bold mb-3">Nenhuma Visita Agendada</h3>
                        @if (isVendedor)
                        {
                            <p class="text-muted mb-4">
                                Ainda não há visitas agendadas aos seus anúncios.
                                Quando alguém agendar uma visita, aparecerá aqui.
                            </p>
                        }
                        else
                        {
                            <p class="text-muted mb-4">
                                Ainda não agendou nenhuma visita. Comece por explorar os veículos disponíveis
                                e agende uma visita ao veículo que lhe interessar.
                            </p>
                            <a asp-controller="Anuncios" asp-action="Index" class="btn btn-primary btn-lg">
                                <i class="bi bi-search me-2"></i>Explorar Veículos
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Estatísticas Rápidas -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card shadow-sm border-warning border-start border-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted small mb-1">Pendentes</h6>
                                <h3 class="fw-bold mb-0 text-warning">@pendentes</h3>
                            </div>
                            <i class="bi bi-clock-history text-warning" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-success border-start border-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted small mb-1">Confirmadas</h6>
                                <h3 class="fw-bold mb-0 text-success">@confirmadas</h3>
                            </div>
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-primary border-start border-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted small mb-1">Concluídas</h6>
                                <h3 class="fw-bold mb-0 text-primary">@concluidas</h3>
                            </div>
                            <i class="bi bi-check-all text-primary" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm border-danger border-start border-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-muted small mb-1">Canceladas</h6>
                                <h3 class="fw-bold mb-0 text-danger">@canceladas</h3>
                            </div>
                            <i class="bi bi-x-circle-fill text-danger" style="font-size: 2.5rem; opacity: 0.3;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-primary active filter-btn" data-filter="todas">
                        <i class="bi bi-list-ul me-1"></i>Todas
                    </button>
                    <button type="button" class="btn btn-outline-warning filter-btn" data-filter="Pendente">
                        <i class="bi bi-clock-history me-1"></i>Pendentes (@pendentes)
                    </button>
                    <button type="button" class="btn btn-outline-success filter-btn" data-filter="Confirmada">
                        <i class="bi bi-check-circle me-1"></i>Confirmadas (@confirmadas)
                    </button>
                    <button type="button" class="btn btn-outline-primary filter-btn" data-filter="Concluída">
                        <i class="bi bi-check-all me-1"></i>Concluídas (@concluidas)
                    </button>
                    <button type="button" class="btn btn-outline-danger filter-btn" data-filter="Cancelada">
                        <i class="bi bi-x-circle me-1"></i>Canceladas (@canceladas)
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Visitas -->
        <div class="row g-4" id="visitas-container">
            @foreach (var item in Model.OrderByDescending(v => v.Data))
            {
                var primeiraImagem = item.Anuncio?.Imagens?.FirstOrDefault()?.ImagemCaminho ?? "/imagens/no-image.jpg";
                var visitaPassou = item.Data < DateTime.Now;

                <div class="col-12 visita-card" data-estado="@item.Estado">
                    <div class="card shadow-sm h-100 @GetCardClass(item.Estado)">
                        <div class="card-body">
                            <div class="row g-3 align-items-center">
                                <!-- Imagem do Veículo -->
                                <div class="col-lg-2 col-md-3">
                                    <img src="@primeiraImagem" alt="@item.Anuncio?.Titulo" class="rounded shadow-sm w-100"
                                         style="height: 120px; object-fit: cover;">
                                </div>

                                <!-- Informações da Visita -->
                                <div class="col-lg-6 col-md-5">
                                    <div class="d-flex align-items-start mb-2">
                                        <span class="badge @GetBadgeClass(item.Estado) me-2">@item.Estado</span>
                                        @if (visitaPassou && item.Estado == "Confirmada")
                                        {
                                            <span class="badge bg-info text-dark">
                                                <i class="bi bi-calendar-check me-1"></i>Realizada
                                            </span>
                                        }
                                    </div>

                                    <h5 class="mb-2">
                                        <a asp-controller="Anuncios" asp-action="Details" asp-route-id="@item.AnuncioId"
                                           class="text-decoration-none text-primary fw-bold">
                                            @item.Anuncio?.Titulo
                                        </a>
                                    </h5>

                                    <div class="mb-2">
                                        <p class="text-muted mb-1 small">
                                            <i class="bi bi-calendar3 text-primary me-1"></i>
                                            <strong>Data:</strong> @item.Data.ToString("dd/MM/yyyy")
                                            <i class="bi bi-clock text-primary ms-2 me-1"></i>
                                            <strong>Hora:</strong> @item.Data.ToString("HH:mm")
                                        </p>

                                        @if (isVendedor)
                                        {
                                            <p class="text-muted mb-1 small">
                                                <i class="bi bi-person-circle text-primary me-1"></i>
                                                <strong>Comprador:</strong> @item.Comprador?.Nome
                                            </p>
                                        }
                                        else
                                        {
                                            <p class="text-muted mb-1 small">
                                                <i class="bi bi-person-badge text-primary me-1"></i>
                                                <strong>Vendedor:</strong> @item.Vendedor?.Nome
                                            </p>
                                            @if (!string.IsNullOrEmpty(item.Anuncio?.Localizacao))
                                            {
                                                <p class="text-muted mb-1 small">
                                                    <i class="bi bi-geo-alt-fill text-primary me-1"></i>
                                                    @item.Anuncio.Localizacao
                                                </p>
                                            }
                                        }
                                    </div>

                                    @if (!string.IsNullOrEmpty(item.Observacoes))
                                    {
                                        <div class="alert alert-light border py-2 px-3 mb-0 small">
                                            <i class="bi bi-chat-left-text text-primary me-1"></i>
                                            <strong>Obs:</strong> @item.Observacoes
                                        </div>
                                    }
                                </div>

                                <!-- Preço e Ações -->
                                <div class="col-lg-4 col-md-4">
                                    <div class="text-center mb-3">
                                        <p class="text-success fw-bold fs-4 mb-0">
                                            <i class="bi bi-currency-euro"></i>@item.Anuncio?.Preco.ToString("N0")
                                        </p>
                                    </div>

                                    <div class="d-grid gap-2">
                                        <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-primary">
                                            <i class="bi bi-eye me-2"></i>Ver Detalhes
                                        </a>

                                        @if (isVendedor && item.Estado == "Pendente")
                                        {
                                            <form asp-action="Confirmar" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <button type="submit" class="btn btn-success w-100">
                                                    <i class="bi bi-check-circle-fill me-2"></i>Confirmar
                                                </button>
                                            </form>
                                        }

                                        @if (!isVendedor && (item.Estado == "Pendente" || item.Estado == "Confirmada") && !visitaPassou)
                                        {
                                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-warning">
                                                <i class="bi bi-pencil-square me-2"></i>Editar
                                            </a>
                                        }

                                        @if (isVendedor && item.Estado == "Confirmada" && visitaPassou)
                                        {
                                            <form asp-action="Concluir" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <button type="submit" class="btn btn-info w-100">
                                                    <i class="bi bi-check-all me-2"></i>Marcar Concluída
                                                </button>
                                            </form>
                                        }

                                        @if ((item.Estado == "Pendente" || item.Estado == "Confirmada") && !visitaPassou)
                                        {
                                            <button type="button" class="btn btn-outline-danger"
                                                    data-bs-toggle="modal" data-bs-target="#cancelModal@(item.Id)">
                                                <i class="bi bi-x-circle me-2"></i>Cancelar Visita
                                            </button>
                                        }
                                    </div>

                                    <div class="mt-3 text-center small text-muted">
                                        <i class="bi bi-calendar-plus me-1"></i>
                                        Criada em @item.DataCriacao.ToString("dd/MM/yyyy")
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal de Cancelamento -->
                <div class="modal fade" id="cancelModal@(item.Id)" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Cancelar Visita
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form asp-action="Cancelar" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@item.Id" />
                                <div class="modal-body">
                                    <div class="alert alert-warning border-warning mb-3">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        <strong>Atenção:</strong> Esta ação não pode ser desfeita. O outro utilizador será notificado do cancelamento.
                                    </div>
                                    <p class="mb-3">Tem certeza que deseja cancelar a visita ao veículo <strong>@item.Anuncio?.Titulo</strong>?</p>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Motivo do Cancelamento (Opcional)</label>
                                        <textarea class="form-control" name="motivo" rows="3"
                                                  placeholder="Explique o motivo do cancelamento..."></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="bi bi-arrow-left me-2"></i>Voltar
                                    </button>
                                    <button type="submit" class="btn btn-danger">
                                        <i class="bi bi-x-circle-fill me-2"></i>Confirmar Cancelamento
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@functions {
    string GetBadgeClass(string estado)
    {
        return estado switch
        {
            "Pendente" => "bg-warning text-dark",
            "Confirmada" => "bg-success",
            "Concluída" => "bg-primary",
            "Cancelada" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetCardClass(string estado)
    {
        return estado switch
        {
            "Pendente" => "border-start border-warning border-4",
            "Confirmada" => "border-start border-success border-4",
            "Concluída" => "border-start border-primary border-4",
            "Cancelada" => "border-start border-danger border-4",
            _ => "border-start border-secondary border-4"
        };
    }
}

@section Scripts {
    <script>
        // Filtrar visitas por estado
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filter = this.dataset.filter;

                // Atualizar botões ativos
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Filtrar cards
                document.querySelectorAll('.visita-card').forEach(card => {
                    if (filter === 'todas' || card.dataset.estado === filter) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        // Auto-dismiss alerts após 5 segundos
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
}
